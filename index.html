<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Achievements Explorer</title>
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@300;400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bibliotecas Externas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #00f3ff; 
            --secondary-color: #bc13fe;
            --bg-dark: #050b14;
            --bg-panel: rgba(16, 26, 46, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #e0e6ed;
            --text-dim: #94a3b8;
            --success: #00ff9d;
            --warning: #ffbd2e;
            --danger: #ff0055;
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
            --card-radius: 12px;
        }

        /* TEMAS */
        body.theme-matrix { --primary-color: #00ff41; --secondary-color: #008f11; --bg-dark: #000000; --bg-panel: rgba(0, 20, 0, 0.95); --success: #00ff41; }
        body.theme-fire { --primary-color: #ffbd2e; --secondary-color: #ff0055; --bg-dark: #1a0505; --bg-panel: rgba(40, 10, 10, 0.95); }
        body.theme-retro {
            --primary-color: #fca311; --secondary-color: #14213d; --bg-dark: #101010; --bg-panel: #1a1a1a;
            --glass-border: #404040; --text-main: #e5e5e5; --text-dim: #a0a0a0; --success: #2a9d8f;
            --font-display: 'Press Start 2P', cursive; --font-body: 'Rajdhani', sans-serif; --card-radius: 0px;
        }
        
        body.theme-retro .site-title { text-shadow: 2px 2px 0px #000; letter-spacing: -1px; font-size: 18px; }
        body.theme-retro .game-card, body.theme-retro .profile-hero, body.theme-retro .library-controls, body.theme-retro .search-input, body.theme-retro .achievements-modal, body.theme-retro .icon-btn, body.theme-retro .filter-select, body.theme-retro .filter-btn, body.theme-retro .signature-modal, body.theme-retro .versus-modal, body.theme-retro .chart-modal, body.theme-retro .ranking-col, body.theme-retro .nav-btn { border: 1px solid var(--glass-border); box-shadow: none; }
        body.theme-retro .game-card:hover { border-color: var(--primary-color); transform: translateY(-2px); box-shadow: 4px 4px 0px #000; }
        body.theme-retro .profile-avatar { border-radius: 0px; border: 2px solid var(--primary-color); box-shadow: 4px 4px 0px rgba(0,0,0,0.5); }
        body.theme-retro .game-title, body.theme-retro .modal-game-title { font-family: 'Press Start 2P', cursive; font-size: 10px; line-height: 1.6; }
        body.theme-retro .progress-bar-bg { border-radius: 0; background: #333; }
        body.theme-retro .progress-bar-fill { border-radius: 0; }
        body.theme-retro .friend-avatar, body.theme-retro .rank-avatar { border-radius: 0px; border: 1px solid var(--text-dim); }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: var(--font-body); min-height: 100vh; overflow-x: hidden; transition: background 0.5s ease, color 0.5s ease; }
        .container { width: 100%; max-width: 1280px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        .hidden { display: none !important; }

        /* HEADER */
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 30px; border-bottom: 1px solid var(--glass-border); position: relative; z-index: 10; flex-wrap: wrap; gap: 20px; }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .logo-icon { font-size: 32px; color: var(--primary-color); text-shadow: 0 0 10px var(--primary-color); }
        .site-title { font-family: var(--font-display); font-size: 24px; background: linear-gradient(90deg, var(--text-main), var(--primary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .main-nav { display: flex; gap: 10px; }
        .nav-btn { 
            background: transparent; border: 1px solid transparent; color: var(--text-dim); 
            padding: 8px 16px; border-radius: 20px; cursor: pointer; 
            font-family: var(--font-display); text-decoration: none; font-size: 12px; transition: 0.3s; 
            display: flex; align-items: center; justify-content: center;
        }
        .nav-btn:hover, .nav-btn.active { 
            background: rgba(255,255,255,0.1); color: var(--primary-color); border-color: var(--glass-border); box-shadow: 0 0 10px rgba(0,0,0,0.2); 
        }
        
        .header-controls { display: flex; gap: 15px; align-items: center; }
        
        .theme-select { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main); padding: 8px 15px; border-radius: 20px; font-family: var(--font-body); font-weight: bold; cursor: pointer; outline: none; }
        body.theme-retro .theme-select { border-radius: 0px; border: 2px solid var(--glass-border); }
        .theme-select option { background: var(--bg-dark); color: var(--text-main); }
        
        .icon-btn { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background: var(--primary-color); color: #000; }
        body.theme-retro .icon-btn { border-radius: 0px; border: 2px solid var(--glass-border); }

        /* SEARCH */
        .search-section { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; transition: all 0.5s ease; }
        .search-section.active { min-height: auto; flex-direction: row; justify-content: flex-end; margin-bottom: 20px; }
        .search-box { position: relative; width: 100%; max-width: 600px; }
        .search-input { width: 100%; padding: 18px 25px; padding-right: 60px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 50px; color: var(--text-main); font-family: var(--font-display); font-size: 16px; backdrop-filter: blur(10px); transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 15px rgba(0,243,255,0.2); }
        body.theme-retro .search-input { border-radius: 0px; border-width: 2px; font-family: var(--font-body); font-size: 12px; }
        .search-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: var(--primary-color); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: #000; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .search-btn:hover { transform: translateY(-50%) scale(1.1); }
        body.theme-retro .search-btn { border-radius: 0px; }

        /* PROFILE */
        .profile-hero { display: flex; align-items: center; gap: 30px; padding: 40px; background: var(--bg-panel); backdrop-filter: blur(10px); border-radius: var(--card-radius); border: 1px solid var(--glass-border); margin-bottom: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideDown 0.6s ease-out; position: relative; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary-color); object-fit: cover; box-shadow: 0 0 20px var(--primary-color); }
        .profile-info { flex: 1; }
        .profile-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .profile-info h1 { font-family: var(--font-display); font-size: 32px; margin: 0; display:flex; align-items:center; gap:15px; }
        
        .hunter-title { 
            font-size: 14px; padding: 5px 12px; border-radius: 20px; 
            background: rgba(0,0,0,0.5); border: 1px solid var(--primary-color); 
            color: var(--primary-color); font-family: var(--font-body); text-transform: uppercase; letter-spacing: 1px;
        }
        .hunter-title.legendary {
            background: linear-gradient(90deg, #ffd700, #ff8c00); color: #000; border: none;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); font-weight: bold;
            animation: glow 2s infinite alternate;
        }
        @keyframes glow { from { box-shadow: 0 0 5px #ffd700; } to { box-shadow: 0 0 20px #ffd700; } }
        
        .action-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border); color: var(--text-dim); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-family: var(--font-body); display: flex; align-items: center; gap: 8px; transition: 0.3s; font-size: 12px; text-transform: uppercase; font-weight: 700; }
        .action-btn:hover { background: var(--primary-color); color: #000; }
        body.theme-retro .action-btn { border-radius: 0px; border-width: 2px; }

        .profile-stats { display: flex; gap: 30px; margin-top: 15px; flex-wrap: wrap; }
        .stat-item { text-align: center; min-width: 100px; }
        .stat-value { display: block; font-size: 24px; font-weight: 700; color: var(--primary-color); }
        .stat-value.gold { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .stat-value.purple { color: #bc13fe; }
        .stat-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
        body.theme-retro .stat-value { font-family: 'Press Start 2P', cursive; font-size: 14px; margin-bottom: 10px; }

        /* ULTRA RARE SHOWCASE */
        .showcase-section { margin-bottom: 40px; display:none; }
        .showcase-grid { display: flex; gap: 15px; flex-wrap: wrap; }
        .showcase-card { 
            flex: 1; min-width: 250px; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(0,0,0,0.2));
            border: 1px solid var(--warning); border-radius: 12px; padding: 15px;
            display: flex; align-items: center; gap: 15px; position: relative; overflow: hidden;
        }
        .showcase-card::before {
            content: ''; position: absolute; top:0; left:0; width:4px; height:100%; background: var(--warning);
            box-shadow: 0 0 10px var(--warning);
        }
        .showcase-icon { width: 50px; height: 50px; border-radius: 8px; }
        .showcase-info h4 { margin: 0; font-size: 14px; color: var(--warning); }
        .showcase-info p { margin: 2px 0 0; font-size: 11px; color: var(--text-dim); }
        .showcase-pct { position: absolute; right: 15px; top: 15px; font-size: 12px; font-weight: bold; color: var(--warning); }

        /* LIBRARY */
        .library-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .section-title { font-family: var(--font-display); font-size: 24px; margin: 0; border-left: 4px solid var(--secondary-color); padding-left: 15px; }
        body.theme-retro .section-title { font-size: 16px; border-left-width: 8px; }
        .library-controls { display: flex; gap: 15px; align-items: center; background: var(--bg-panel); padding: 10px; border-radius: var(--card-radius); border: 1px solid var(--glass-border); flex: 1; max-width: 800px; }
        .game-search-input { flex: 1; background: transparent; border: none; color: var(--text-main); font-family: var(--font-body); padding: 5px 10px; font-size: 16px; outline: none; }
        .filter-select { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main); padding: 5px 10px; border-radius: 8px; font-family: var(--font-body); cursor: pointer; }
        body.theme-retro .filter-select { border-radius: 0px; border-width: 2px; }
        .filter-select option { background: var(--bg-dark); color: var(--text-main); }
        .filter-btn { background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 700; transition: 0.2s; }
        .filter-btn.active, .filter-btn:hover { background: var(--primary-color); color: #000; border-color: var(--primary-color); }
        body.theme-retro .filter-btn { border-radius: 0px; border-width: 2px; }

        /* GAMES GRID */
        .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-bottom: 50px; }
        .game-card { background: var(--bg-panel); border-radius: var(--card-radius); overflow: hidden; border: 1px solid var(--glass-border); transition: all 0.3s ease; position: relative; cursor: pointer; display: flex; flex-direction: column; }
        .game-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 243, 255, 0.15); border-color: var(--primary-color); }
        body.theme-retro .game-card:hover { transform: translate(-2px, -2px); box-shadow: 8px 8px 0px var(--primary-color); }
        .game-card.hidden-card { display: none; }
        
        .game-banner { width: 100%; height: 130px; object-fit: cover; border-bottom: 1px solid var(--glass-border); }
        .game-details { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .game-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        body.theme-retro .game-title { font-family: 'Press Start 2P', cursive; font-size: 10px; line-height: 1.5; }
        .game-meta { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-dim); margin-bottom: 10px; }
        .game-progress-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        body.theme-retro .game-progress-bar-bg { border-radius: 0; height: 8px; border: 1px solid #fff; }
        .game-progress-bar-fill { height: 100%; background: var(--secondary-color); width: 0%; transition: width 1s ease; }
        .game-stats-row { display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; font-weight: 700; }

        .platinum-badge, .platinando-badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: none; }
        .platinum-badge { background: linear-gradient(135deg, #ffd700, #ffa500); color: #000; }
        .platinando-badge { background: linear-gradient(135deg, #ffbd2e, #ff9f1c); color: #000; }
        .game-card.platinum .platinum-badge { display: block; }
        .game-card.platinum { border-color: rgba(255, 215, 0, 0.3); }
        .game-card.platinando .platinando-badge { display: block; }
        .game-card.platinando { border: 1px solid rgba(255, 189, 46, 0.5); }

        /* FRIENDS & RANKING */
        .friends-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .friend-search-input { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: var(--text-main); padding: 8px 15px; border-radius: 20px; font-family: var(--font-body); font-size: 14px; width: 200px; }
        .friend-search-input:focus { outline: none; border-color: var(--primary-color); }
        body.theme-retro .friend-search-input { border-radius: 0px; border-width: 2px; }

        .friends-container { display: flex; overflow-x: auto; gap: 15px; padding: 10px 5px 20px 5px; margin-bottom: 20px; scroll-behavior: smooth; }
        .friend-card { min-width: 80px; max-width: 80px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s; background: transparent; border: none; }
        .friend-card:hover .friend-avatar { transform: scale(1.1); border-color: var(--success); box-shadow: 0 0 15px var(--success); }
        .friend-card.hidden { display: none; }
        .friend-avatar { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--primary-color); object-fit: cover; transition: 0.3s; }
        body.theme-retro .friend-avatar { border-radius: 0px; border-width: 3px; }
        .friend-name { font-size: 12px; font-weight: 600; text-align: center; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

        /* RANKING GRID */
        .ranking-section { margin-top: 30px; margin-bottom: 50px; }
        .ranking-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .ranking-col { background: var(--bg-panel); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; height: 400px; }
        body.theme-retro .ranking-col { border-radius: 0px; border-width: 2px; }
        .ranking-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); margin-bottom: 10px; }
        .ranking-title { font-family: var(--font-display); font-size: 16px; color: var(--primary-color); }
        .ranking-loader { display:inline-block; font-size:10px; color:var(--text-dim); margin-left:10px; }
        .scrollable-table { flex: 1; overflow-y: auto; padding-right: 5px; }
        .rank-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rank-table th { text-align: left; padding: 8px; color: var(--text-dim); font-size: 11px; position: sticky; top: 0; background: var(--bg-panel); z-index:2; }
        .rank-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-row:hover { background: rgba(255,255,255,0.05); }
        .rank-pos { font-weight: bold; color: var(--secondary-color); width: 30px; }
        .rank-val { font-weight: bold; color: #fff; text-align: right; }
        .rank-user { display: flex; align-items: center; gap: 8px; }
        .rank-avatar { width: 24px; height: 24px; border-radius: 50%; }
        body.theme-retro .rank-avatar { border-radius: 0; }

        /* Background & Loader */
        #dynamic-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-size: cover; background-position: center; opacity: 0; filter: blur(20px) brightness(0.4); transition: opacity 1s ease, background-image 1s ease; }
        #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .loader { width: 48px; height: 48px; border: 3px solid var(--text-main); border-radius: 50%; display: inline-block; position: relative; box-sizing: border-box; animation: rotation 1s linear infinite; }
        .loader::after { content: ''; box-sizing: border-box; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; border-bottom-color: var(--primary-color); }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        #scan-progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 3px; z-index: 1000; background: transparent; }
        #scan-progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.2s; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        
        /* VERSUS */
        .versus-modal { width: 90%; max-width: 800px; background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--primary-color); padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .versus-header { text-align: center; font-family: var(--font-display); font-size: 24px; margin-bottom: 20px; color: var(--primary-color); }
        .versus-inputs { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .versus-content { display: flex; justify-content: space-between; align-items: flex-start; min-height: 200px; gap:20px; }
        .vs-player { flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; }
        .vs-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--text-dim); object-fit: cover; }
        .vs-stat-row { display: flex; flex-direction: column; width: 100%; margin: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .vs-stat-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; }
        .vs-stat-val { font-size: 18px; font-weight: bold; font-family: 'Rajdhani'; }
        .vs-stat-val.win { color: var(--success); }
        .tug-of-war { width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden; display: flex; margin-top: 20px; position: relative; }
        .tug-bar-p1 { height: 100%; background: #007bff; transition: width 1s ease; }
        .tug-bar-p2 { height: 100%; background: #dc3545; flex: 1; }
        .tug-icon { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 20px; color: #fff; }

        /* CHARTS */
        .chart-modal { width: 90%; max-width: 800px; background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--primary-color); padding: 30px; display: flex; flex-direction: column; gap: 20px; max-height: 90vh; overflow-y: auto; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-container { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; }

        /* SIGNATURE */
        .signature-modal { width: 90%; max-width: 650px; background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--primary-color); padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .sig-controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .sig-preview-container { width: 100%; overflow: hidden; border: 2px solid var(--glass-border); border-radius: 10px; display: flex; justify-content: center; align-items: center; background: #000; }
        #signature-card-element { width: 600px; height: 350px; background: #111; color: #fff; display: flex; flex-direction: column; overflow: hidden; position: relative; flex-shrink: 0; }
        .sig-bg { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(4px) brightness(0.3); }
        .sig-top { position: relative; z-index: 2; display: flex; align-items: center; gap: 25px; padding: 25px; width: 100%; flex: 1; }
        .sig-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary-color); box-shadow: 0 0 25px rgba(0,0,0,0.8); object-fit: cover; }
        .sig-info { flex: 1; }
        .sig-info h2 { margin: 0 0 10px 0; font-family: 'Orbitron'; font-size: 26px; text-shadow: 3px 3px 0 #000; letter-spacing: 1px; color: #fff; }
        .sig-stats { display: flex; gap: 15px; }
        .sig-stat { font-family: 'Rajdhani'; font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 6px; text-shadow: 1px 1px 0 #000; }
        .sig-game-section { position: relative; z-index: 2; background: rgba(0,0,0,0.7); padding: 15px 25px; display: flex; flex-direction: column; gap: 5px; border-top: 2px solid var(--primary-color); }
        .sig-game-name { font-family: 'Orbitron'; font-size: 18px; color: var(--success); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sig-game-row { display: flex; justify-content: space-between; align-items: center; font-family: 'Rajdhani'; font-size: 14px; font-weight: bold; }
        .sig-progress-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .sig-progress-fill { height: 100%; background: var(--success); border-radius: 3px; }
        .sig-watermark { position: absolute; top: 10px; right: 15px; font-size: 10px; color: rgba(255,255,255,0.3); font-family: sans-serif; z-index: 2; }

        /* ACHIEVEMENTS MODAL */
        .achievements-modal { width: 90%; max-width: 900px; height: 85vh; background: var(--bg-dark); border-radius: 20px; border: 1px solid var(--secondary-color); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px 30px; background: linear-gradient(90deg, rgba(188, 19, 254, 0.1), transparent); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-game-title { font-family: var(--font-display); font-size: 20px; color: var(--secondary-color); }
        .modal-tabs { display: flex; gap: 15px; margin-top: 15px; }
        .modal-tab-btn { background: transparent; border: none; color: var(--text-dim); font-family: var(--font-body); font-weight: 700; cursor: pointer; padding-bottom: 5px; border-bottom: 2px solid transparent; }
        .modal-tab-btn.active { color: var(--text-main); border-color: var(--primary-color); }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px 30px; }
        .achievement-item { display: flex; align-items: center; gap: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; transition: 0.2s; }
        .achievement-item.unlocked { border-left: 4px solid var(--success); background: linear-gradient(90deg, rgba(0,255,157,0.05), transparent); }
        .achievement-item.locked { border-left: 4px solid var(--text-dim); opacity: 0.7; }
        .ach-icon { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; background: #000; }
        .ach-info { flex: 1; }
        .ach-name { font-weight: 700; font-size: 16px; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .ach-desc { font-size: 13px; color: var(--text-dim); margin-top: 4px; }
        .rarity-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #333; color: #fff; }
        .rarity-common { background: #555; }
        .rarity-rare { background: var(--primary-color); color: #000; }
        .rarity-ultra { background: var(--warning); color: #000; box-shadow: 0 0 5px var(--warning); }
        .close-modal-btn { background: none; border: none; color: var(--text-dim); font-size: 24px; cursor: pointer; transition: 0.2s; }
        .close-modal-btn:hover { color: var(--text-main); transform: rotate(90deg); }
    </style>
</head>
<body>
    
    <div id="dynamic-bg"></div>
    <div id="scan-progress-container"><div id="scan-progress-bar"></div></div>

    <div class="container">
        <header class="main-header">
            <div class="logo-area">
                <i class="fab fa-steam logo-icon"></i>
                <h1 class="site-title">STEAM EXPLORER</h1>
            </div>
            <div class="header-controls">
                <nav class="main-nav">
                    <a href="index.html" class="nav-btn active">BIBLIOTECA</a>
                    <a href="hall.html" class="nav-btn">HALL</a>
                    <a href="roleta.html" class="nav-btn">ROLETA</a>
                </nav>
                <div style="width: 20px;"></div>
                <button class="icon-btn" onclick="openVersusModal()" title="Modo Versus"><i class="fas fa-fist-raised"></i></button>
                <select id="themeSelector" onchange="changeTheme(this.value)" class="theme-select">
                    <option value="default">Padrão</option>
                    <option value="rgb">RGB</option>
                    <option value="retro">Retrô</option>
                    <option value="light">Claro</option>
                    <option value="dark">Escuro</option>
                </select>
                <button class="icon-btn" onclick="openSignatureModal()" title="Gerar Card"><i class="fas fa-camera"></i></button>
            </div>
        </header>

        <section class="search-section" id="searchSection">
            <div class="search-box">
                <input type="text" class="search-input" id="steamInput" placeholder="Steam ID, URL ou Custom URL...">
                <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
            </div>
        </section>

        <div id="loader" class="hidden"><span class="loader"></span></div>

        <main id="profileContent" class="hidden">
            <section class="profile-hero">
                <div class="profile-avatar-wrapper">
                    <img src="" alt="Avatar" id="userAvatar" class="profile-avatar">
                </div>
                <div class="profile-info">
                    <div class="profile-header-row">
                        <h1><span id="userNameText">Usuário</span> <span id="hunterTitle" class="hunter-title"></span></h1>
                        <button class="action-btn" onclick="refreshData()"><i class="fas fa-sync-alt"></i> Atualizar</button>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item"><span class="stat-value blue" id="totalGames">0</span><span class="stat-label">Jogos Totais</span></div>
                        <div class="stat-item"><span class="stat-value gold" id="totalPlatinum">0</span><span class="stat-label">Platinas</span></div>
                        <div class="stat-item"><span class="stat-value purple" id="totalAchievements">0</span><span class="stat-label">Conquistas</span></div>
                        <div class="stat-item"><span class="stat-value" id="completionRate">0%</span><span class="stat-label">Média Global</span></div>
                    </div>
                </div>
            </section>
            
            <!-- SHOWCASE SECTION -->
            <section class="showcase-section" id="showcaseSection">
                <h2 class="section-title" style="color:var(--warning); border-color:var(--warning)">Destaques Ultra Raros</h2>
                <div class="showcase-grid" id="showcaseGrid"></div>
            </section>

            <section>
                <div class="library-header">
                    <h2 class="section-title">Biblioteca</h2>
                    <div class="library-controls">
                        <input type="text" id="gameSearchInput" class="game-search-input" placeholder="Filtrar jogo..." oninput="filterGames()">
                        <select id="sortSelect" class="filter-select" onchange="sortGames()">
                            <option value="playtime">Tempo de Jogo</option>
                            <option value="completion">% Completo</option>
                            <option value="name">Nome (A-Z)</option>
                        </select>
                        <div class="filter-group" style="display:flex; gap:5px;">
                            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">TODOS</button>
                            <button class="filter-btn" data-filter="platinado" onclick="setFilter('platinado')">PLATINADOS</button>
                            <button class="filter-btn" data-filter="platinando" onclick="setFilter('platinando')">PLATINANDO</button>
                        </div>
                    </div>
                </div>
                <div class="games-grid" id="gamesGrid"></div>
            </section>

            <section>
                <div class="friends-header">
                    <h2 class="section-title" style="margin-bottom:0;">Amigos</h2>
                    <input type="text" id="friendSearchInput" class="friend-search-input" placeholder="Buscar amigo..." oninput="filterFriends()">
                </div>
                <div class="friends-container" id="friendsContainer"></div>
                
                <!-- RANKING TABLES -->
                <div class="ranking-section">
                    <h3 style="margin-bottom:20px; font-family:var(--font-display);">Ranking de Amigos</h3>
                    <div class="ranking-grid">
                        <div class="ranking-col">
                            <div class="ranking-header"><span class="ranking-title"><i class="fas fa-gamepad"></i> Maior Biblioteca <span id="rankGamesLoader" class="ranking-loader"><i class="fas fa-spinner fa-spin"></i></span></span></div>
                            <div class="scrollable-table"><table class="rank-table"><thead><tr><th>#</th><th>Amigo</th><th>Jogos</th></tr></thead><tbody id="rankGamesBody"></tbody></table></div>
                        </div>
                        <div class="ranking-col">
                            <div class="ranking-header"><span class="ranking-title"><i class="fas fa-clock"></i> Mais Viciado <span id="rankTimeLoader" class="ranking-loader"><i class="fas fa-spinner fa-spin"></i></span></span></div>
                            <div class="scrollable-table"><table class="rank-table"><thead><tr><th>#</th><th>Amigo</th><th>Horas</th></tr></thead><tbody id="rankTimeBody"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="achievementModal">
        <div class="achievements-modal">
            <div class="modal-header">
                <div>
                    <h2 class="modal-game-title" id="modalGameTitle">Carregando...</h2>
                    <div class="modal-tabs">
                        <button class="modal-tab-btn active" onclick="filterModal('all')">TODAS</button>
                        <button class="modal-tab-btn" onclick="filterModal('unlocked')">DESBLOQUEADAS</button>
                        <button class="modal-tab-btn" onclick="filterModal('locked')">BLOQUEADAS</button>
                    </div>
                </div>
                <button class="close-modal-btn" id="closeModalBtn"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="modalLoader" class="modal-loader"><span class="loader"></span><p>Analisando dados...</p><button class="action-btn" onclick="retryModalLoad()" style="margin-top:15px;">Tentar Novamente</button></div>
                <div class="achievements-list hidden" id="achievementsList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="versusModal">
        <div class="versus-modal">
            <div class="versus-header">BATTLE ARENA</div>
            <div class="versus-inputs">
                <input type="text" id="vsInput1" class="search-input" placeholder="ID Player 1 (Você)">
                <span style="align-self:center; font-weight:bold; color:var(--danger)">VS</span>
                <input type="text" id="vsInput2" class="search-input" placeholder="ID Player 2 (Oponente)">
            </div>
            <div style="text-align:center; margin-bottom:20px;"><button class="search-btn" onclick="runVersus()" style="position:static; transform:none; width:100%; border-radius:10px;">INICIAR BATALHA</button></div>
            <div class="versus-content" id="versusContent"></div>
            <div id="tugContainer" style="display:none; margin-top:20px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#ccc; margin-bottom:5px;"><span>Player 1 Total</span><span>Player 2 Total</span></div>
                <div class="tug-of-war"><div class="tug-bar-p1" id="tugBarP1" style="width:50%"></div><div class="tug-bar-p2"></div><div class="tug-icon" style="left:50%"><i class="fas fa-caret-up"></i></div></div>
            </div>
            <button class="action-btn" style="align-self:center; margin-top:20px;" onclick="document.getElementById('versusModal').classList.remove('open')">Fechar</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="chartsModal">
        <div class="chart-modal">
            <div class="modal-header" style="border:none; padding:0 0 20px 0;">
                <h2 class="modal-game-title">Análise de Dados</h2>
                <button class="close-modal-btn" onclick="document.getElementById('chartsModal').classList.remove('open')"><i class="fas fa-times"></i></button>
            </div>
            <div class="charts-grid">
                <div class="chart-container"><h4 style="text-align:center; margin-bottom:10px;">Status da Biblioteca</h4><canvas id="gamesPieChart"></canvas></div>
                <div class="chart-container"><h4 style="text-align:center; margin-bottom:10px;">Top Jogos por Tempo</h4><canvas id="playtimeBarChart"></canvas></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="signatureModal">
        <div class="signature-modal">
            <div class="modal-header" style="padding:10px 0; border:none;">
                <h2 class="modal-game-title">Criar Card</h2>
                <button class="close-modal-btn" onclick="document.getElementById('signatureModal').classList.remove('open')"><i class="fas fa-times"></i></button>
            </div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <label style="font-family:var(--font-body); font-size:14px;">Escolha o Jogo de Fundo:</label>
                <select id="sigGameSelect" class="filter-select" onchange="updateSignaturePreview(this.value)"></select>
            </div>
            <div class="sig-preview-container">
                <div id="signature-card-element">
                    <div class="sig-bg" id="sigBg"></div>
                    <div class="sig-top">
                        <div class="sig-content">
                            <img id="sigAvatar" class="sig-avatar" src="">
                            <div class="sig-info">
                                <h2 id="sigName">USER</h2>
                                <div class="sig-stats">
                                    <div class="sig-stat" style="color:#00f3ff"><i class="fas fa-gamepad"></i> <span id="sigGames">0</span></div>
                                    <div class="sig-stat" style="color:#ffd700"><i class="fas fa-trophy"></i> <span id="sigPlat">0</span></div>
                                    <div class="sig-stat" style="color:#bc13fe"><i class="fas fa-medal"></i> <span id="sigAch">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="sig-game-section" id="sigGameSection">
                        <div class="sig-game-name" id="sigGameName">Nome do Jogo</div>
                        <div class="sig-game-row"><span id="sigGameProg">0/0</span><span id="sigGamePct">0%</span></div>
                        <div class="sig-progress-bg"><div class="sig-progress-fill" id="sigGameBar" style="width:0%"></div></div>
                    </div>
                    <div class="sig-watermark">Steam Explorer</div>
                </div>
            </div>
            <div class="sig-controls"><button class="action-btn" onclick="downloadSignature()"><i class="fas fa-download"></i> Baixar Imagem</button></div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // ATENÇÃO: Para uso em produção (faculdade/portfolio), o ideal é usar "http://localhost/SAE/api.php"
        // mas para garantir que funcione AGORA nesta pré-visualização sem servidor, voltamos ao modo direto.
        const STEAM_API_KEY = '8B07FE7C9405216BF61C1F439E93922B'; 
        const PROXY_LIST = ['https://api.allorigins.win/raw?url=', 'https://corsproxy.io/?', 'https://thingproxy.freeboard.io/fetch/', 'https://api.codetabs.com/v1/proxy?quest='];
        
        let currentState = {
            userId: null, user: null, games: [], friends: [], friendsData: [],
            activeFilter: 'all', modalFilter: 'all',
            stats: { totalPlatinum: 0, totalAchievementsUnlocked: 0, sumPercentages: 0, gamesCounted: 0, totalPlayableGames: 0 },
            currentModalGame: null 
        };
        let fetchQueue = []; let activeRequests = 0; const MAX_CONCURRENT_REQUESTS = 8;
        let friendFetchQueue = []; let activeFriendRequests = 0;

        window.onload = () => { loadFromHistory(); setupEventListeners(); };

        function setupEventListeners() {
            document.getElementById('searchBtn').addEventListener('click', () => handleSearch());
            document.getElementById('steamInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSearch(); });
            document.getElementById('closeModalBtn').addEventListener('click', closeGameModal);
            document.getElementById('achievementModal').addEventListener('click', (e) => { if(e.target === document.getElementById('achievementModal')) closeGameModal(); });
        }

        // --- API CORE ---
        async function fetchFromSteam(endpoint, params = {}, retries = 2) {
            let url = `https://api.steampowered.com/${endpoint}/?key=${STEAM_API_KEY}`;
            for (const [key, value] of Object.entries(params)) url += `&${key}=${value}`;
            url += `&_=${new Date().getTime()}`; 
            for (const proxyBase of PROXY_LIST) {
                try {
                    const response = await fetch(proxyBase + encodeURIComponent(url));
                    if (!response.ok) throw new Error(`Status ${response.status}`);
                    return await response.json();
                } catch (e) {}
            }
            if (retries > 0) { await new Promise(r => setTimeout(r, 1500)); return fetchFromSteam(endpoint, params, retries - 1); }
            throw new Error("Falha na conexão com a Steam API.");
        }

        // --- MAIN SEARCH ---
        async function handleSearch(isRefresh = false) {
            let input = isRefresh && currentState.userId ? currentState.userId : document.getElementById('steamInput').value.trim();
            if (!input) return alert("Digite um ID.");
            if(!isRefresh) { document.getElementById('profileContent').classList.add('hidden'); document.getElementById('searchSection').classList.add('active'); document.getElementById('loader').classList.remove('hidden'); } else { document.getElementById('profileContent').style.opacity = '0.5'; }
            
            try {
                resetGlobalStats();
                let steamId = input;
                if (isNaN(input)) {
                    let vanity = input.includes('/id/') ? input.split('/id/')[1].split('/')[0] : input;
                    const res = await fetchFromSteam('ISteamUser/ResolveVanityURL/v0001', { vanityurl: vanity });
                    if (res.response && res.response.success === 1) steamId = res.response.steamid;
                    else throw new Error("Usuário não encontrado.");
                }
                currentState.userId = steamId; saveToHistory(steamId);
                const profileRes = await fetchFromSteam('ISteamUser/GetPlayerSummaries/v0002', { steamids: steamId });
                currentState.user = profileRes.response.players[0];
                const gamesRes = await fetchFromSteam('IPlayerService/GetOwnedGames/v0001', { steamid: steamId, include_appinfo: true, format: 'json' });
                if (!gamesRes.response || !gamesRes.response.games) throw new Error("Perfil privado.");
                currentState.games = gamesRes.response.games.map(g => ({ ...g, header_image: `https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/${g.appid}/header.jpg`, playtime_hours: (g.playtime_forever / 60).toFixed(1), percent: -1, unlocked: 0, total: 0 }));
                currentState.games.sort((a,b) => b.playtime_forever - a.playtime_forever);
                if(currentState.games.length > 0) setDynamicBackground(currentState.games[0].appid);
                
                // Reset Friends
                currentState.friends = []; currentState.friendsData = [];
                document.getElementById('rankGamesBody').innerHTML = ''; document.getElementById('rankTimeBody').innerHTML = '';
                friendFetchQueue = []; activeFriendRequests = 0;

                fetchFriends(steamId); 
                renderProfile(); renderGamesGrid();
                document.getElementById('loader').classList.add('hidden'); document.getElementById('profileContent').classList.remove('hidden'); document.getElementById('profileContent').style.opacity = '1';
            } catch (error) { console.error(error); alert(error.message); document.getElementById('loader').classList.add('hidden'); document.getElementById('profileContent').style.opacity = '1'; }
        }

        async function fetchFriends(steamId) {
            try {
                const res = await fetchFromSteam('ISteamUser/GetFriendList/v0001', { steamid: steamId, relationship: 'friend' });
                if(res.friendslist && res.friendslist.friends) {
                    const allIds = res.friendslist.friends.map(f => f.steamid);
                    const container = document.getElementById('friendsContainer');
                    if(container) container.innerHTML = '';
                    const batchSize = 100;
                    for(let i=0; i<allIds.length; i+=batchSize) {
                        const batch = allIds.slice(i, i+batchSize).join(',');
                        const profiles = await fetchFromSteam('ISteamUser/GetPlayerSummaries/v0002', { steamids: batch });
                        renderFriendsList(profiles.response.players); 
                        profiles.response.players.forEach(f => { friendFetchQueue.push(f); });
                    }
                    processFriendQueue();
                }
            } catch(e) { console.log("Amigos privados"); }
        }

        function processFriendQueue() {
             if (friendFetchQueue.length === 0) { document.querySelectorAll('.ranking-loader').forEach(el => el.style.display = 'none'); return; }
             document.querySelectorAll('.ranking-loader').forEach(el => el.style.display = 'inline-block');
             while (activeFriendRequests < 6 && friendFetchQueue.length > 0) { 
                 const friend = friendFetchQueue.shift(); activeFriendRequests++;
                 fetchOwnedGamesForFriend(friend).finally(() => { activeFriendRequests--; processFriendQueue(); });
             }
        }
        
        async function fetchOwnedGamesForFriend(friend) {
            try {
                const res = await fetchFromSteam('IPlayerService/GetOwnedGames/v0001', { steamid: friend.steamid, include_appinfo: false, include_played_free_games: false });
                if (res.response) {
                    const gameCount = res.response.game_count || 0;
                    let playtime = 0; if (res.response.games) res.response.games.forEach(g => playtime += g.playtime_forever);
                    const hours = (playtime / 60).toFixed(0);
                    currentState.friendsData.push({ ...friend, gameCount: gameCount, playtimeHours: parseInt(hours) });
                    renderRankings();
                }
            } catch(e) { }
        }
        
        function renderRankings() {
            const gamesSorted = [...currentState.friendsData].sort((a,b) => b.gameCount - a.gameCount).slice(0, 50);
            const gamesBody = document.getElementById('rankGamesBody');
            if(gamesBody) {
                gamesBody.innerHTML = '';
                gamesSorted.forEach((f, index) => { gamesBody.innerHTML += `<tr class="rank-row"><td class="rank-pos">${index+1}</td><td class="rank-user"><img src="${f.avatar}" class="rank-avatar">${f.personaname}</td><td class="rank-val">${f.gameCount}</td></tr>`; });
            }
            const timeSorted = [...currentState.friendsData].sort((a,b) => b.playtimeHours - a.playtimeHours).slice(0, 50);
            const timeBody = document.getElementById('rankTimeBody');
            if(timeBody) {
                timeBody.innerHTML = '';
                timeSorted.forEach((f, index) => { timeBody.innerHTML += `<tr class="rank-row"><td class="rank-pos">${index+1}</td><td class="rank-user"><img src="${f.avatar}" class="rank-avatar">${f.personaname}</td><td class="rank-val">${f.playtimeHours}h</td></tr>`; });
            }
        }

        // --- RENDERIZAÇÃO ---
        function renderProfile() {
            document.getElementById('userAvatar').src = currentState.user.avatarfull;
            document.getElementById('userNameText').innerText = currentState.user.personaname;
            document.getElementById('totalGames').innerText = currentState.games.length;
            updateHunterTitle();
        }

        function updateHunterTitle() {
            const plats = currentState.stats.totalPlatinum;
            const el = document.getElementById('hunterTitle');
            if(!el) return; 
            let title = "Iniciante"; let cls = "";
            if(plats >= 50) { title = "DEUS DA PLATINA"; cls = "legendary"; }
            else if(plats >= 20) { title = "Colecionador de Elite"; }
            else if(plats >= 5) { title = "Caçador de Troféus"; }
            el.innerText = title; el.className = "hunter-title " + cls;
        }

        function renderGamesGrid() {
            const grid = document.getElementById('gamesGrid');
            grid.innerHTML = ''; fetchQueue = []; activeRequests = 0;
            currentState.stats.totalPlayableGames = currentState.games.filter(g => g.has_community_visible_stats).length;
            updateGlobalStatsUI();
            document.getElementById('scan-progress-container').style.display = 'block';
            currentState.games.forEach(game => {
                const card = document.createElement('div'); card.className = 'game-card'; card.id = `game-${game.appid}`; card.dataset.percent = game.percent; card.dataset.name = game.name.toLowerCase();
                card.onmouseenter = () => setDynamicBackground(game.appid);
                let loadingState = '', pctText = '', progText = '', width = '0%';
                if (game.percent !== -1) { pctText = `${game.percent}%`; progText = `${game.unlocked}/${game.total}`; width = `${game.percent}%`; if (game.percent === 100) card.classList.add('platinum'); else if (game.percent >= 70) card.classList.add('platinando'); } else if (game.has_community_visible_stats) { loadingState = '<i class="fas fa-spinner fa-spin"></i>'; } else { loadingState = 'N/A'; }
                card.innerHTML = `<div class="platinum-badge" style="${game.percent === 100 ? 'display:block' : ''}"><i class="fas fa-trophy"></i> 100%</div><div class="platinando-badge" style="${(game.percent >= 70 && game.percent < 100) ? 'display:block' : ''}"><i class="fas fa-running"></i> Platinando</div><img src="${game.header_image}" class="game-banner" onerror="this.src='https://placehold.co/600x300/111/FFF?text=No+Image'"><div class="game-details"><div class="game-title">${game.name}</div><div class="game-meta"><span><i class="fas fa-clock"></i> ${game.playtime_hours}h</span></div><div class="game-progress-info" id="prog-${game.appid}">${loadingState}</div><div class="game-progress-bar-bg"><div class="game-progress-bar-fill" id="bar-${game.appid}" style="width:${width}"></div></div><div class="game-stats-row"><span id="txt-prog-${game.appid}">${progText}</span><span id="txt-pct-${game.appid}">${pctText}</span></div></div>`;
                card.onclick = () => openGameModal(game); grid.appendChild(card);
                if (game.has_community_visible_stats && game.percent === -1) fetchQueue.push(game.appid);
            });
            processQueue();
        }

        function processQueue() {
            if (fetchQueue.length === 0) { document.getElementById('scan-progress-container').style.display = 'none'; return; }
            const processed = currentState.stats.gamesCounted; const total = currentState.stats.totalPlayableGames; const barWidth = total > 0 ? (processed / total) * 100 : 0;
            document.getElementById('scan-progress-bar').style.width = `${barWidth}%`;
            while (activeRequests < MAX_CONCURRENT_REQUESTS && fetchQueue.length > 0) {
                const appId = fetchQueue.shift(); activeRequests++;
                fetchGameStats(appId).finally(() => { activeRequests--; processQueue(); });
            }
        }

        async function fetchGameStats(appId) {
            const progEl = document.getElementById(`prog-${appId}`); const card = document.getElementById(`game-${appId}`);
            if (!progEl) return;
            try {
                const res = await fetchFromSteam('ISteamUserStats/GetPlayerAchievements/v0001', { steamid: currentState.userId, appid: appId }, 3);
                if (res.playerstats && res.playerstats.achievements) {
                    const total = res.playerstats.achievements.length; const unlocked = res.playerstats.achievements.filter(a => a.achieved === 1).length; const percent = total > 0 ? Math.floor((unlocked / total) * 100) : 0;
                    const gameIdx = currentState.games.findIndex(g => g.appid === appId);
                    if(gameIdx > -1) { currentState.games[gameIdx].percent = percent; currentState.games[gameIdx].unlocked = unlocked; currentState.games[gameIdx].total = total; }
                    if(progEl && card) { progEl.innerHTML = ''; document.getElementById(`txt-prog-${appId}`).innerText = `${unlocked}/${total}`; document.getElementById(`txt-pct-${appId}`).innerText = `${percent}%`; document.getElementById(`bar-${appId}`).style.width = `${percent}%`; card.dataset.percent = percent; if (percent === 100) card.classList.add('platinum'); else if (percent >= 70) card.classList.add('platinando'); }
                    recalculateTotalStats();
                } else { if(progEl) progEl.innerText = "Sem Conquistas"; if(card) card.dataset.percent = 0; }
            } catch (e) { if(progEl) progEl.innerText = "-"; if(card) card.dataset.percent = 0; } finally { currentState.stats.gamesCounted++; if (currentState.activeFilter !== 'all') filterGames(); }
        }

        function recalculateTotalStats() {
            let tPlat = 0, tAch = 0, sumPct = 0, count = 0;
            currentState.games.forEach(g => { if (g.percent !== -1 && g.total > 0) { tAch += g.unlocked; sumPct += g.percent; count++; if (g.percent === 100) tPlat++; } });
            document.getElementById('totalPlatinum').innerText = tPlat; document.getElementById('totalAchievements').innerText = tAch.toLocaleString();
            const completionRateEl = document.getElementById('completionRate'); if (completionRateEl) { const avg = count > 0 ? (sumPct / count).toFixed(0) : 0; completionRateEl.innerText = `${avg}%`; }
            currentState.stats.totalPlatinum = tPlat; currentState.stats.totalAchievementsUnlocked = tAch;
            updateHunterTitle();
        }
        function updateGlobalStatsUI() { }
        function resetGlobalStats() { currentState.stats = { totalPlatinum: 0, totalAchievementsUnlocked: 0, sumPercentages: 0, gamesCounted: 0, totalPlayableGames: 0 }; document.getElementById('totalPlatinum').innerText = '0'; document.getElementById('totalAchievements').innerText = '0'; const completionRateEl = document.getElementById('completionRate'); if(completionRateEl) completionRateEl.innerText = '0%'; fetchQueue = []; activeRequests = 0; }
        function retryModalLoad() { if (currentState.currentModalGame) openGameModal(currentState.currentModalGame); }

        async function openGameModal(game) {
            currentState.currentModalGame = game; const modal = document.getElementById('achievementModal'); const title = document.getElementById('modalGameTitle'); const list = document.getElementById('achievementsList'); const loader = document.getElementById('modalLoader');
            title.innerText = game.name; list.innerHTML = ''; list.classList.add('hidden'); loader.classList.remove('hidden'); modal.classList.add('open'); document.body.style.overflow = 'hidden';
            try {
                const playerRes = await fetchFromSteam('ISteamUserStats/GetPlayerAchievements/v0001', { steamid: currentState.userId, appid: game.appid });
                if (!playerRes.playerstats || !playerRes.playerstats.achievements) throw new Error("Sem dados.");
                const playerAch = playerRes.playerstats.achievements;
                const schemaRes = await fetchFromSteam('ISteamUserStats/GetSchemaForGame/v0002', { appid: game.appid, l: 'brazilian' }); 
                const schemaAch = schemaRes.game && schemaRes.game.availableGameStats ? schemaRes.game.availableGameStats.achievements : [];
                let globalPerc = {};
                try { const globalRes = await fetchFromSteam('ISteamUserStats/GetGlobalAchievementPercentagesForApp/v0002', { gameid: game.appid }); if (globalRes.achievementpercentages) { globalRes.achievementpercentages.achievements.forEach(a => { globalPerc[a.name] = a.percent; }); } } catch(e) { }
                const fullList = playerAch.map(p => {
                    const schema = schemaAch.find(s => s.name === p.apiname) || {};
                    let rawPercent = globalPerc[p.apiname]; let percent = "N/A";
                    if (typeof rawPercent === 'number') { percent = rawPercent.toFixed(1); } else if (typeof rawPercent === 'string' && !isNaN(parseFloat(rawPercent))) { percent = parseFloat(rawPercent).toFixed(1); rawPercent = parseFloat(rawPercent); }
                    let rClass = 'rarity-common'; let rText = 'Comum';
                    if (percent !== "N/A") { if (rawPercent < 10) { rClass = 'rarity-ultra'; rText = 'Ultra Rara'; } else if (rawPercent < 30) { rClass = 'rarity-rare'; rText = 'Rara'; } }
                    return { api: p.apiname, unlocked: p.achieved === 1, name: schema.displayName || p.apiname, desc: schema.description || "Conquista Secreta", icon: p.achieved ? schema.icon : schema.icongray, percent: percent, rarityClass: rClass, rarityText: rText };
                });
                renderAchievementList(fullList); list.dataset.fullData = JSON.stringify(fullList); loader.classList.add('hidden'); list.classList.remove('hidden');
            } catch (error) { console.error(error); }
        }

        function renderAchievementList(list) {
            const container = document.getElementById('achievementsList'); container.innerHTML = '';
            list.forEach(ach => {
                if (currentState.modalFilter === 'unlocked' && !ach.unlocked) return; if (currentState.modalFilter === 'locked' && ach.unlocked) return;
                container.innerHTML += `<div class="achievement-item ${ach.unlocked ? 'unlocked' : 'locked'}"><img src="${ach.icon}" class="ach-icon" onerror="this.src='https://placehold.co/64/black/white?text=?'"><div class="ach-info"><div class="ach-name">${ach.name} <span class="rarity-tag ${ach.rClass}">${ach.rText} (${ach.percent}%)</span></div><div class="ach-desc">${ach.desc}</div></div><div class="ach-status"><i class="fas ${ach.unlocked ? 'fa-check-circle' : 'fa-lock'}"></i></div></div>`;
            });
        }

        function renderFriendsList(friends) {
            const container = document.getElementById('friendsContainer');
            friends.forEach(f => {
                container.innerHTML += `<button class="friend-card" onclick="triggerSearch('${f.steamid}')" title="${f.personaname}"><img src="${f.avatarfull}" class="friend-avatar"><div class="friend-name">${f.personaname}</div></button>`;
            });
        }

        /* --- EXTRAS --- */
        function openSignatureModal() {
            if(!currentState.userId) return alert("Pesquise um perfil primeiro.");
            const select = document.getElementById('sigGameSelect'); select.innerHTML = '';
            const validGames = currentState.games.filter(g => g.name);
            validGames.forEach(g => { const opt = document.createElement('option'); opt.value = g.appid; opt.innerText = g.name; select.appendChild(opt); });
            if(validGames.length > 0) updateSignaturePreview(validGames[0].appid);
            document.getElementById('signatureModal').classList.add('open');
        }

        function updateSignaturePreview(appId) {
            const game = currentState.games.find(g => g.appid == appId); if(!game) return;
            document.getElementById('sigBg').style.backgroundImage = `url('${game.header_image}')`;
            document.getElementById('sigAvatar').src = currentState.user.avatarfull;
            document.getElementById('sigName').innerText = currentState.user.personaname;
            document.getElementById('sigGames').innerText = currentState.stats.gamesCounted;
            document.getElementById('sigPlat').innerText = currentState.stats.totalPlatinum;
            document.getElementById('sigAch').innerText = currentState.stats.totalAchievementsUnlocked.toLocaleString();
            document.getElementById('sigGameName').innerText = game.name;
            const unlocked = game.unlocked || 0; const total = game.total || 0; const percent = game.percent > -1 ? game.percent : 0;
            document.getElementById('sigGameProg').innerText = `${unlocked}/${total}`;
            document.getElementById('sigGamePct').innerText = `${percent}%`;
            document.getElementById('sigGameBar').style.width = `${percent}%`;
        }

        function downloadSignature() {
            const element = document.getElementById('signature-card-element');
            html2canvas(element, { useCORS: true, allowTaint: true, backgroundColor: null }).then(canvas => { const link = document.createElement('a'); link.download = `steam_card_${currentState.userId}.png`; link.href = canvas.toDataURL('image/png'); link.click(); });
        }

        function openChartsModal() { document.getElementById('chartsModal').classList.add('open'); renderCharts(); }
        let chartsInstance = {};
        function renderCharts() {
            const ctxPie = document.getElementById('gamesPieChart').getContext('2d'); const ctxBar = document.getElementById('playtimeBarChart').getContext('2d');
            if(chartsInstance.pie) chartsInstance.pie.destroy(); if(chartsInstance.bar) chartsInstance.bar.destroy();
            const platinums = currentState.stats.totalPlatinum; const started = currentState.stats.gamesCounted - platinums; const unplayed = currentState.games.length - currentState.stats.gamesCounted;
            chartsInstance.pie = new Chart(ctxPie, { type: 'doughnut', data: { labels: ['Platinados', 'Iniciados', 'Não Jogados'], datasets: [{ data: [platinums, started, unplayed], backgroundColor: ['#ffd700', '#00f3ff', '#333'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { labels: { color: '#fff' } } } } });
            const topGames = currentState.games.slice(0, 10);
            chartsInstance.bar = new Chart(ctxBar, { type: 'bar', data: { labels: topGames.map(g => g.name.substring(0, 15) + '...'), datasets: [{ label: 'Horas', data: topGames.map(g => g.playtime_hours), backgroundColor: '#bc13fe' }] }, options: { responsive: true, plugins: { legend: { display: false }, tooltip: { mode: 'index' } }, scales: { y: { ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } } } });
        }

        function filterModal(type) { currentState.modalFilter = type; document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); const list = document.getElementById('achievementsList'); if(list.dataset.fullData) renderAchievementList(JSON.parse(list.dataset.fullData)); }
        function closeGameModal() { document.getElementById('achievementModal').classList.remove('open'); document.body.style.overflow = 'auto'; document.getElementById('dynamic-bg').style.opacity = '0'; }
        function filterGames() { const term = document.getElementById('gameSearchInput').value.toLowerCase(); document.querySelectorAll('.game-card').forEach(card => { const pct = parseFloat(card.dataset.percent); let show = card.dataset.name.includes(term); if (currentState.activeFilter === 'platinado' && pct < 100) show = false; if (currentState.activeFilter === 'platinando' && (pct < 70 || pct === 100)) show = false; show ? card.classList.remove('hidden-card') : card.classList.add('hidden-card'); }); }
        function setFilter(type) { currentState.activeFilter = type; document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === type)); filterGames(); }
        function sortGames() { const type = document.getElementById('sortSelect').value; if (type === 'playtime') currentState.games.sort((a,b) => b.playtime_forever - a.playtime_forever); if (type === 'completion') currentState.games.sort((a,b) => b.percent - a.percent); if (type === 'name') currentState.games.sort((a,b) => a.name.localeCompare(b.name)); renderGamesGrid(); }
        function filterFriends() { const term = document.getElementById('friendSearchInput').value.toLowerCase(); document.querySelectorAll('.friend-card').forEach(c => c.dataset.name.includes(term) ? c.classList.remove('hidden') : c.classList.add('hidden')); }
        function toggleTheme() { const b = document.body; if (!b.className) b.className = 'theme-matrix'; else if (b.className === 'theme-matrix') b.className = 'theme-fire'; else b.className = ''; }
        function changeTheme(theme) { document.body.className = ''; if (theme === 'rgb') {/* RGB logic optional */} else if (theme !== 'default') document.body.classList.add(`theme-${theme}`); }
        function setDynamicBackground(appId) { const bg = document.getElementById('dynamic-bg'); bg.style.backgroundImage = `url('https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/${appId}/page_bg_generated_v6b.jpg')`; bg.style.opacity = '0.3'; }
        function saveToHistory(id) { localStorage.setItem('lastSteamId', id); }
        function loadFromHistory() { const last = localStorage.getItem('lastSteamId'); if (last) document.getElementById('steamInput').value = last; }
        function triggerSearch(id) { document.getElementById('steamInput').value = id; handleSearch(); window.scrollTo({top:0, behavior:'smooth'}); }
        function refreshData() { if(currentState.userId) handleSearch(true); }
        function openVersusModal() { document.getElementById('vsInput1').value = currentState.userId || ""; document.getElementById('versusModal').classList.add('open'); }
        async function runVersus() {
            const id1 = currentState.userId; const input2 = document.getElementById('vsInput2').value;
            if(!id1 || !input2) return alert("Carregue seu perfil primeiro e digite o ID do oponente!");
            document.getElementById('versusContent').innerHTML = '<div class="loader"></div>';
            try {
                let id2 = input2; if(isNaN(input2)) { const r = await fetchFromSteam('ISteamUser/ResolveVanityURL/v0001', { vanityurl: input2 }); id2 = r.response.steamid; }
                const [p1, p2, g1, g2] = await Promise.all([fetchFromSteam('ISteamUser/GetPlayerSummaries/v0002', { steamids: id1 }), fetchFromSteam('ISteamUser/GetPlayerSummaries/v0002', { steamids: id2 }), fetchFromSteam('IPlayerService/GetOwnedGames/v0001', { steamid: id1 }), fetchFromSteam('IPlayerService/GetOwnedGames/v0001', { steamid: id2 })]);
                const user1 = p1.response.players[0]; const user2 = p2.response.players[0];
                const games1 = g1.response.game_count || 0; const games2 = g2.response.game_count || 0;
                let time1 = 0; if (g1.response.games) g1.response.games.forEach(g => time1 += g.playtime_forever); time1 = (time1 / 60).toFixed(0);
                let time2 = 0; if (g2.response.games) g2.response.games.forEach(g => time2 += g.playtime_forever); time2 = (time2 / 60).toFixed(0);
                let score1 = games1 + parseInt(time1); let score2 = games2 + parseInt(time2);
                let totalScore = score1 + score2; let p1Width = totalScore > 0 ? (score1 / totalScore) * 100 : 50;
                document.getElementById('versusContent').innerHTML = `<div class="vs-player ${count1 > count2 ? 'winner-bg' : ''}"><img src="${user1.avatarfull}" class="vs-avatar ${count1 > count2 ? 'winner' : ''}"><h3>${user1.personaname}</h3><div class="vs-stat-row"><span class="vs-stat-label">Jogos</span><span class="vs-stat-val ${count1 > count2 ? 'win' : ''}">${count1}</span></div><div class="vs-stat-row"><span class="vs-stat-label">Horas</span><span class="vs-stat-val ${parseInt(time1) > parseInt(time2) ? 'win' : ''}">${time1}h</span></div></div><div class="vs-divider">VS</div><div class="vs-player ${count2 > count1 ? 'winner-bg' : ''}"><img src="${user2.avatarfull}" class="vs-avatar ${count2 > count1 ? 'winner' : ''}"><h3>${user2.personaname}</h3><div class="vs-stat-row"><span class="vs-stat-label">Jogos</span><span class="vs-stat-val ${count2 > count1 ? 'win' : ''}">${count2}</span></div><div class="vs-stat-row"><span class="vs-stat-label">Horas</span><span class="vs-stat-val ${parseInt(time2) > parseInt(time1) ? 'win' : ''}">${time2}h</span></div></div>`;
                document.getElementById('tugContainer').style.display = 'block';
                document.getElementById('tugBarP1').style.width = `${p1Width}%`;
            } catch(e) { alert("Erro ao comparar: " + e.message); }
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Achievements Explorer</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#66c0f4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SAE">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@300;400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- √çcones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bibliotecas Externas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Cache System -->
    <script src="js/idb-cache.js"></script>
    <!-- Multi-language System -->
    <script src="languages.js"></script>

    <style>
        :root {
            --primary-color: #00f3ff; 
            --secondary-color: #bc13fe;
            --bg-dark: #050b14;
            --bg-panel: rgba(16, 26, 46, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #e0e6ed;
            --text-dim: #94a3b8;
            --success: #00ff9d;
            --warning: #ffbd2e;
            --danger: #ff0055;
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
            --card-radius: 12px;
        }

        /* TEMAS */
        body.theme-matrix { --primary-color: #00ff41; --secondary-color: #008f11; --bg-dark: #000000; --bg-panel: rgba(0, 20, 0, 0.95); --success: #00ff41; }
        body.theme-fire { --primary-color: #ffbd2e; --secondary-color: #ff0055; --bg-dark: #1a0505; --bg-panel: rgba(40, 10, 10, 0.95); }
        body.theme-retro {
            --primary-color: #fca311; --secondary-color: #14213d; --bg-dark: #101010; --bg-panel: #1a1a1a;
            --glass-border: #404040; --text-main: #e5e5e5; --text-dim: #a0a0a0; --success: #2a9d8f;
            --font-display: 'Press Start 2P', cursive; --font-body: 'Rajdhani', sans-serif; --card-radius: 0px;
        }
        
        body.theme-retro .site-title { text-shadow: 2px 2px 0px #000; letter-spacing: -1px; font-size: 18px; }
        body.theme-retro .game-card, body.theme-retro .profile-hero, body.theme-retro .library-controls, body.theme-retro .search-input, body.theme-retro .achievements-modal, body.theme-retro .icon-btn, body.theme-retro .filter-select, body.theme-retro .filter-btn, body.theme-retro .signature-modal, body.theme-retro .versus-modal, body.theme-retro .chart-modal, body.theme-retro .ranking-col, body.theme-retro .nav-btn { border: 1px solid var(--glass-border); box-shadow: none; }
        body.theme-retro .game-card:hover { border-color: var(--primary-color); transform: translateY(-2px); box-shadow: 4px 4px 0px #000; }
        body.theme-retro .profile-avatar { border-radius: 0px; border: 2px solid var(--primary-color); box-shadow: 4px 4px 0px rgba(0,0,0,0.5); }
        body.theme-retro .game-title, body.theme-retro .modal-game-title { font-family: 'Press Start 2P', cursive; font-size: 10px; line-height: 1.6; }
        body.theme-retro .progress-bar-bg { border-radius: 0; background: #333; }
        body.theme-retro .progress-bar-fill { border-radius: 0; }
        body.theme-retro .friend-avatar, body.theme-retro .rank-avatar { border-radius: 0px; border: 1px solid var(--text-dim); }

        body.theme-light {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --bg-dark: #f8f9fa;
            --bg-panel: #ffffff;
            --glass-border: #dee2e6;
            --text-main: #212529;
            --text-dim: #6c757d;
        }

        body.theme-dark {
            --primary-color: #e83e8c; 
            --secondary-color: #6f42c1;
            --bg-dark: #000000;
            --bg-panel: rgba(20, 20, 20, 0.95);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #f8f9fa;
            --text-dim: #adb5bd;
        }

        @keyframes rgb-color-cycle {
            0% { --primary-color: #ff00de; --secondary-color: #deff00; }
            25% { --primary-color: #00ffde; --secondary-color: #de00ff; }
            50% { --primary-color: #de00ff; --secondary-color: #00deff; }
            75% { --primary-color: #ffde00; --secondary-color: #00ffde; }
            100% { --primary-color: #ff00de; --secondary-color: #deff00; }
        }
        body.theme-rgb {
            animation: rgb-color-cycle 8s linear infinite;
        }

        /* --- TEMAS SAZONAIS --- */
        .seasonal-btn { transition: all 0.3s ease; }
        .seasonal-btn.active { color: var(--primary-color); background: rgba(0,243,255,0.2); }
        .seasonal-btn.active.christmas { color: #ff3333; background: rgba(255,51,51,0.2); }
        .seasonal-btn.active.halloween { color: #ff7518; background: rgba(255,117,24,0.2); }
        
        @keyframes snowfall { 
            0% { background-position: 0 0, 0 0, 0 0; } 
            100% { background-position: 500px 1000px, 400px 800px, 300px 600px; } 
        }
        
        body.theme-seasonal-christmas::before {
            content: ''; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 5;
            pointer-events: none;
            background-image: 
                radial-gradient(4px 4px at 100px 50px, white, transparent),
                radial-gradient(3px 3px at 200px 150px, white, transparent),
                radial-gradient(2px 2px at 300px 250px, rgba(255,255,255,0.8), transparent),
                radial-gradient(4px 4px at 400px 350px, white, transparent),
                radial-gradient(3px 3px at 500px 100px, white, transparent),
                radial-gradient(2px 2px at 50px 200px, rgba(255,255,255,0.8), transparent),
                radial-gradient(3px 3px at 150px 300px, white, transparent),
                radial-gradient(4px 4px at 250px 400px, white, transparent),
                radial-gradient(2px 2px at 350px 500px, rgba(255,255,255,0.8), transparent),
                radial-gradient(3px 3px at 450px 250px, white, transparent);
            background-size: 600px 600px;
            animation: snowfall 15s linear infinite;
            opacity: 0.7;
        }
        
        /* Christmas apenas adiciona efeitos, n√£o muda cores do tema base */
        body.theme-seasonal-christmas .main-header,
        body.theme-seasonal-christmas .profile-card {
            border-color: rgba(255, 51, 51, 0.3);
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.15), 0 0 60px rgba(0, 204, 68, 0.1);
        }

        @keyframes spookyPulse {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.3; }
        }
        
        body.theme-seasonal-halloween::before {
            content: 'üéÉüëªü¶áüíÄüï∑Ô∏è';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
            font-size: 30px;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(255, 117, 24, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(75, 0, 130, 0.15) 0%, transparent 50%);
            animation: spookyPulse 4s ease-in-out infinite;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 50px;
            opacity: 0.5;
            letter-spacing: 100px;
        }
        
        /* Halloween apenas adiciona efeitos, n√£o muda cores do tema base */
        body.theme-seasonal-halloween .main-header,
        body.theme-seasonal-halloween .profile-card {
            border-color: rgba(255, 117, 24, 0.3);
            box-shadow: 0 0 30px rgba(255, 117, 24, 0.15), 0 0 60px rgba(153, 50, 204, 0.1);
        }
        /* --- FIM TEMAS SAZONAIS --- */

        /* HEADER XP BAR */
        .header-xp-container { 
            display: flex; align-items: center; gap: 10px; 
            background: rgba(0,0,0,0.35); padding: 6px 12px; 
            border-radius: 25px; border: 1px solid rgba(255,255,255,0.08);
            cursor: pointer; transition: all 0.3s ease;
            text-decoration: none;
        }
        .header-xp-container:hover { 
            background: rgba(0,0,0,0.5); border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(0,243,255,0.2);
        }
        .header-lvl-badge { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color: #000; font-weight: bold; padding: 4px 10px; 
            border-radius: 12px; font-size: 12px; font-family: var(--font-display);
            min-width: 50px; text-align: center;
        }
        .header-xp-bar { 
            width: 100px; height: 8px; background: #222; 
            border-radius: 6px; overflow: hidden; 
        }
        .header-xp-fill { 
            height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); 
            width: 0%; transition: width 0.6s ease; 
        }
        .header-xp-text { font-size: 11px; color: var(--text-dim); font-family: var(--font-body); }
        body.theme-retro .header-xp-container { border-radius: 0; }
        body.theme-retro .header-lvl-badge { border-radius: 0; }
        body.theme-retro .header-xp-bar { border-radius: 0; }

        /* OST Toast Animations */
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        
        /* Generic Toast */
        .sae-toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 10px; font-family: var(--font-body); font-size: 14px; font-weight: 600; z-index: 100000; animation: slideInRight 0.3s ease; display: flex; align-items: center; gap: 10px; max-width: 350px; }
        .sae-toast.success { background: linear-gradient(135deg, #00ff9d, #00c853); color: #000; }
        .sae-toast.error { background: linear-gradient(135deg, #ff0055, #c51162); color: #fff; }
        .sae-toast.warning { background: linear-gradient(135deg, #ffbd2e, #ff9800); color: #000; }
        .sae-toast.info { background: linear-gradient(135deg, #00f3ff, #2196f3); color: #000; }
        
        /* Old School User Badge */
        .oldschool-user-badge { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #8b4513, #cd853f); color: #fff; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; margin-left: 10px; box-shadow: 0 0 10px rgba(139, 69, 19, 0.5); }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: var(--font-body); min-height: 100vh; overflow-x: hidden; transition: background 0.5s ease, color 0.5s ease; }
        .container { width: 100%; max-width: 1280px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        .hidden { display: none !important; }

        /* HEADER */
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; margin-bottom: 30px; border-bottom: 1px solid var(--glass-border); position: relative; z-index: 10000; flex-wrap: wrap; gap: 15px; background: var(--bg-panel); border-radius: 15px; }
        .logo-area { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .logo-icon { font-size: 28px; color: var(--primary-color); text-shadow: 0 0 10px var(--primary-color); }
        .site-title { font-family: var(--font-display); font-size: 18px; background: linear-gradient(90deg, var(--text-main), var(--primary-color)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        
        .main-nav { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .nav-btn { 
            background: transparent; border: 1px solid transparent; color: var(--text-dim); 
            padding: 6px 12px; border-radius: 15px; cursor: pointer; 
            font-family: var(--font-display); text-decoration: none; font-size: 10px; transition: 0.3s; 
            display: flex; align-items: center; justify-content: center; white-space: nowrap;
        }
        .nav-btn:hover, .nav-btn.active { 
            background: rgba(255,255,255,0.1); color: var(--primary-color); border-color: var(--glass-border); box-shadow: 0 0 10px rgba(0,0,0,0.2); 
        }
        .nav-btn.primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #000; font-weight: bold; padding: 8px 20px; font-size: 12px;
            border: none; box-shadow: 0 0 20px rgba(0,243,255,0.3);
        }
        .nav-btn.primary:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(0,243,255,0.5); }
        
        /* Nav Menu Dropdown */
        .nav-menu-container { position: relative; }
        .nav-menu-btn {
            background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main);
            padding: 8px 15px; border-radius: 15px; cursor: pointer; font-family: var(--font-display); font-size: 11px;
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .nav-menu-btn:hover { background: rgba(255,255,255,0.15); color: var(--primary-color); }
        .nav-menu-dropdown {
            position: absolute; top: 100%; left: 0; margin-top: 10px;
            background: var(--bg-panel); border: 1px solid var(--glass-border); border-radius: 12px;
            min-width: 180px; padding: 10px 0; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; z-index: 1000;
        }
        .nav-menu-container:hover .nav-menu-dropdown,
        .nav-menu-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .nav-menu-dropdown a {
            display: flex; align-items: center; gap: 12px; padding: 12px 20px;
            color: var(--text-main); text-decoration: none; font-size: 14px; transition: 0.2s;
        }
        .nav-menu-dropdown a:hover { background: rgba(0,243,255,0.1); color: var(--primary-color); }
        .nav-menu-dropdown a i { width: 20px; text-align: center; color: var(--primary-color); }
        
        .header-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        
        .theme-select { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main); padding: 6px 10px; border-radius: 15px; font-family: var(--font-body); font-weight: bold; cursor: pointer; outline: none; font-size: 12px; max-width: 100px; }
        body.theme-retro .theme-select { border-radius: 0px; border: 2px solid var(--glass-border); }
        .theme-select option { background: var(--bg-dark); color: var(--text-main); }
        
        .icon-btn { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .icon-btn:hover { background: var(--primary-color); color: #000; }
        body.theme-retro .icon-btn { border-radius: 0px; border: 2px solid var(--glass-border); }

        /* SEARCH */
        .search-section { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; transition: all 0.5s ease; }
        .search-section.active { min-height: auto; flex-direction: row; justify-content: flex-end; margin-bottom: 20px; }
        .search-box { position: relative; width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 10px; }
        .search-input { width: 100%; padding: 18px 25px; padding-right: 60px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 50px; color: var(--text-main); font-family: var(--font-display); font-size: 16px; backdrop-filter: blur(10px); transition: all 0.3s ease; }
        .search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 15px rgba(0,243,255,0.2); }
        body.theme-retro .search-input { border-radius: 0px; border-width: 2px; font-family: var(--font-body); font-size: 12px; }
        .search-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: var(--primary-color); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: #000; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .search-btn:hover { transform: translateY(-50%) scale(1.1); }
        body.theme-retro .search-btn { border-radius: 0px; }

        /* PROFILE */
        .profile-hero { display: flex; align-items: center; gap: 30px; padding: 40px; background: var(--bg-panel); backdrop-filter: blur(10px); border-radius: var(--card-radius); border: 1px solid var(--glass-border); margin-bottom: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideDown 0.6s ease-out; position: relative; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary-color); object-fit: cover; box-shadow: 0 0 20px var(--primary-color); }
        .profile-info { flex: 1; }
        .profile-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .profile-info h1 { font-family: var(--font-display); font-size: 32px; margin: 0; display:flex; align-items:center; gap:15px; }
        
        .hunter-title { 
            font-size: 14px; padding: 5px 12px; border-radius: 20px; 
            background: rgba(0,0,0,0.5); border: 1px solid var(--primary-color); 
            color: var(--primary-color); font-family: var(--font-body); text-transform: uppercase; letter-spacing: 1px;
        }
        .hunter-title.legendary {
            background: linear-gradient(90deg, #ffd700, #ff8c00); color: #000; border: none;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); font-weight: bold;
            animation: glow 2s infinite alternate;
        }
        @keyframes glow { from { box-shadow: 0 0 5px #ffd700; } to { box-shadow: 0 0 20px #ffd700; } }
        
        .action-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--glass-border); color: var(--text-dim); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-family: var(--font-body); display: flex; align-items: center; gap: 8px; transition: 0.3s; font-size: 12px; text-transform: uppercase; font-weight: 700; }
        .action-btn:hover { background: var(--primary-color); color: #000; }
        body.theme-retro .action-btn { border-radius: 0px; border-width: 2px; }
        
        .profile-actions { display: flex; gap: 10px; align-items: center; }
        .share-dropdown { position: relative; }
        .share-menu { position: absolute; top: 100%; right: 0; background: var(--bg-panel); border: 1px solid var(--glass-border); border-radius: 10px; min-width: 180px; padding: 8px 0; display: none; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top: 5px; }
        .share-menu.active { display: block; animation: fadeIn 0.2s ease; }
        .share-item { display: flex; align-items: center; gap: 10px; padding: 10px 15px; color: var(--text-main); text-decoration: none; transition: background 0.2s; }
        .share-item:hover { background: rgba(255,255,255,0.1); }
        .share-item.twitter:hover { background: rgba(29, 161, 242, 0.2); color: #1da1f2; }
        .share-item.discord:hover { background: rgba(88, 101, 242, 0.2); color: #5865f2; }
        .share-item.copy:hover { background: rgba(0, 243, 255, 0.2); color: var(--primary-color); }
        .share-item.profile:hover { background: rgba(255, 215, 0, 0.2); color: #ffd700; }

        .profile-stats { display: flex; gap: 30px; margin-top: 15px; flex-wrap: wrap; }
        .stat-item { text-align: center; min-width: 100px; }
        .stat-value { display: block; font-size: 24px; font-weight: 700; color: var(--primary-color); }
        .stat-value.gold { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .stat-value.purple { color: #bc13fe; }
        .stat-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
        body.theme-retro .stat-value { font-family: 'Press Start 2P', cursive; font-size: 14px; margin-bottom: 10px; }

        /* ULTRA RARE SHOWCASE */
        .showcase-section { margin-bottom: 40px; display:none; }
        .showcase-grid { display: flex; gap: 15px; flex-wrap: wrap; }
        .showcase-card { 
            flex: 1; min-width: 250px; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(0,0,0,0.2));
            border: 1px solid var(--warning); border-radius: 12px; padding: 15px;
            display: flex; align-items: center; gap: 15px; position: relative; overflow: hidden;
        }
        .showcase-card::before {
            content: ''; position: absolute; top:0; left:0; width:4px; height:100%; background: var(--warning);
            box-shadow: 0 0 10px var(--warning);
        }
        .showcase-icon { width: 50px; height: 50px; border-radius: 8px; }
        .showcase-info h4 { margin: 0; font-size: 14px; color: var(--warning); }
        .showcase-info p { margin: 2px 0 0; font-size: 11px; color: var(--text-dim); }
        .showcase-pct { position: absolute; right: 15px; top: 15px; font-size: 12px; font-weight: bold; color: var(--warning); }

        /* LIBRARY */
        .library-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .section-title { font-family: var(--font-display); font-size: 24px; margin: 0; border-left: 4px solid var(--secondary-color); padding-left: 15px; }
        body.theme-retro .section-title { font-size: 16px; border-left-width: 8px; }
        .library-controls { display: flex; gap: 15px; align-items: center; background: var(--bg-panel); padding: 10px; border-radius: var(--card-radius); border: 1px solid var(--glass-border); flex: 1; max-width: 800px; }
        .game-search-input { flex: 1; background: transparent; border: none; color: var(--text-main); font-family: var(--font-body); padding: 5px 10px; font-size: 16px; outline: none; }
        .filter-select { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-main); padding: 5px 10px; border-radius: 8px; font-family: var(--font-body); cursor: pointer; }
        body.theme-retro .filter-select { border-radius: 0px; border-width: 2px; }
        .filter-select option { background: var(--bg-dark); color: var(--text-main); }
        .filter-btn { background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 700; transition: 0.2s; }
        .filter-btn.active, .filter-btn:hover { background: var(--primary-color); color: #000; border-color: var(--primary-color); }
        body.theme-retro .filter-btn { border-radius: 0px; border-width: 2px; }

        /* GAMES GRID */
        .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-bottom: 50px; }
        .game-card { background: var(--bg-panel); border-radius: var(--card-radius); overflow: hidden; border: 1px solid var(--glass-border); transition: all 0.3s ease; position: relative; cursor: pointer; display: flex; flex-direction: column; }
        .game-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 243, 255, 0.15); border-color: var(--primary-color); }
        body.theme-retro .game-card:hover { transform: translate(-2px, -2px); box-shadow: 8px 8px 0px var(--primary-color); }
        .game-card.hidden-card { display: none; }
        
        .game-banner { 
            width: 100%; height: 130px; object-fit: cover; 
            border-bottom: 1px solid var(--glass-border); 
            background: linear-gradient(135deg, rgba(0,243,255,0.1), rgba(188,19,254,0.1));
            transition: opacity 0.3s ease;
        }
        .game-banner.lazy-img:not(.loaded) {
            opacity: 0.5;
            filter: blur(5px);
        }
        .game-banner.lazy-img.loaded {
            opacity: 1;
            filter: blur(0);
        }
        .game-details { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .game-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        body.theme-retro .game-title { font-family: 'Press Start 2P', cursive; font-size: 10px; line-height: 1.5; }
        .game-meta { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-dim); margin-bottom: 10px; align-items: flex-start; }
        .game-meta-left { display: flex; flex-direction: column; gap: 2px; }
        .game-meta-right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
        .game-meta-right .hltb-label { font-size: 9px; color: var(--text-dim); opacity: 0.7; }
        .game-meta-right .hltb-time { font-size: 11px; color: var(--primary-color); font-weight: 600; }
        .game-progress-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        body.theme-retro .game-progress-bar-bg { border-radius: 0; height: 8px; border: 1px solid #fff; }
        .game-progress-bar-fill { height: 100%; background: var(--secondary-color); width: 0%; transition: width 1s ease; }
        .game-stats-row { display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; font-weight: 700; }

        .platinum-badge, .platinando-badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: none; }
        .platinum-badge { background: linear-gradient(135deg, #ffd700, #ffa500); color: #000; }
        .platinando-badge { background: linear-gradient(135deg, #ffbd2e, #ff9f1c); color: #000; }
        .game-card.platinum .platinum-badge { display: block; }
        .game-card.platinum { border-color: rgba(255, 215, 0, 0.3); }
        .game-card.platinando .platinando-badge { display: block; }
        .game-card.platinando { border: 1px solid rgba(255, 189, 46, 0.5); }

        /* FRIENDS & RANKING */
        .friends-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .friend-search-input { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: var(--text-main); padding: 8px 15px; border-radius: 20px; font-family: var(--font-body); font-size: 14px; width: 200px; }
        .friend-search-input:focus { outline: none; border-color: var(--primary-color); }
        body.theme-retro .friend-search-input { border-radius: 0px; border-width: 2px; }

        .friends-container { display: flex; overflow-x: auto; gap: 15px; padding: 10px 5px 20px 5px; margin-bottom: 20px; scroll-behavior: smooth; }
        .friend-card { min-width: 80px; max-width: 80px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s; background: transparent; border: none; }
        .friend-card:hover .friend-avatar { transform: scale(1.1); border-color: var(--success); box-shadow: 0 0 15px var(--success); }
        .friend-card.hidden { display: none; }
        .friend-avatar { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--primary-color); object-fit: cover; transition: 0.3s; }
        body.theme-retro .friend-avatar { border-radius: 0px; border-width: 3px; }
        .friend-name { font-size: 12px; font-weight: 600; text-align: center; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

        /* RANKING GRID */
        .ranking-section { margin-top: 30px; margin-bottom: 50px; }
        .ranking-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .ranking-col { background: var(--bg-panel); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; height: 400px; }
        body.theme-retro .ranking-col { border-radius: 0px; border-width: 2px; }
        .ranking-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); margin-bottom: 10px; }
        .ranking-title { font-family: var(--font-display); font-size: 16px; color: var(--primary-color); }
        .ranking-loader { display:inline-block; font-size:10px; color:var(--text-dim); margin-left:10px; }
        .scrollable-table { flex: 1; overflow-y: auto; padding-right: 5px; }
        .rank-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rank-table th { text-align: left; padding: 8px; color: var(--text-dim); font-size: 11px; position: sticky; top: 0; background: var(--bg-panel); z-index:2; }
        .rank-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-row:hover { background: rgba(255,255,255,0.05); }
        .rank-pos { font-weight: bold; color: var(--secondary-color); width: 30px; }
        .rank-val { font-weight: bold; color: #fff; text-align: right; }
        .rank-user { display: flex; align-items: center; gap: 8px; }
        .rank-avatar { width: 24px; height: 24px; border-radius: 50%; }
        body.theme-retro .rank-avatar { border-radius: 0; }

        /* Background & Loader */
        #dynamic-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-size: cover; background-position: center; opacity: 0; filter: blur(20px) brightness(0.4); transition: opacity 1s ease, background-image 1s ease; }
        #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .loader { width: 48px; height: 48px; border: 3px solid var(--text-main); border-radius: 50%; display: inline-block; position: relative; box-sizing: border-box; animation: rotation 1s linear infinite; }
        .loader::after { content: ''; box-sizing: border-box; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; border-bottom-color: var(--primary-color); }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        #scan-progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 1000; background: rgba(0,0,0,0.5); }
        #scan-progress-bar { height: 100%; background: linear-gradient(90deg, var(--success), var(--primary-color)); width: 0%; transition: width 0.3s; box-shadow: 0 0 10px var(--success); }
        
        /* SCAN STATUS PANEL */
        .scan-status-panel {
            position: fixed; bottom: 20px; right: 20px; z-index: 999;
            background: var(--bg-panel); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 15px 20px; min-width: 280px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none;
        }
        .scan-status-panel.active { display: block; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .scan-status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .scan-status-title { font-family: var(--font-display); font-size: 14px; color: var(--primary-color); }
        .scan-status-close { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 16px; }
        .scan-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; }
        .scan-stat { display: flex; justify-content: space-between; }
        .scan-stat-label { color: var(--text-dim); }
        .scan-stat-value { color: var(--text-main); font-weight: bold; }
        .scan-stat-value.success { color: var(--success); }
        .scan-stat-value.warning { color: var(--warning); }
        .scan-stat-value.error { color: var(--danger); }
        .scan-actions { margin-top: 12px; display: flex; gap: 8px; }
        .scan-actions button { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.05); color: var(--text-main); cursor: pointer; font-size: 11px; font-family: var(--font-display); transition: 0.2s; }
        .scan-actions button:hover { background: var(--primary-color); color: #000; }
        .scan-actions button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        
        /* VERSUS */
        .versus-modal { width: 90%; max-width: 800px; background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--primary-color); padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .versus-header { text-align: center; font-family: var(--font-display); font-size: 24px; margin-bottom: 20px; color: var(--primary-color); }
        .versus-inputs { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .versus-content { display: flex; justify-content: space-between; align-items: flex-start; min-height: 200px; gap:20px; }
        .vs-player { flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; }
        .vs-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--text-dim); object-fit: cover; }
        .vs-stat-row { display: flex; flex-direction: column; width: 100%; margin: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .vs-stat-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; }
        .vs-stat-val { font-size: 18px; font-weight: bold; font-family: 'Rajdhani'; }
        .vs-stat-val.win { color: var(--success); }
        .tug-of-war { width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden; display: flex; margin-top: 20px; position: relative; }
        .tug-bar-p1 { height: 100%; background: #007bff; transition: width 1s ease; }
        .tug-bar-p2 { height: 100%; background: #dc3545; flex: 1; }
        .tug-icon { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 20px; color: #fff; }

        /* CHARTS */
        .chart-modal { width: 90%; max-width: 800px; background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--primary-color); padding: 30px; display: flex; flex-direction: column; gap: 20px; max-height: 90vh; overflow-y: auto; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-container { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; }

        /* SIGNATURE */
        .signature-modal { width: 90%; max-width: 650px; background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--primary-color); padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .sig-controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .sig-preview-container { width: 100%; overflow: hidden; border: 2px solid var(--glass-border); border-radius: 10px; display: flex; justify-content: center; align-items: center; background: #000; }
        #signature-card-element { width: 600px; height: 350px; background: #111; color: #fff; display: flex; flex-direction: column; overflow: hidden; position: relative; flex-shrink: 0; }
        .sig-bg { position: absolute; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(4px) brightness(0.3); }
        .sig-top { position: relative; z-index: 2; display: flex; align-items: center; gap: 25px; padding: 25px; width: 100%; flex: 1; }
        .sig-avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary-color); box-shadow: 0 0 25px rgba(0,0,0,0.8); object-fit: cover; }
        .sig-info { flex: 1; }
        .sig-info h2 { margin: 0 0 10px 0; font-family: 'Orbitron'; font-size: 26px; text-shadow: 3px 3px 0 #000; letter-spacing: 1px; color: #fff; }
        .sig-stats { display: flex; gap: 15px; }
        .sig-stat { font-family: 'Rajdhani'; font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 6px; text-shadow: 1px 1px 0 #000; }
        .sig-game-section { position: relative; z-index: 2; background: rgba(0,0,0,0.7); padding: 15px 25px; display: flex; flex-direction: column; gap: 5px; border-top: 2px solid var(--primary-color); }
        .sig-game-name { font-family: 'Orbitron'; font-size: 18px; color: var(--success); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sig-game-row { display: flex; justify-content: space-between; align-items: center; font-family: 'Rajdhani'; font-size: 14px; font-weight: bold; }
        .sig-progress-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .sig-progress-fill { height: 100%; background: var(--success); border-radius: 3px; }
        .sig-watermark { position: absolute; top: 10px; right: 15px; font-size: 10px; color: rgba(255,255,255,0.3); font-family: sans-serif; z-index: 2; }

        /* SOUNDTRACK TOGGLE */
        .soundtrack-toggle {
            display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3);
            padding: 8px 15px; border-radius: 20px; border: 1px solid var(--glass-border);
            cursor: pointer; transition: 0.3s;
        }
        .soundtrack-toggle:hover { border-color: var(--primary-color); }
        .soundtrack-toggle.active { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border: none; }
        .soundtrack-toggle.active .toggle-text { color: #000; }
        .soundtrack-toggle.active .toggle-icon { color: #000; }
        .toggle-icon { font-size: 14px; color: var(--primary-color); }
        .toggle-text { font-size: 12px; font-weight: 600; color: var(--text-dim); }
        .soundtrack-toggle.playing .toggle-icon { animation: bounce-music 0.5s infinite alternate; }
        @keyframes bounce-music { 0% { transform: translateY(0); } 100% { transform: translateY(-3px); } }

        /* ACHIEVEMENTS MODAL */
        .achievements-modal { width: 90%; max-width: 900px; height: 85vh; background: var(--bg-dark); border-radius: 20px; border: 1px solid var(--secondary-color); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px 30px; background: linear-gradient(90deg, rgba(188, 19, 254, 0.1), transparent); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-controls { display: flex; gap: 10px; align-items: center; }
        .soundtrack-btn { background: rgba(0,243,255,0.1); border-color: var(--primary-color); }
        .soundtrack-btn.playing { background: var(--primary-color); color: #000; animation: pulse-music 1s infinite; }
        @keyframes pulse-music { 0%, 100% { box-shadow: 0 0 0 0 rgba(0,243,255,0.4); } 50% { box-shadow: 0 0 0 8px rgba(0,243,255,0); } }
        .modal-game-title { font-family: var(--font-display); font-size: 20px; color: var(--secondary-color); }
        .modal-tabs { display: flex; gap: 15px; margin-top: 15px; }
        .modal-tab-btn { background: transparent; border: none; color: var(--text-dim); font-family: var(--font-body); font-weight: 700; cursor: pointer; padding-bottom: 5px; border-bottom: 2px solid transparent; }
        .modal-tab-btn.active { color: var(--text-main); border-color: var(--primary-color); }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px 30px; }
        .achievement-item { display: flex; align-items: center; gap: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; transition: 0.2s; }
        .achievement-item.unlocked { border-left: 4px solid var(--success); background: linear-gradient(90deg, rgba(0,255,157,0.05), transparent); }
        .achievement-item.locked { border-left: 4px solid var(--text-dim); opacity: 0.7; }
        .ach-icon { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; background: #000; }
        .ach-info { flex: 1; }
        .ach-name { font-weight: 700; font-size: 16px; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .ach-desc { font-size: 13px; color: var(--text-dim); margin-top: 4px; }
        .rarity-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #333; color: #fff; }
        .rarity-common { background: #555; }
        .rarity-rare { background: var(--primary-color); color: #000; }
        .rarity-ultra { background: var(--warning); color: #000; box-shadow: 0 0 5px var(--warning); }
        .close-modal-btn { background: none; border: none; color: var(--text-dim); font-size: 24px; cursor: pointer; transition: 0.2s; }
        .close-modal-btn:hover { color: var(--text-main); transform: rotate(90deg); }
        
        /* CACHE INDICATOR */
        .cache-badge { 
            position: absolute; top: 10px; right: 10px;
            background: linear-gradient(135deg, var(--success), #00aa77);
            color: #000; font-size: 10px; padding: 4px 10px;
            border-radius: 12px; font-weight: bold;
            font-family: var(--font-display);
            display: flex; align-items: center; gap: 5px;
            box-shadow: 0 0 10px rgba(0,255,157,0.3);
        }
        .cache-badge i { font-size: 12px; }
        
        #refreshBtn { 
            background: rgba(255,0,85,0.2); 
            border-color: var(--danger);
            color: var(--danger);
        }
        #refreshBtn:hover { 
            background: var(--danger); 
            color: #fff;
        }
        
        /* HEATMAP CALENDAR */
        .heatmap-section {
            background: var(--bg-panel);
            border-radius: var(--card-radius);
            border: 1px solid var(--glass-border);
            padding: 25px;
            margin-bottom: 30px;
        }
        .heatmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .heatmap-stats {
            display: flex;
            gap: 20px;
            font-family: var(--font-body);
            font-size: 14px;
            color: var(--text-dim);
        }
        .heatmap-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .heatmap-container {
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .heatmap-months {
            display: flex;
            gap: 0;
            margin-bottom: 5px;
            padding-left: 35px;
            font-size: 11px;
            color: var(--text-dim);
            font-family: var(--font-body);
        }
        .heatmap-months span {
            width: calc(52 / 12 * 14px);
            text-align: left;
        }
        .heatmap-grid-wrapper {
            display: flex;
            gap: 5px;
        }
        .heatmap-days {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 10px;
            color: var(--text-dim);
            padding-top: 0;
            width: 30px;
        }
        .heatmap-days span {
            height: 12px;
            line-height: 12px;
        }
        .heatmap-days span:nth-child(2n) {
            visibility: hidden;
        }
        .heatmap-grid {
            display: grid;
            grid-template-rows: repeat(7, 16px);
            grid-auto-flow: column;
            gap: 3px;
        }
        .heatmap-cell {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .heatmap-cell:hover {
            transform: scale(1.3);
            box-shadow: 0 0 8px rgba(0,255,157,0.5);
        }
        .heatmap-cell.level-0 { background: rgba(255,255,255,0.05); }
        .heatmap-cell.level-1 { background: rgba(0,255,157,0.2); }
        .heatmap-cell.level-2 { background: rgba(0,255,157,0.4); }
        .heatmap-cell.level-3 { background: rgba(0,255,157,0.6); }
        .heatmap-cell.level-4 { background: rgba(0,255,157,0.9); box-shadow: 0 0 5px rgba(0,255,157,0.3); }
        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            margin-top: 15px;
            font-size: 11px;
            color: var(--text-dim);
        }
        .heatmap-legend .heatmap-cell {
            cursor: default;
        }
        .heatmap-legend .heatmap-cell:hover {
            transform: none;
            box-shadow: none;
        }
        .heatmap-tooltip {
            position: fixed;
            background: var(--bg-dark);
            border: 1px solid var(--primary-color);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-main);
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .heatmap-tooltip strong {
            color: var(--success);
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 1024px) {
            .games-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .profile-hero { flex-direction: column; text-align: center; gap: 20px; }
            .profile-left { flex-direction: column; align-items: center; }
            .profile-avatar { width: 100px; height: 100px; }
            .profile-stats { justify-content: center; flex-wrap: wrap; }
        }

        @media screen and (max-width: 768px) {
            .container { padding: 10px !important; }
            
            .main-header { 
                flex-direction: column !important; 
                gap: 12px !important; 
                padding: 12px !important; 
                align-items: center !important;
            }
            .logo-area { order: 1; width: 100%; justify-content: center; }
            .main-nav { 
                order: 2; 
                flex-wrap: wrap !important; 
                justify-content: center !important; 
                gap: 6px !important; 
                width: 100%;
            }
            .header-controls { 
                order: 3; 
                flex-wrap: wrap !important; 
                justify-content: center !important; 
                gap: 6px !important; 
                width: 100% !important;
            }
            .nav-btn { padding: 6px 10px !important; font-size: 10px !important; }
            .nav-btn.primary { padding: 8px 16px !important; font-size: 11px !important; }
            .nav-menu-btn { padding: 6px 12px !important; font-size: 10px !important; }
            .nav-menu-dropdown { 
                position: fixed !important; 
                top: auto !important; 
                bottom: 0 !important; 
                left: 0 !important; 
                right: 0 !important; 
                border-radius: 20px 20px 0 0 !important; 
                min-width: 100% !important; 
                z-index: 9999 !important; 
            }
            
            .icon-btn { width: 34px !important; height: 34px !important; font-size: 13px !important; }
            .theme-select { padding: 5px 8px !important; font-size: 11px !important; max-width: 80px !important; }
            .header-xp-container { padding: 4px 8px !important; font-size: 10px !important; }
            
            .search-section { padding: 15px !important; min-height: auto !important; }
            .search-box { flex-direction: column !important; gap: 10px !important; max-width: 100% !important; }
            .search-input { 
                width: 100% !important; 
                max-width: none !important; 
                font-size: 14px !important; 
                padding: 14px 18px !important;
                padding-right: 50px !important;
            }
            .search-btn { 
                position: absolute !important;
                right: 5px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                width: 40px !important;
                height: 40px !important;
                padding: 0 !important;
            }
            
            .profile-hero { padding: 15px !important; flex-direction: column !important; text-align: center !important; }
            .profile-stats { gap: 8px !important; justify-content: center !important; flex-wrap: wrap !important; }
            .stat-item { min-width: 70px !important; padding: 8px !important; }
            .stat-value { font-size: 16px !important; }
            .stat-label { font-size: 9px !important; }
            
            .library-controls { flex-direction: column !important; gap: 10px !important; padding: 12px !important; }
            .filter-group { width: 100% !important; justify-content: center !important; flex-wrap: wrap !important; gap: 6px !important; }
            .filter-select, .filter-btn { flex: 1 1 auto !important; min-width: 70px !important; font-size: 10px !important; padding: 8px !important; }
            
            .games-grid { 
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)) !important; 
                gap: 10px !important; 
                padding: 10px !important; 
            }
            .game-card { min-height: 160px !important; }
            .game-title { font-size: 11px !important; }
            .game-stats { font-size: 9px !important; }
            
            .friends-list { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)) !important; }
            
            .achievements-modal { width: 95% !important; max-height: 85vh !important; padding: 15px !important; }
            .modal-header { flex-direction: column !important; gap: 15px !important; text-align: center !important; }
            .modal-game-cover { width: 100% !important; max-width: 200px !important; }
            .achievements-grid { grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)) !important; gap: 8px !important; }
            .achievement-item { padding: 8px !important; }
            .achievement-icon { width: 45px !important; height: 45px !important; }
            
            .signature-modal { width: 95% !important; padding: 15px !important; }
            .signature-preview { transform: scale(0.5) !important; transform-origin: top center !important; }
            
            .chart-modal { width: 95% !important; padding: 15px !important; }
            
            .site-title { font-size: 16px !important; }
            .logo-icon { font-size: 24px !important; }
            .profile-name { font-size: 18px !important; }
            
            .heatmap-container { overflow-x: auto !important; }
            .heatmap-grid { gap: 2px !important; }
            .heatmap-cell { width: 10px !important; height: 10px !important; }
            
            .ranking-container { flex-direction: column !important; }
            .ranking-col { width: 100% !important; }
            
            .showcase-section { padding: 15px !important; }
            .showcase-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }
            
            .section-title { font-size: 14px !important; padding: 8px 15px !important; }
        }

        @media screen and (max-width: 480px) {
            .main-header { padding: 10px !important; gap: 8px !important; }
            .site-title { font-size: 14px !important; }
            .logo-icon { font-size: 20px !important; }
            .nav-btn { padding: 5px 8px !important; font-size: 9px !important; }
            .nav-btn.primary { padding: 6px 12px !important; font-size: 10px !important; }
            .nav-menu-btn { padding: 5px 10px !important; font-size: 9px !important; }
            
            .header-controls { gap: 5px !important; }
            .icon-btn { width: 30px !important; height: 30px !important; font-size: 11px !important; }
            .theme-select { padding: 4px 6px !important; font-size: 10px !important; max-width: 70px !important; }
            .header-xp-container { display: none !important; }
            
            .search-input { font-size: 13px !important; padding: 12px 14px !important; padding-right: 45px !important; }
            .search-btn { width: 35px !important; height: 35px !important; }
            
            .games-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }
            .game-card { min-height: 140px !important; }
            .game-cover { height: 75px !important; }
            .game-info { padding: 8px !important; }
            .game-title { font-size: 10px !important; }
            
            .profile-avatar { width: 65px !important; height: 65px !important; }
            .profile-name { font-size: 16px !important; }
            .profile-header-row { flex-direction: column !important; gap: 10px !important; }
            .profile-actions { flex-wrap: wrap !important; justify-content: center !important; }
            .action-btn { font-size: 10px !important; padding: 6px 10px !important; }
            
            .stat-item { min-width: 55px !important; padding: 6px !important; }
            .stat-value { font-size: 14px !important; }
            .stat-label { font-size: 8px !important; }
            
            .achievements-grid { grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)) !important; }
            .achievement-icon { width: 38px !important; height: 38px !important; }
            
            .filter-group { gap: 4px !important; }
            .filter-select, .filter-btn { font-size: 9px !important; padding: 6px !important; min-width: 55px !important; }
            
            .showcase-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
            
            .toast { left: 10px !important; right: 10px !important; bottom: 10px !important; max-width: none !important; font-size: 12px !important; padding: 10px 15px !important; }
        }
    </style>
</head>
<body>
    
    <div id="dynamic-bg"></div>
    <div id="scan-progress-container"><div id="scan-progress-bar"></div></div>

    <!-- SCAN STATUS PANEL -->
    <div class="scan-status-panel" id="scanStatusPanel">
        <div class="scan-status-header">
            <span class="scan-status-title"><i class="fas fa-sync fa-spin"></i> ESCANEANDO</span>
            <button class="scan-status-close" onclick="closeScanPanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="scan-stats">
            <div class="scan-stat"><span class="scan-stat-label">Total:</span><span class="scan-stat-value" id="scanTotalAllGames">0</span></div>
            <div class="scan-stat"><span class="scan-stat-label">Sem Conquistas:</span><span class="scan-stat-value warning" id="scanNoAchievements">0</span></div>
            <div class="scan-stat"><span class="scan-stat-label">Analisados:</span><span class="scan-stat-value success" id="scanCompleted">0</span></div>
            <div class="scan-stat"><span class="scan-stat-label">Falharam:</span><span class="scan-stat-value error" id="scanFailed">0</span></div>
            <div class="scan-stat"><span class="scan-stat-label">Conquistas:</span><span class="scan-stat-value" id="scanAchievements">0</span></div>
            <div class="scan-stat"><span class="scan-stat-label">Cache:</span><span class="scan-stat-value" id="scanCacheSize">0 MB</span></div>
        </div>
        <div class="scan-actions">
            <button onclick="retryScanFailed()" id="retryBtn" disabled><i class="fas fa-redo"></i> Retry</button>
            <button onclick="pauseResumeScan()" id="pauseBtn"><i class="fas fa-pause"></i> Pausar</button>
            <button onclick="forceFullRefresh()" id="refreshBtn" title="Limpa cache e recarrega tudo"><i class="fas fa-trash-alt"></i> Limpar Cache</button>
        </div>
    </div>

    <div class="container">
        <header class="main-header">
            <div class="logo-area">
                <i class="fab fa-steam logo-icon"></i>
                <h1 class="site-title">SAE</h1>
            </div>
            <nav class="main-nav">
                <a href="index.html" class="nav-btn primary active"><i class="fas fa-gamepad"></i> <span data-i18n-key="nav_library">BIBLIOTECA</span></a>
                <div class="nav-menu-container">
                    <button class="nav-menu-btn"><i class="fas fa-bars"></i> MENU <i class="fas fa-chevron-down" style="font-size:8px;"></i></button>
                    <div class="nav-menu-dropdown">
                        <a href="hall.html"><i class="fas fa-trophy"></i> <span data-i18n-key="hall_title">Hall da Fama</span></a>
                        <a href="roleta.html"><i class="fas fa-dice"></i> <span data-i18n-key="nav_roulette">Roleta</span></a>
                        <a href="level.html"><i class="fas fa-star"></i> Level / XP</a>
                        <a href="prices.html"><i class="fas fa-chart-line"></i> <span data-i18n-key="prices_title">Hist√≥rico Pre√ßos</span></a>
                        <a href="compare.html"><i class="fas fa-users"></i> <span data-i18n-key="compare_title">Comparar Perfis</span></a>
                        <a href="museum.html"><i class="fas fa-landmark"></i> Museu 3D</a>
                        <a href="wallpaper.html"><i class="fas fa-image"></i> <span data-i18n-key="nav_wallpaper">Wallpaper</span></a>
                        <a href="desafio.html"><i class="fas fa-calendar-check"></i> <span data-i18n-key="challenge_title">Desafio Di√°rio</span></a>
                        <a href="timeline.html"><i class="fas fa-clock-rotate-left"></i> <span data-i18n-key="nav_timeline">Timeline</span></a>
                        <a href="hardware_check.html"><i class="fas fa-microchip"></i> <span data-i18n-key="nav_hardware">Hardware Lab</span></a>
                        <a href="wrapped.html"><i class="fas fa-gift"></i> Wrapped</a>
                    </div>
                </div>
            </nav>
            <div class="header-controls">
                <a href="level.html" class="header-xp-container" id="headerXpContainer" style="display:none;" title="Ver detalhes do n√≠vel">
                    <span class="header-lvl-badge" id="hLvl">Lv 1</span>
                    <div class="header-xp-bar"><div class="header-xp-fill" id="hBar"></div></div>
                    <span class="header-xp-text" id="hText">0 XP</span>
                </a>
                <button class="icon-btn" onclick="openVersusModal()" title="Versus"><i class="fas fa-fist-raised"></i></button>
                <button class="icon-btn" onclick="openMonthlyGoalModal()" title="Meta Mensal"><i class="fas fa-bullseye"></i></button>
                <button class="icon-btn" onclick="openDiscordModal()" title="Compartilhar no Discord"><i class="fab fa-discord"></i></button>
                <select id="themeSelector" onchange="changeTheme(this.value)" class="theme-select">
                    <option value="default">üéÆ Padr√£o</option>
                    <option value="rgb">üåà RGB</option>
                    <option value="retro">üëæ Retr√¥</option>
                    <option value="light">‚òÄÔ∏è Claro</option>
                    <option value="dark">üåô Escuro</option>
                </select>
                <select id="langSelector" onchange="changeLanguage(this.value)" class="theme-select" title="Idioma">
                    <option value="pt">üáßüá∑ PT</option>
                    <option value="en">üá∫üá∏ EN</option>
                    <option value="es">üá™üá∏ ES</option>
                    <option value="fr">üá´üá∑ FR</option>
                    <option value="de">üá©üá™ DE</option>
                    <option value="ru">üá∑üá∫ RU</option>
                    <option value="ja">üáØüáµ JA</option>
                    <option value="zh">üá®üá≥ ZH</option>
                </select>
                <button class="icon-btn seasonal-btn" id="seasonalToggleBtn" onclick="toggleSeasonalTheme()" title="Efeitos sazonais">
                    <i class="fas fa-snowflake" id="seasonalIcon"></i>
                </button>
                <button class="icon-btn" onclick="openSignatureModal()" title="Gerar Card"><i class="fas fa-camera"></i></button>
            </div>
        </header>

        <section class="search-section" id="searchSection">
            <div class="search-box">
                <input type="text" class="search-input" id="steamInput" placeholder="Steam ID, URL ou Custom URL...">
                <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
            </div>
        </section>

        <div id="loader" class="hidden"><span class="loader"></span></div>

        <main id="profileContent" class="hidden">
            <section class="profile-hero">
                <div class="profile-avatar-wrapper">
                    <img src="" alt="Avatar" id="userAvatar" class="profile-avatar">
                </div>
                <div class="profile-info">
                    <div class="profile-header-row">
                        <h1><span id="userNameText">Usu√°rio</span> <span id="hunterTitle" class="hunter-title"></span> <span id="oldSchoolBadge" class="oldschool-user-badge" style="display:none;"><i class="fas fa-medal"></i> OLD SCHOOL</span></h1>
                        <div class="profile-actions">
                            <button class="action-btn" onclick="refreshData()"><i class="fas fa-sync-alt"></i> Atualizar</button>
                            <div class="share-dropdown">
                                <button class="action-btn share-btn" onclick="toggleShareMenu(event)"><i class="fas fa-share-alt"></i> Compartilhar</button>
                                <div class="share-menu" id="shareMenu">
                                    <a href="#" onclick="shareTwitter()" class="share-item twitter"><i class="fab fa-twitter"></i> Twitter</a>
                                    <a href="#" onclick="shareDiscord()" class="share-item discord"><i class="fab fa-discord"></i> Discord</a>
                                    <a href="#" onclick="copyProfileLink()" class="share-item copy"><i class="fas fa-link"></i> Copiar Link</a>
                                    <a href="profile.html" id="publicProfileLink" class="share-item profile"><i class="fas fa-user"></i> Perfil P√∫blico</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item"><span class="stat-value blue" id="totalGames">0</span><span class="stat-label" data-i18n-key="totalGames">Jogos Totais</span></div>
                        <div class="stat-item"><span class="stat-value gold" id="totalPlatinum">0</span><span class="stat-label" data-i18n-key="platinas">Platinas</span></div>
                        <div class="stat-item"><span class="stat-value purple" id="totalAchievements">0</span><span class="stat-label" data-i18n-key="achievements">Conquistas</span></div>
                        <div class="stat-item"><span class="stat-value" id="completionRate">0%</span><span class="stat-label" data-i18n-key="globalAverage">M√©dia Global</span></div>
                    </div>
                </div>
            </section>
            
            <!-- SHOWCASE SECTION -->
            <section class="showcase-section" id="showcaseSection">
                <h2 class="section-title" style="color:var(--warning); border-color:var(--warning)" data-i18n-key="ultraRareShowcase">Destaques Ultra Raros</h2>
                <div class="showcase-grid" id="showcaseGrid"></div>
            </section>
            
            <!-- HEATMAP CALENDAR -->
            <section class="heatmap-section" id="heatmapSection" style="display:none;">
                <div class="heatmap-header">
                    <h2 class="section-title" style="color:var(--success); border-color:var(--success)">
                        <i class="fas fa-calendar-alt"></i> <span data-i18n-key="achievementActivity">Atividade de Conquistas</span>
                    </h2>
                    <div class="heatmap-stats">
                        <span id="heatmapTotal">0 conquistas</span>
                        <span id="heatmapStreak">üî• 0 dias de streak</span>
                    </div>
                </div>
                <div class="heatmap-container">
                    <div class="heatmap-months" id="heatmapMonths"></div>
                    <div class="heatmap-grid-wrapper">
                        <div class="heatmap-days">
                            <span data-i18n-key="daySun">Dom</span><span data-i18n-key="dayMon">Seg</span><span data-i18n-key="dayTue">Ter</span><span data-i18n-key="dayWed">Qua</span><span data-i18n-key="dayThu">Qui</span><span data-i18n-key="dayFri">Sex</span><span data-i18n-key="daySat">S√°b</span>
                        </div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                </div>
                <div class="heatmap-legend">
                    <span data-i18n-key="less">Menos</span>
                    <div class="heatmap-cell level-0" title="0 conquistas"></div>
                    <div class="heatmap-cell level-1" title="1-2 conquistas"></div>
                    <div class="heatmap-cell level-2" title="3-5 conquistas"></div>
                    <div class="heatmap-cell level-3" title="6-9 conquistas"></div>
                    <div class="heatmap-cell level-4" title="10+ conquistas"></div>
                    <span data-i18n-key="more">Mais</span>
                </div>
            </section>

            <section>
                <div class="library-header">
                    <div style="display:flex; align-items:center; gap:20px;">
                        <h2 class="section-title" data-i18n-key="library">Biblioteca</h2>
                        <div class="soundtrack-toggle" id="soundtrackToggle" onclick="toggleSoundtrackMode()" data-i18n-title="soundtrackToggle" title="Ativar/Desativar trilha sonora ao passar o mouse nos jogos">
                            <i class="fas fa-music toggle-icon"></i>
                            <span class="toggle-text">OST</span>
                        </div>
                    </div>
                    <div class="library-controls">
                        <input type="text" id="gameSearchInput" class="game-search-input" data-i18n-placeholder="filterGame" placeholder="Filtrar jogo..." oninput="filterGames()">
                        <select id="sortSelect" class="filter-select" onchange="sortGames()">
                            <option value="playtime" data-i18n-key="sortPlaytime">Tempo de Jogo</option>
                            <option value="completion" data-i18n-key="sortCompletion">% Completo</option>
                            <option value="name" data-i18n-key="sortName">Nome (A-Z)</option>
                        </select>
                        <div class="filter-group" style="display:flex; gap:5px;">
                            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')" data-i18n-key="filterAll">TODOS</button>
                            <button class="filter-btn" data-filter="platinado" onclick="setFilter('platinado')" data-i18n-key="filterPlatinado">PLATINADOS</button>
                            <button class="filter-btn" data-filter="platinando" onclick="setFilter('platinando')" data-i18n-key="filterPlatinando">PLATINANDO</button>
                        </div>
                    </div>
                </div>
                <div class="games-grid" id="gamesGrid"></div>
            </section>

            <section>
                <div class="friends-header">
                    <h2 class="section-title" style="margin-bottom:0;" data-i18n-key="friends">Amigos</h2>
                    <input type="text" id="friendSearchInput" class="friend-search-input" data-i18n-placeholder="searchFriend" placeholder="Buscar amigo..." oninput="filterFriends()">
                </div>
                <div class="friends-container" id="friendsContainer"></div>
                
                <!-- RANKING TABLES -->
                <div class="ranking-section">
                    <h3 style="margin-bottom:20px; font-family:var(--font-display);" data-i18n-key="friendsRanking">Ranking de Amigos</h3>
                    <div class="ranking-grid">
                        <div class="ranking-col">
                            <div class="ranking-header"><span class="ranking-title"><i class="fas fa-gamepad"></i> Maior Biblioteca <span id="rankGamesLoader" class="ranking-loader"><i class="fas fa-spinner fa-spin"></i></span></span></div>
                            <div class="scrollable-table"><table class="rank-table"><thead><tr><th>#</th><th>Amigo</th><th>Jogos</th></tr></thead><tbody id="rankGamesBody"></tbody></table></div>
                        </div>
                        <div class="ranking-col">
                            <div class="ranking-header"><span class="ranking-title"><i class="fas fa-clock"></i> Mais Viciado <span id="rankTimeLoader" class="ranking-loader"><i class="fas fa-spinner fa-spin"></i></span></span></div>
                            <div class="scrollable-table"><table class="rank-table"><thead><tr><th>#</th><th>Amigo</th><th>Horas</th></tr></thead><tbody id="rankTimeBody"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="achievementModal">
        <div class="achievements-modal">
            <div class="modal-header">
                <div>
                    <h2 class="modal-game-title" id="modalGameTitle">Carregando...</h2>
                    <div class="modal-tabs">
                        <button class="modal-tab-btn active" onclick="filterModal('all')">TODAS</button>
                        <button class="modal-tab-btn" onclick="filterModal('unlocked')">DESBLOQUEADAS</button>
                        <button class="modal-tab-btn" onclick="filterModal('locked')">BLOQUEADAS</button>
                    </div>
                </div>
                <div class="modal-controls">
                    <button class="icon-btn soundtrack-btn" id="soundtrackBtn" onclick="toggleSoundtrack()" title="Tocar Soundtrack">
                        <i class="fas fa-music" id="soundtrackIcon"></i>
                    </button>
                    <button class="close-modal-btn" id="closeModalBtn"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="modal-body">
                <div id="modalLoader" class="modal-loader"><span class="loader"></span><p>Analisando dados...</p><button class="action-btn" onclick="retryModalLoad()" style="margin-top:15px;">Tentar Novamente</button></div>
                <div class="achievements-list hidden" id="achievementsList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="versusModal">
        <div class="versus-modal">
            <div class="versus-header">BATTLE ARENA</div>
            <div class="versus-inputs">
                <input type="text" id="vsInput1" class="search-input" placeholder="ID Player 1 (Voc√™)">
                <span style="align-self:center; font-weight:bold; color:var(--danger)">VS</span>
                <input type="text" id="vsInput2" class="search-input" placeholder="ID Player 2 (Oponente)">
            </div>
            <div style="text-align:center; margin-bottom:20px;"><button class="search-btn" onclick="runVersus()" style="position:static; transform:none; width:100%; border-radius:10px;">INICIAR BATALHA</button></div>
            <div class="versus-content" id="versusContent"></div>
            <div id="tugContainer" style="display:none; margin-top:20px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#ccc; margin-bottom:5px;"><span>Player 1 Total</span><span>Player 2 Total</span></div>
                <div class="tug-of-war"><div class="tug-bar-p1" id="tugBarP1" style="width:50%"></div><div class="tug-bar-p2"></div><div class="tug-icon" style="left:50%"><i class="fas fa-caret-up"></i></div></div>
            </div>
            <button class="action-btn" style="align-self:center; margin-top:20px;" onclick="document.getElementById('versusModal').classList.remove('open')">Fechar</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="chartsModal">
        <div class="chart-modal">
            <div class="modal-header" style="border:none; padding:0 0 20px 0;">
                <h2 class="modal-game-title">An√°lise de Dados</h2>
                <button class="close-modal-btn" onclick="document.getElementById('chartsModal').classList.remove('open')"><i class="fas fa-times"></i></button>
            </div>
            <div class="charts-grid">
                <div class="chart-container"><h4 style="text-align:center; margin-bottom:10px;">Status da Biblioteca</h4><canvas id="gamesPieChart"></canvas></div>
                <div class="chart-container"><h4 style="text-align:center; margin-bottom:10px;">Top Jogos por Tempo</h4><canvas id="playtimeBarChart"></canvas></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="signatureModal">
        <div class="signature-modal">
            <div class="modal-header" style="padding:10px 0; border:none;">
                <h2 class="modal-game-title">Criar Card</h2>
                <button class="close-modal-btn" onclick="document.getElementById('signatureModal').classList.remove('open')"><i class="fas fa-times"></i></button>
            </div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <label style="font-family:var(--font-body); font-size:14px;">Escolha o Jogo de Fundo:</label>
                <select id="sigGameSelect" class="filter-select" onchange="updateSignaturePreview(this.value)"></select>
            </div>
            <div class="sig-preview-container">
                <div id="signature-card-element">
                    <div class="sig-bg" id="sigBg"></div>
                    <div class="sig-top">
                        <div class="sig-content">
                            <img id="sigAvatar" class="sig-avatar" src="">
                            <div class="sig-info">
                                <h2 id="sigName">USER</h2>
                                <div class="sig-stats">
                                    <div class="sig-stat" style="color:#00f3ff"><i class="fas fa-gamepad"></i> <span id="sigGames">0</span></div>
                                    <div class="sig-stat" style="color:#ffd700"><i class="fas fa-trophy"></i> <span id="sigPlat">0</span></div>
                                    <div class="sig-stat" style="color:#bc13fe"><i class="fas fa-medal"></i> <span id="sigAch">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="sig-game-section" id="sigGameSection">
                        <div class="sig-game-name" id="sigGameName">Nome do Jogo</div>
                        <div class="sig-game-row"><span id="sigGameProg">0/0</span><span id="sigGamePct">0%</span></div>
                        <div class="sig-progress-bg"><div class="sig-progress-fill" id="sigGameBar" style="width:0%"></div></div>
                    </div>
                    <div class="sig-watermark">Steam Explorer</div>
                </div>
            </div>
            <div class="sig-controls"><button class="action-btn" onclick="downloadSignature()"><i class="fas fa-download"></i> Baixar Imagem</button></div>
        </div>
    </div>

    <!-- Modal Meta Mensal -->
    <div class="modal-overlay" id="monthlyGoalModal">
        <div class="monthly-goal-modal" style="width: 90%; max-width: 500px; background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--primary-color); padding: 25px;">
            <div class="modal-header" style="padding:10px 0; border:none; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-family: var(--font-display); color: var(--primary-color);"><i class="fas fa-bullseye"></i> Meta Mensal</h2>
                <button class="close-modal-btn" onclick="document.getElementById('monthlyGoalModal').classList.remove('open')"><i class="fas fa-times"></i></button>
            </div>
            <div id="monthlyGoalContent">
                <div style="text-align:center; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--text-dim);">Dezembro 2025</div>
                    <div id="goalProgressRing" style="width: 150px; height: 150px; margin: 20px auto; position: relative;">
                        <svg width="150" height="150" style="transform: rotate(-90deg);">
                            <circle cx="75" cy="75" r="65" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="10"/>
                            <circle id="goalProgressCircle" cx="75" cy="75" r="65" fill="none" stroke="var(--primary-color)" stroke-width="10" stroke-dasharray="408" stroke-dashoffset="408" style="transition: stroke-dashoffset 1s;"/>
                        </svg>
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;">
                            <div id="goalCurrentValue" style="font-size:28px; font-weight:bold; color:var(--primary-color);">0</div>
                            <div id="goalLabel" style="font-size:12px; color:var(--text-dim);">de 10</div>
                        </div>
                    </div>
                </div>
                <div style="display: grid; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div>
                            <div style="font-weight: bold;">üèÜ Platinas este m√™s</div>
                            <div style="font-size: 12px; color: var(--text-dim);">Meta: conquistar platinas</div>
                        </div>
                        <input type="number" id="goalPlatinumTarget" value="5" min="1" max="50" style="width: 60px; padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: var(--text-main); text-align: center;">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div>
                            <div style="font-weight: bold;">‚≠ê Conquistas este m√™s</div>
                            <div style="font-size: 12px; color: var(--text-dim);">Meta: desbloquear conquistas</div>
                        </div>
                        <input type="number" id="goalAchievementTarget" value="50" min="1" max="500" style="width: 60px; padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: var(--text-main); text-align: center;">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                        <div>
                            <div style="font-weight: bold;">‚è±Ô∏è Horas jogadas</div>
                            <div style="font-size: 12px; color: var(--text-dim);">Meta: jogar horas</div>
                        </div>
                        <input type="number" id="goalHoursTarget" value="30" min="1" max="200" style="width: 60px; padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: var(--text-main); text-align: center;">
                    </div>
                </div>
                <button onclick="saveMonthlyGoals()" style="width: 100%; margin-top: 20px; padding: 15px; border-radius: 10px; border: none; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #000; font-weight: bold; cursor: pointer;">
                    <i class="fas fa-save"></i> Salvar Metas
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Discord -->
    <div class="modal-overlay" id="discordModal">
        <div class="discord-modal" style="width: 90%; max-width: 500px; background: var(--bg-panel); border-radius: 20px; border: 1px solid #5865F2; padding: 25px;">
            <div class="modal-header" style="padding:10px 0; border:none; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-family: var(--font-display); color: #5865F2;"><i class="fab fa-discord"></i> Compartilhar no Discord</h2>
                <button class="close-modal-btn" onclick="document.getElementById('discordModal').classList.remove('open')"><i class="fas fa-times"></i></button>
            </div>
            <div id="discordContent">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-dim);">Webhook URL do Discord</label>
                    <input type="text" id="discordWebhook" placeholder="https://discord.com/api/webhooks/..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: var(--text-main);">
                    <div style="font-size: 11px; color: var(--text-dim); margin-top: 5px;">Cole a URL do webhook do seu canal do Discord</div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-dim);">O que compartilhar?</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="discordShareType" value="profile" checked style="accent-color: #5865F2;"> Resumo do Perfil
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="discordShareType" value="platinum" style="accent-color: #5865F2;"> √öltima Platina
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="discordShareType" value="stats" style="accent-color: #5865F2;"> Estat√≠sticas Completas
                        </label>
                    </div>
                </div>
                <div id="discordPreview" style="background: #36393f; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px;">
                        <div style="width: 4px; background: #5865F2; border-radius: 2px;"></div>
                        <div>
                            <div style="font-weight: bold; color: #fff; margin-bottom: 5px;" id="discordPreviewTitle">üéÆ Steam Achievements Explorer</div>
                            <div style="color: #dcddde; font-size: 13px;" id="discordPreviewBody">
                                <strong>Jogador:</strong> <span id="discordPlayerName">-</span><br>
                                <strong>Platinas:</strong> <span id="discordPlatinas">-</span><br>
                                <strong>Conquistas:</strong> <span id="discordConquistas">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="sendToDiscord()" style="width: 100%; padding: 15px; border-radius: 10px; border: none; background: #5865F2; color: #fff; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fab fa-discord"></i> Enviar para Discord
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // ATEN√á√ÉO: Para uso em produ√ß√£o (faculdade/portfolio), o ideal √© usar "http://localhost/SAE/api.php"
        // mas para garantir que funcione AGORA nesta pr√©-visualiza√ß√£o sem servidor, voltamos ao modo direto.
        const STEAM_API_KEY = '8B07FE7C9405216BF61C1F439E93922B'; 
        const PROXY_LIST = ['https://api.allorigins.win/raw?url=', 'https://corsproxy.io/?', 'https://thingproxy.freeboard.io/fetch/', 'https://api.codetabs.com/v1/proxy?quest='];
        
        let currentState = {
            userId: null, user: null, games: [], friends: [], friendsData: [],
            activeFilter: 'all', modalFilter: 'all',
            stats: { totalPlatinum: 0, totalAchievementsUnlocked: 0, sumPercentages: 0, gamesCounted: 0, totalPlayableGames: 0 },
            currentModalGame: null,
            scanPaused: false,
            failedGames: [],
            useCache: true,  // Usar cache IndexedDB
            cacheLoaded: false, // Cache carregado?
        };
        let fetchQueue = []; let activeRequests = 0; const MAX_CONCURRENT_REQUESTS = 15; // Aumentado para scan mais r√°pido
        let friendFetchQueue = []; let activeFriendRequests = 0;

        // HowLongToBeat - Cache local e busca din√¢mica via API
        const hltbCache = JSON.parse(localStorage.getItem('hltbCache') || '{}');
        const hltbPending = {}; // Jogos sendo buscados no momento
        
        // Fallback est√°tico para jogos muito populares (evita requisi√ß√µes desnecess√°rias)
        const hltbFallback = {
            72850: [34, 232], 489830: [34, 232], 1245620: [50, 130], 292030: [51, 173],
            1091500: [24, 100], 1174180: [50, 180], 271590: [32, 83], 377160: [27, 157],
            1086940: [75, 160], 367520: [27, 65], 1145360: [22, 97], 814380: [25, 70],
            374320: [32, 96], 570940: [25, 43], 1593500: [21, 53], 1151640: [22, 60],
            413150: [52, 170], 105600: [55, 200], 620: [9, 26], 400: [8, 15]
        };
        
        // Fun√ß√£o para obter tempo HLTB (primeiro do cache, depois fallback)
        function getHLTB(appid) {
            // 1. Tentar cache local
            if (hltbCache[appid] && hltbCache[appid].main > 0) {
                return { main: hltbCache[appid].main, complete: hltbCache[appid].complete };
            }
            // 2. Tentar fallback est√°tico
            const fallback = hltbFallback[appid];
            if (fallback && fallback[0] > 0) {
                return { main: fallback[0], complete: fallback[1] };
            }
            return null;
        }
        
        // Busca HLTB do servidor e atualiza o card dinamicamente
        async function fetchHLTB(appid, gameName, cardElement) {
            // Evitar requisi√ß√µes duplicadas
            if (hltbPending[appid]) return;
            if (hltbCache[appid]) return;
            
            hltbPending[appid] = true;
            
            try {
                // Limpar nome do jogo para busca
                const cleanName = gameName
                    .replace(/[‚Ñ¢¬Æ¬©]/g, '')
                    .replace(/\s*[-‚Äì‚Äî:]\s*(Definitive|Special|Complete|GOTY|Game of the Year|Remastered|Enhanced|Anniversary|Ultimate|Deluxe|Gold|Premium|Standard|Legacy|Extended|Director's Cut).*$/i, '')
                    .replace(/\s*\(.*?\)/g, '')
                    .trim();
                
                const response = await fetch(`http://localhost:3000/api/hltb/appid/${appid}?name=${encodeURIComponent(cleanName)}`);
                const data = await response.json();
                
                if (data.found && data.mainStory > 0) {
                    // Salvar no cache
                    hltbCache[appid] = {
                        main: data.mainStory,
                        complete: data.completionist || data.mainStory * 2
                    };
                    localStorage.setItem('hltbCache', JSON.stringify(hltbCache));
                    
                    // Atualizar o card se existir
                    if (cardElement) {
                        const metaRight = cardElement.querySelector('.game-meta-right');
                        if (!metaRight) {
                            const metaDiv = cardElement.querySelector('.game-meta');
                            if (metaDiv) {
                                const hltbDiv = document.createElement('div');
                                hltbDiv.className = 'game-meta-right';
                                hltbDiv.innerHTML = `
                                    <span class="hltb-label"><i class="fas fa-stopwatch"></i> HLTB</span>
                                    <span class="hltb-time" title="${t('hltbMain') || 'Zerar'}: ${hltbCache[appid].main}h | ${t('hltb100') || '100%'}: ${hltbCache[appid].complete}h">üéÆ ${hltbCache[appid].main}h | üèÜ ${hltbCache[appid].complete}h</span>
                                `;
                                metaDiv.appendChild(hltbDiv);
                            }
                        }
                    }
                }
            } catch (e) {
                // Servidor n√£o dispon√≠vel, ignora silenciosamente
            } finally {
                delete hltbPending[appid];
            }
        }
        
        // Buscar HLTB para todos os jogos vis√≠veis (com throttle)
        let hltbFetchQueue = [];
        let hltbFetching = false;
        
        async function processHLTBQueue() {
            if (hltbFetching || hltbFetchQueue.length === 0) return;
            hltbFetching = true;
            
            while (hltbFetchQueue.length > 0) {
                const { appid, name, card } = hltbFetchQueue.shift();
                await fetchHLTB(appid, name, card);
                await new Promise(r => setTimeout(r, 300)); // 300ms entre requisi√ß√µes
            }
            
            hltbFetching = false;
        }
        
        function queueHLTBFetch(appid, gameName, cardElement) {
            // S√≥ adicionar se n√£o tiver no cache e n√£o estiver na fila
            if (hltbCache[appid] || hltbFallback[appid]) return;
            if (hltbFetchQueue.some(q => q.appid === appid)) return;
            
            hltbFetchQueue.push({ appid, name: gameName, card: cardElement });
            processHLTBQueue();
        }

        window.onload = () => { loadFromHistory(); setupEventListeners(); };

        function setupEventListeners() {
            document.getElementById('searchBtn').addEventListener('click', () => handleSearch());
            document.getElementById('steamInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSearch(); });
            document.getElementById('closeModalBtn').addEventListener('click', closeGameModal);
            document.getElementById('achievementModal').addEventListener('click', (e) => { if(e.target === document.getElementById('achievementModal')) closeGameModal(); });
        }

        // --- API CORE ---
        async function fetchFromSteam(endpoint, params = {}, retries = 4) {
            let url = `https://api.steampowered.com/${endpoint}/?key=${STEAM_API_KEY}`;
            for (const [key, value] of Object.entries(params)) url += `&${key}=${value}`;
            url += `&_=${new Date().getTime()}`; 
            
            for (const proxyBase of PROXY_LIST) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout
                    const response = await fetch(proxyBase + encodeURIComponent(url), { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`Status ${response.status}`);
                    return await response.json();
                } catch (e) {
                    // Continua para pr√≥ximo proxy
                }
            }
            if (retries > 0) { 
                await new Promise(r => setTimeout(r, 800 + Math.random() * 400)); // Delay aleat√≥rio para evitar rate limit
                return fetchFromSteam(endpoint, params, retries - 1); 
            }
            throw new Error("Falha na conex√£o com a Steam API.");
        }

        // --- MAIN SEARCH ---
        async function handleSearch(isRefresh = false, forceRefresh = false) {
            let input = isRefresh && currentState.userId ? currentState.userId : document.getElementById('steamInput').value.trim();
            if (!input) return showToast('Digite um Steam ID ou URL', 'warning');
            if(!isRefresh) { document.getElementById('profileContent').classList.add('hidden'); document.getElementById('searchSection').classList.add('active'); document.getElementById('loader').classList.remove('hidden'); } else { document.getElementById('profileContent').style.opacity = '0.5'; }
            
            try {
                resetGlobalStats();
                let steamId = input;
                if (isNaN(input)) {
                    let vanity = input.includes('/id/') ? input.split('/id/')[1].split('/')[0] : input;
                    const res = await fetchFromSteam('ISteamUser/ResolveVanityURL/v0001', { vanityurl: vanity });
                    if (res.response && res.response.success === 1) steamId = res.response.steamid;
                    else throw new Error("Usu√°rio n√£o encontrado.");
                }
                currentState.userId = steamId; saveToHistory(steamId);
                
                // ===== VERIFICAR CACHE PRIMEIRO =====
                if (currentState.useCache && !forceRefresh && window.SteamCache) {
                    const cachedGames = await SteamCache.getGames(steamId);
                    const cachedProfile = await SteamCache.getProfile(steamId);
                    
                    if (cachedGames.length > 0 && cachedProfile) {
                        console.log('üì¶ Carregando do cache...');
                        currentState.cacheLoaded = true;
                        currentState.user = cachedProfile;
                        currentState.games = cachedGames.map(g => ({
                            ...g,
                            header_image: g.header_image || `https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/${g.appid}/header.jpg`,
                            playtime_hours: (g.playtime_forever / 60).toFixed(1)
                        }));
                        currentState.games.sort((a,b) => b.playtime_forever - a.playtime_forever);
                        
                        // Salvar tamb√©m no localStorage para outras p√°ginas
                        localStorage.setItem('currentProfile', JSON.stringify(currentState.user));
                        localStorage.setItem('currentGames', JSON.stringify(currentState.games));
                        
                        // Mostrar dados do cache imediatamente
                        if(currentState.games.length > 0) setDynamicBackground(currentState.games[0].appid);
                        
                        // Reset e carregar amigos
                        currentState.friends = []; currentState.friendsData = [];
                        document.getElementById('friendsContainer').innerHTML = '';
                        document.getElementById('rankGamesBody').innerHTML = ''; 
                        document.getElementById('rankTimeBody').innerHTML = '';
                        friendFetchQueue = []; activeFriendRequests = 0;
                        fetchFriends(steamId);
                        
                        renderProfile(); 
                        renderGamesGridFromCache(); // Renderiza com dados do cache
                        
                        document.getElementById('loader').classList.add('hidden'); 
                        document.getElementById('profileContent').classList.remove('hidden'); 
                        document.getElementById('profileContent').style.opacity = '1';
                        
                        // Buscar atualiza√ß√µes em background
                        syncFromSteamInBackground(steamId);
                        return;
                    }
                }
                
                // ===== BUSCAR DA STEAM API =====
                const profileRes = await fetchFromSteam('ISteamUser/GetPlayerSummaries/v0002', { steamids: steamId });
                currentState.user = profileRes.response.players[0];
                
                // Salvar perfil no cache
                if (window.SteamCache) {
                    await SteamCache.saveProfile(currentState.user);
                }
                
                // Salvar perfil no localStorage para outras p√°ginas (wallpaper, museum, etc)
                localStorage.setItem('currentProfile', JSON.stringify(currentState.user));
                
                const gamesRes = await fetchFromSteam('IPlayerService/GetOwnedGames/v0001', { steamid: steamId, include_appinfo: true, format: 'json' });
                if (!gamesRes.response || !gamesRes.response.games) throw new Error("Perfil privado.");
                currentState.games = gamesRes.response.games.map(g => ({ ...g, header_image: `https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/${g.appid}/header.jpg`, playtime_hours: (g.playtime_forever / 60).toFixed(1), percent: -1, unlocked: 0, total: 0 }));
                currentState.games.sort((a,b) => b.playtime_forever - a.playtime_forever);
                
                // Salvar jogos no cache
                if (window.SteamCache) {
                    await SteamCache.saveGames(steamId, currentState.games);
                }
                
                // Salvar jogos no localStorage para outras p√°ginas
                localStorage.setItem('currentGames', JSON.stringify(currentState.games));
                
                if(currentState.games.length > 0) setDynamicBackground(currentState.games[0].appid);
                
                // Reset Friends
                currentState.friends = []; currentState.friendsData = [];
                document.getElementById('rankGamesBody').innerHTML = ''; document.getElementById('rankTimeBody').innerHTML = '';
                friendFetchQueue = []; activeFriendRequests = 0;

                fetchFriends(steamId); 
                renderProfile(); renderGamesGrid();
                document.getElementById('loader').classList.add('hidden'); document.getElementById('profileContent').classList.remove('hidden'); document.getElementById('profileContent').style.opacity = '1';
            } catch (error) { console.error(error); showToast(error.message, 'error'); document.getElementById('loader').classList.add('hidden'); document.getElementById('profileContent').style.opacity = '1'; }
        }
        
        // Renderiza grid usando dados do cache (sem scanning)
        function renderGamesGridFromCache() {
            const grid = document.getElementById('gamesGrid');
            grid.innerHTML = ''; 
            fetchQueue = []; 
            activeRequests = 0;
            currentState.failedGames = [];
            currentState.scanPaused = false;
            
            // Contar jogos com stats j√° no cache
            let gamesWithStats = 0;
            let totalPlayable = 0;
            
            currentState.games.forEach(game => {
                const card = document.createElement('div'); 
                card.className = 'game-card'; 
                card.id = `game-${game.appid}`; 
                card.dataset.percent = game.percent; 
                card.dataset.name = game.name.toLowerCase();
                card.onmouseenter = () => setDynamicBackground(game.appid);
                
                let loadingState = '', pctText = '', progText = '', width = '0%';
                
                if (game.percent !== -1 && game.percent !== undefined) { 
                    pctText = `${game.percent}%`; 
                    progText = `${game.unlocked}/${game.total}`; 
                    width = `${game.percent}%`; 
                    gamesWithStats++;
                    totalPlayable++; // Jogo com conquistas j√° carregadas
                    if (game.percent === 100) card.classList.add('platinum'); 
                    else if (game.percent >= 70) card.classList.add('platinando'); 
                } else if (game.has_community_visible_stats) { 
                    loadingState = '<i class="fas fa-database" style="color:var(--primary-color)" title="Precisa sincronizar"></i>'; 
                    totalPlayable++; // Jogo com conquistas que precisa sincronizar
                    fetchQueue.push(game.appid);
                } else { 
                    loadingState = 'N/A'; // Jogo sem conquistas
                }
                
                // HLTB data
                const hltb = getHLTB(game.appid);
                let hltbHtml = '';
                if (hltb) {
                    hltbHtml = `<div class="game-meta-right">
                        <span class="hltb-label"><i class="fas fa-stopwatch"></i> HLTB</span>
                        <span class="hltb-time" title="${t('hltbMain') || 'Hist√≥ria principal'}: ${hltb.main}h | ${t('hltb100') || '100%'}: ${hltb.complete}h">üéÆ ${hltb.main}h | üèÜ ${hltb.complete}h</span>
                    </div>`;
                }
                
                card.innerHTML = `<div class="platinum-badge" style="${game.percent === 100 ? 'display:block' : ''}"><i class="fas fa-trophy"></i> 100%</div><div class="platinando-badge" style="${(game.percent >= 70 && game.percent < 100) ? 'display:block' : ''}"><i class="fas fa-running"></i> ${t('inProgress') || 'Platinando'}</div><img data-src="${game.header_image}" class="game-banner lazy-img" loading="lazy" onerror="this.src='https://placehold.co/600x300/111/FFF?text=No+Image'"><div class="game-details"><div class="game-title">${game.name}</div><div class="game-meta"><div class="game-meta-left"><span><i class="fas fa-clock"></i> ${game.playtime_hours}h ${t('hoursPlayed') || 'jogadas'}</span></div>${hltbHtml}</div><div class="game-progress-info" id="prog-${game.appid}">${loadingState}</div><div class="game-progress-bar-bg"><div class="game-progress-bar-fill" id="bar-${game.appid}" style="width:${width}"></div></div><div class="game-stats-row"><span id="txt-prog-${game.appid}">${progText}</span><span id="txt-pct-${game.appid}">${pctText}</span></div></div>`;
                card.onclick = () => openGameModal(game); 
                grid.appendChild(card);
                
                // Se n√£o tem HLTB no cache, buscar dinamicamente do servidor
                if (!hltb) {
                    queueHLTBFetch(game.appid, game.name, card);
                }
            });
            
            initLazyLoading(); // Iniciar lazy loading
            
            // Re-anexar listeners de soundtrack se o modo estiver ativo
            if (isSoundtrackModeEnabled) {
                attachSoundtrackListeners();
            }
            
            currentState.stats.totalPlayableGames = totalPlayable;
            currentState.stats.gamesCounted = gamesWithStats;
            
            // Recalcular stats com dados do cache
            recalculateTotalStats();
            
            // Se tem jogos para atualizar, mostrar painel
            if (fetchQueue.length > 0) {
                document.getElementById('scan-progress-container').style.display = 'block';
                showScanPanel();
                
                // Atualizar t√≠tulo do painel
                const titleEl = document.querySelector('.scan-status-title');
                if (titleEl) titleEl.innerHTML = '<i class="fas fa-sync fa-spin"></i> ATUALIZANDO CACHE';
                
                processQueue();
            } else {
                // Tudo j√° est√° no cache
                updateScanPanel();
                const cacheStats = { games: currentState.games.length, withStats: gamesWithStats };
                console.log('‚úÖ Todos os dados carregados do cache:', cacheStats);
            }
        }
        
        // Sincroniza dados da Steam em background (para atualizar cache)
        async function syncFromSteamInBackground(steamId) {
            console.log('üîÑ Sincronizando em background...');
            try {
                // Buscar lista de jogos atualizada
                const gamesRes = await fetchFromSteam('IPlayerService/GetOwnedGames/v0001', { steamid: steamId, include_appinfo: true, format: 'json' });
                if (gamesRes.response && gamesRes.response.games) {
                    const newGames = gamesRes.response.games;
                    const currentIds = currentState.games.map(g => g.appid);
                    const newGamesList = newGames.filter(g => !currentIds.includes(g.appid));
                    
                    if (newGamesList.length > 0) {
                        console.log(`üÜï ${newGamesList.length} novos jogos encontrados!`);
                        // Adicionar novos jogos ao estado e cache
                        const formattedGames = newGamesList.map(g => ({
                            ...g, 
                            header_image: `https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/${g.appid}/header.jpg`, 
                            playtime_hours: (g.playtime_forever / 60).toFixed(1), 
                            percent: -1, 
                            unlocked: 0, 
                            total: 0
                        }));
                        
                        currentState.games.push(...formattedGames);
                        if (window.SteamCache) {
                            await SteamCache.saveGames(steamId, formattedGames);
                        }
                        
                        // Re-renderizar para mostrar novos jogos
                        renderGamesGridFromCache();
                    }
                }
            } catch (e) {
                console.log('Background sync error (ignorado):', e.message);
            }
        }
        
        // For√ßa atualiza√ß√£o completa (limpa cache)
        async function forceFullRefresh() {
            if (!currentState.userId) return;
            if (window.SteamCache) {
                await SteamCache.clearUserCache(currentState.userId);
                console.log('üóëÔ∏è Cache limpo');
            }
            currentState.cacheLoaded = false;
            handleSearch(true, true);
        }

        async function fetchFriends(steamId) {
            try {
                const res = await fetchFromSteam('ISteamUser/GetFriendList/v0001', { steamid: steamId, relationship: 'friend' });
                if(res.friendslist && res.friendslist.friends) {
                    const allIds = res.friendslist.friends.map(f => f.steamid);
                    const container = document.getElementById('friendsContainer');
                    if(container) container.innerHTML = '';
                    const batchSize = 100;
                    for(let i=0; i<allIds.length; i+=batchSize) {
                        const batch = allIds.slice(i, i+batchSize).join(',');
                        const profiles = await fetchFromSteam('ISteamUser/GetPlayerSummaries/v0002', { steamids: batch });
                        renderFriendsList(profiles.response.players); 
                        profiles.response.players.forEach(f => { friendFetchQueue.push(f); });
                    }
                    processFriendQueue();
                }
            } catch(e) { console.log("Amigos privados"); }
        }

        function processFriendQueue() {
             if (friendFetchQueue.length === 0) { document.querySelectorAll('.ranking-loader').forEach(el => el.style.display = 'none'); return; }
             document.querySelectorAll('.ranking-loader').forEach(el => el.style.display = 'inline-block');
             while (activeFriendRequests < 6 && friendFetchQueue.length > 0) { 
                 const friend = friendFetchQueue.shift(); activeFriendRequests++;
                 fetchOwnedGamesForFriend(friend).finally(() => { activeFriendRequests--; processFriendQueue(); });
             }
        }
        
        async function fetchOwnedGamesForFriend(friend) {
            try {
                const res = await fetchFromSteam('IPlayerService/GetOwnedGames/v0001', { steamid: friend.steamid, include_appinfo: false, include_played_free_games: false });
                if (res.response) {
                    const gameCount = res.response.game_count || 0;
                    let playtime = 0; if (res.response.games) res.response.games.forEach(g => playtime += g.playtime_forever);
                    const hours = (playtime / 60).toFixed(0);
                    currentState.friendsData.push({ ...friend, gameCount: gameCount, playtimeHours: parseInt(hours) });
                    renderRankings();
                }
            } catch(e) { }
        }
        
        function renderRankings() {
            const gamesSorted = [...currentState.friendsData].sort((a,b) => b.gameCount - a.gameCount).slice(0, 50);
            const gamesBody = document.getElementById('rankGamesBody');
            if(gamesBody) {
                gamesBody.innerHTML = '';
                gamesSorted.forEach((f, index) => { gamesBody.innerHTML += `<tr class="rank-row"><td class="rank-pos">${index+1}</td><td class="rank-user"><img src="${f.avatar}" class="rank-avatar">${f.personaname}</td><td class="rank-val">${f.gameCount}</td></tr>`; });
            }
            const timeSorted = [...currentState.friendsData].sort((a,b) => b.playtimeHours - a.playtimeHours).slice(0, 50);
            const timeBody = document.getElementById('rankTimeBody');
            if(timeBody) {
                timeBody.innerHTML = '';
                timeSorted.forEach((f, index) => { timeBody.innerHTML += `<tr class="rank-row"><td class="rank-pos">${index+1}</td><td class="rank-user"><img src="${f.avatar}" class="rank-avatar">${f.personaname}</td><td class="rank-val">${f.playtimeHours}h</td></tr>`; });
            }
        }

        // --- RENDERIZA√á√ÉO ---
        function renderProfile() {
            document.getElementById('userAvatar').src = currentState.user.avatarfull;
            document.getElementById('userNameText').innerText = currentState.user.personaname;
            document.getElementById('totalGames').innerText = currentState.games.length;
            updateHunterTitle();
            
            // Verificar se conta tem +10 anos para badge Old School
            const oldSchoolBadge = document.getElementById('oldSchoolBadge');
            const accountCreatedTimestamp = currentState.user.timecreated;
            
            if (accountCreatedTimestamp) {
                const accountAge = (Date.now() / 1000 - accountCreatedTimestamp) / (365.25 * 24 * 60 * 60);
                if (accountAge >= 10) {
                    oldSchoolBadge.style.display = 'inline-flex';
                    oldSchoolBadge.title = `Conta criada h√° ${Math.floor(accountAge)} anos`;
                } else {
                    oldSchoolBadge.style.display = 'none';
                }
            } else {
                // Tentar detectar conta antiga pelo Steam ID (contas antigas tem IDs menores)
                // Steam ID 64 = 76561197960265728 + ID32
                // Contas criadas antes de 2015 (10+ anos atr√°s) geralmente tem steamid64 menor
                const steamId64 = BigInt(currentState.user.steamid || '0');
                const baseId = BigInt('76561197960265728'); // Base do Steam ID 64
                
                // Aproxima√ß√£o: contas criadas at√© ~2015 (para ter 10+ anos em 2025)
                // Threshold aproximado para contas de 2014-2015
                const threshold10Years = BigInt('76561198150000000'); // ~2014-2015
                
                if (steamId64 > 0 && steamId64 < threshold10Years) {
                    // Conta provavelmente antiga (10+ anos)
                    oldSchoolBadge.style.display = 'inline-flex';
                    oldSchoolBadge.title = 'Conta veterana do Steam (10+ anos estimado pelo ID)';
                } else {
                    oldSchoolBadge.style.display = 'none';
                }
            }
            
            // Adicionar badge de cache se carregou do cache
            const profileHero = document.querySelector('.profile-hero');
            const existingBadge = profileHero.querySelector('.cache-badge');
            if (existingBadge) existingBadge.remove();
            
            if (currentState.cacheLoaded) {
                const badge = document.createElement('div');
                badge.className = 'cache-badge';
                badge.innerHTML = '<i class="fas fa-database"></i> CACHE';
                badge.title = 'Dados carregados do cache local (instant√¢neo!)';
                profileHero.appendChild(badge);
            }
        }

        function updateHunterTitle() {
            const plats = currentState.stats.totalPlatinum;
            const el = document.getElementById('hunterTitle');
            if(!el) return; 
            let title = "Iniciante"; let cls = "";
            if(plats >= 50) { title = "DEUS DA PLATINA"; cls = "legendary"; }
            else if(plats >= 20) { title = "Colecionador de Elite"; }
            else if(plats >= 5) { title = "Ca√ßador de Trof√©us"; }
            el.innerText = title; el.className = "hunter-title " + cls;
        }

        function renderGamesGrid() {
            const grid = document.getElementById('gamesGrid');
            grid.innerHTML = ''; fetchQueue = []; activeRequests = 0;
            currentState.failedGames = []; // Reset failed games
            currentState.scanPaused = false;
            currentState.stats.totalPlayableGames = currentState.games.filter(g => g.has_community_visible_stats).length;
            updateGlobalStatsUI();
            
            // Show scan panel and progress bar
            document.getElementById('scan-progress-container').style.display = 'block';
            showScanPanel();
            
            currentState.games.forEach(game => {
                const card = document.createElement('div'); card.className = 'game-card'; card.id = `game-${game.appid}`; card.dataset.percent = game.percent; card.dataset.name = game.name.toLowerCase();
                card.onmouseenter = () => setDynamicBackground(game.appid);
                let loadingState = '', pctText = '', progText = '', width = '0%';
                if (game.percent !== -1) { pctText = `${game.percent}%`; progText = `${game.unlocked}/${game.total}`; width = `${game.percent}%`; if (game.percent === 100) card.classList.add('platinum'); else if (game.percent >= 70) card.classList.add('platinando'); } else if (game.has_community_visible_stats) { loadingState = '<i class="fas fa-spinner fa-spin"></i>'; } else { loadingState = 'N/A'; }
                
                // HLTB data
                const hltb = getHLTB(game.appid);
                let hltbHtml = '';
                if (hltb) {
                    hltbHtml = `<div class="game-meta-right">
                        <span class="hltb-label"><i class="fas fa-stopwatch"></i> HLTB</span>
                        <span class="hltb-time" title="${t('hltbMain') || 'Hist√≥ria principal'}: ${hltb.main}h | ${t('hltb100') || '100%'}: ${hltb.complete}h">üéÆ ${hltb.main}h | üèÜ ${hltb.complete}h</span>
                    </div>`;
                }
                
                card.innerHTML = `
                    <div class="platinum-badge" style="${game.percent === 100 ? 'display:block' : ''}"><i class="fas fa-trophy"></i> 100%</div>
                    <div class="platinando-badge" style="${(game.percent >= 70 && game.percent < 100) ? 'display:block' : ''}"><i class="fas fa-running"></i> ${t('inProgress') || 'Platinando'}</div>
                    <img data-src="${game.header_image}" class="game-banner lazy-img" loading="lazy" onerror="this.src='https://placehold.co/600x300/111/FFF?text=No+Image'">
                    <div class="game-details">
                        <div class="game-title">${game.name}</div>
                        <div class="game-meta">
                            <div class="game-meta-left"><span><i class="fas fa-clock"></i> ${game.playtime_hours}h ${t('hoursPlayed') || 'jogadas'}</span></div>
                            ${hltbHtml}
                        </div>
                        <div class="game-progress-info" id="prog-${game.appid}">${loadingState}</div>
                        <div class="game-progress-bar-bg"><div class="game-progress-bar-fill" id="bar-${game.appid}" style="width:${width}"></div></div>
                        <div class="game-stats-row"><span id="txt-prog-${game.appid}">${progText}</span><span id="txt-pct-${game.appid}">${pctText}</span></div>
                    </div>`;
                card.onclick = () => openGameModal(game); grid.appendChild(card);
                
                // Se n√£o tem HLTB no cache, buscar dinamicamente do servidor
                if (!hltb) {
                    queueHLTBFetch(game.appid, game.name, card);
                }
                
                if (game.has_community_visible_stats && game.percent === -1) fetchQueue.push(game.appid);
            });
            initLazyLoading(); // Iniciar lazy loading
            processQueue();
            
            // Re-anexar listeners de soundtrack se o modo estiver ativo
            if (isSoundtrackModeEnabled) {
                attachSoundtrackListeners();
            }
        }

        function processQueue() {
            if (currentState.scanPaused) return; // Paused
            
            updateScanPanel(); // Update stats
            
            if (fetchQueue.length === 0 && activeRequests === 0) { 
                // Scan complete
                document.getElementById('scan-progress-container').style.display = 'none';
                finishScan();
                return; 
            }
            
            const processed = currentState.stats.gamesCounted; 
            const total = currentState.stats.totalPlayableGames; 
            const barWidth = total > 0 ? (processed / total) * 100 : 0;
            document.getElementById('scan-progress-bar').style.width = `${barWidth}%`;
            
            while (activeRequests < MAX_CONCURRENT_REQUESTS && fetchQueue.length > 0) {
                const appId = fetchQueue.shift(); activeRequests++;
                fetchGameStats(appId).finally(() => { activeRequests--; processQueue(); });
            }
        }

        async function fetchGameStats(appId) {
            const progEl = document.getElementById(`prog-${appId}`); 
            const card = document.getElementById(`game-${appId}`);
            if (!progEl) return;
            
            try {
                const res = await fetchFromSteam('ISteamUserStats/GetPlayerAchievements/v0001', { steamid: currentState.userId, appid: appId }, 4);
                if (res.playerstats && res.playerstats.achievements) {
                    const achievements = res.playerstats.achievements;
                    const total = achievements.length; 
                    const unlocked = achievements.filter(a => a.achieved === 1).length; 
                    const percent = total > 0 ? Math.floor((unlocked / total) * 100) : 0;
                    const gameIdx = currentState.games.findIndex(g => g.appid === appId);
                    if(gameIdx > -1) { 
                        currentState.games[gameIdx].percent = percent; 
                        currentState.games[gameIdx].unlocked = unlocked; 
                        currentState.games[gameIdx].total = total; 
                    }
                    
                    // ===== SALVAR NO CACHE =====
                    if (window.SteamCache) {
                        // Salvar stats do jogo
                        await SteamCache.updateGameStats(currentState.userId, appId, { percent, unlocked, total });
                        // Salvar conquistas individuais
                        await SteamCache.saveAchievements(currentState.userId, appId, achievements);
                    }
                    
                    if(progEl && card) { 
                        progEl.innerHTML = '<i class="fas fa-database" style="color:var(--success)" title="Salvo no cache"></i>'; 
                        document.getElementById(`txt-prog-${appId}`).innerText = `${unlocked}/${total}`; 
                        document.getElementById(`txt-pct-${appId}`).innerText = `${percent}%`; 
                        document.getElementById(`bar-${appId}`).style.width = `${percent}%`; 
                        card.dataset.percent = percent; 
                        if (percent === 100) card.classList.add('platinum'); 
                        else if (percent >= 70) card.classList.add('platinando'); 
                    }
                    recalculateTotalStats();
                } else { 
                    if(progEl) progEl.innerText = "Sem Conquistas"; 
                    if(card) card.dataset.percent = 0; 
                }
            } catch (e) { 
                // Failed - add to retry list
                currentState.failedGames.push(appId);
                if(progEl) progEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i>'; 
                if(card) card.dataset.percent = 0; 
            } finally { 
                currentState.stats.gamesCounted++; 
                if (currentState.activeFilter !== 'all') filterGames(); 
            }
        }

        // === SCAN PANEL FUNCTIONS ===
        function showScanPanel() {
            const panel = document.getElementById('scanStatusPanel');
            if (panel) {
                panel.classList.add('active');
                document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause"></i> Pausar';
                document.getElementById('retryBtn').disabled = true;
            }
        }

        function closeScanPanel() {
            const panel = document.getElementById('scanStatusPanel');
            if (panel) panel.classList.remove('active');
        }

        function updateScanPanel() {
            const totalAllEl = document.getElementById('scanTotalAllGames');
            const noAchievementsEl = document.getElementById('scanNoAchievements');
            const completedEl = document.getElementById('scanCompleted');
            const achievementsEl = document.getElementById('scanAchievements');
            const failedEl = document.getElementById('scanFailed');
            const cacheEl = document.getElementById('scanCacheSize');
            
            const totalGames = currentState.games.length;
            const gamesWithAchievements = currentState.stats.totalPlayableGames;
            const gamesWithoutAchievements = totalGames - gamesWithAchievements;
            
            if (totalAllEl) totalAllEl.innerText = totalGames;
            if (noAchievementsEl) noAchievementsEl.innerText = gamesWithoutAchievements;
            if (completedEl) completedEl.innerText = currentState.stats.gamesCounted;
            if (achievementsEl) achievementsEl.innerText = currentState.stats.totalAchievementsUnlocked.toLocaleString();
            if (failedEl) failedEl.innerText = currentState.failedGames.length;
            
            // Atualizar tamanho do cache
            if (cacheEl && window.SteamCache) {
                SteamCache.getCacheSize().then(size => {
                    cacheEl.innerText = `${size.usedMB} MB`;
                });
            }
        }

        function finishScan() {
            const titleEl = document.querySelector('.scan-status-title');
            if (titleEl) titleEl.innerHTML = '<i class="fas fa-check-circle" style="color:var(--success)"></i> COMPLETO';
            
            const retryBtn = document.getElementById('retryBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            if (retryBtn) retryBtn.disabled = currentState.failedGames.length === 0;
            if (pauseBtn) pauseBtn.disabled = true;
            
            updateScanPanel();
        }

        function pauseResumeScan() {
            currentState.scanPaused = !currentState.scanPaused;
            const btn = document.getElementById('pauseBtn');
            if (currentState.scanPaused) {
                btn.innerHTML = '<i class="fas fa-play"></i> Retomar';
            } else {
                btn.innerHTML = '<i class="fas fa-pause"></i> Pausar';
                processQueue(); // Resume
            }
        }

        function retryScanFailed() {
            if (currentState.failedGames.length === 0) return;
            
            const titleEl = document.querySelector('.scan-status-title');
            if (titleEl) titleEl.innerHTML = '<i class="fas fa-sync fa-spin"></i> RETRY';
            
            // Add failed games back to queue
            fetchQueue = [...currentState.failedGames];
            currentState.failedGames = [];
            currentState.scanPaused = false;
            
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('retryBtn').disabled = true;
            document.getElementById('scan-progress-container').style.display = 'block';
            
            processQueue();
        }

        function recalculateTotalStats() {
            let tPlat = 0, tAch = 0, sumPct = 0, count = 0;
            currentState.games.forEach(g => { if (g.percent !== -1 && g.total > 0) { tAch += g.unlocked; sumPct += g.percent; count++; if (g.percent === 100) tPlat++; } });
            document.getElementById('totalPlatinum').innerText = tPlat; document.getElementById('totalAchievements').innerText = tAch.toLocaleString();
            const completionRateEl = document.getElementById('completionRate'); if (completionRateEl) { const avg = count > 0 ? (sumPct / count).toFixed(0) : 0; completionRateEl.innerText = `${avg}%`; }
            currentState.stats.totalPlatinum = tPlat; currentState.stats.totalAchievementsUnlocked = tAch;
            currentState.stats.gamesCounted = count;
            updateHunterTitle();
            updateHeaderXP();
            
            // Atualizar localStorage de jogos a cada 10 atualiza√ß√µes para outras p√°ginas usarem
            if (count % 10 === 0 || tPlat > 0) {
                localStorage.setItem('currentGames', JSON.stringify(currentState.games));
            }
        }

        function updateHeaderXP() {
            const stats = currentState.stats;
            // F√≥rmula de XP: conquistas * 10 + platinas * 500 + jogos escaneados * 25
            const totalXP = (stats.totalAchievementsUnlocked || 0) * 10 + (stats.totalPlatinum || 0) * 500 + (stats.gamesCounted || 0) * 25;
            // F√≥rmula de level: sqrt(xp / 100) - progress√£o quadr√°tica
            const level = Math.max(1, Math.floor(Math.sqrt(totalXP / 100)));
            const xpForCurrent = 100 * (level * level);
            const xpForNext = 100 * ((level + 1) * (level + 1));
            const xpInLevel = totalXP - xpForCurrent;
            const xpNeeded = xpForNext - xpForCurrent;
            const percent = xpNeeded > 0 ? Math.max(0, Math.min(100, Math.floor((xpInLevel / xpNeeded) * 100))) : 0;

            const container = document.getElementById('headerXpContainer');
            if (!container) return;
            document.getElementById('hLvl').innerText = `Lv ${level}`;
            document.getElementById('hBar').style.width = `${percent}%`;
            document.getElementById('hText').innerText = `${xpInLevel}/${xpNeeded}`;
            container.style.display = 'flex';

            // Salvar no localStorage para outras p√°ginas
            localStorage.setItem('userStats', JSON.stringify({
                totalAchievementsUnlocked: stats.totalAchievementsUnlocked,
                totalPlatinum: stats.totalPlatinum,
                gamesCounted: stats.gamesCounted,
                totalXP: totalXP,
                level: level
            }));
            
            // Atualizar heatmap se tiver dados
            if (window.SteamCache && currentState.userId) {
                updateHeatmap();
            }
        }
        
        // ===== HEATMAP CALENDAR =====
        let heatmapTooltip = null;
        
        async function updateHeatmap() {
            if (!window.SteamCache || !currentState.userId) return;
            
            try {
                // Buscar todas as conquistas do cache
                const games = await SteamCache.getGames(currentState.userId);
                const allAchievements = [];
                
                for (const game of games) {
                    const achs = await SteamCache.getAchievements(currentState.userId, game.appid);
                    allAchievements.push(...achs.filter(a => a.unlocked && a.unlocktime > 0));
                }
                
                if (allAchievements.length === 0) {
                    document.getElementById('heatmapSection').style.display = 'none';
                    return;
                }
                
                // Mostrar se√ß√£o
                document.getElementById('heatmapSection').style.display = 'block';
                
                // Agrupar conquistas por dia
                const achByDay = {};
                allAchievements.forEach(ach => {
                    const date = new Date(ach.unlocktime * 1000);
                    const key = date.toISOString().split('T')[0]; // YYYY-MM-DD
                    if (!achByDay[key]) achByDay[key] = [];
                    achByDay[key].push(ach);
                });
                
                // Calcular streak atual
                let streak = 0;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                for (let i = 0; i < 365; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(checkDate.getDate() - i);
                    const key = checkDate.toISOString().split('T')[0];
                    if (achByDay[key]) {
                        streak++;
                    } else if (i > 0) {
                        break;
                    }
                }
                
                // Atualizar stats
                document.getElementById('heatmapTotal').innerText = `${allAchievements.length} conquistas`;
                document.getElementById('heatmapStreak').innerText = `üî• ${streak} dias de streak`;
                
                // Renderizar grid (√∫ltimo ano)
                renderHeatmapGrid(achByDay);
                
            } catch (e) {
                console.error('Erro ao atualizar heatmap:', e);
            }
        }
        
        function renderHeatmapGrid(achByDay) {
            const grid = document.getElementById('heatmapGrid');
            const monthsContainer = document.getElementById('heatmapMonths');
            grid.innerHTML = '';
            monthsContainer.innerHTML = '';
            
            // Gerar √∫ltimas 52 semanas (364 dias)
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 364);
            
            // Ajustar para come√ßar no domingo
            const dayOfWeek = startDate.getDay();
            startDate.setDate(startDate.getDate() - dayOfWeek);
            
            // Meses
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            let currentMonth = -1;
            let monthSpans = [];
            let weekCount = 0;
            
            // Gerar c√©lulas
            const cells = [];
            const currentDate = new Date(startDate);
            
            while (currentDate <= today) {
                const month = currentDate.getMonth();
                if (month !== currentMonth) {
                    if (monthSpans.length > 0) {
                        monthSpans[monthSpans.length - 1].weeks = weekCount;
                    }
                    monthSpans.push({ name: months[month], weeks: 0 });
                    currentMonth = month;
                    weekCount = 0;
                }
                
                if (currentDate.getDay() === 0) weekCount++;
                
                const key = currentDate.toISOString().split('T')[0];
                const count = achByDay[key] ? achByDay[key].length : 0;
                let level = 0;
                if (count >= 10) level = 4;
                else if (count >= 6) level = 3;
                else if (count >= 3) level = 2;
                else if (count >= 1) level = 1;
                
                const cell = document.createElement('div');
                cell.className = `heatmap-cell level-${level}`;
                cell.dataset.date = key;
                cell.dataset.count = count;
                
                // Eventos de tooltip
                cell.addEventListener('mouseenter', showHeatmapTooltip);
                cell.addEventListener('mouseleave', hideHeatmapTooltip);
                
                grid.appendChild(cell);
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Finalizar √∫ltimo m√™s
            if (monthSpans.length > 0) {
                monthSpans[monthSpans.length - 1].weeks = weekCount;
            }
            
            // Renderizar labels de meses
            monthSpans.forEach(m => {
                const span = document.createElement('span');
                span.innerText = m.name;
                span.style.width = `${m.weeks * 14}px`;
                monthsContainer.appendChild(span);
            });
        }
        
        function showHeatmapTooltip(e) {
            const cell = e.target;
            const date = cell.dataset.date;
            const count = parseInt(cell.dataset.count);
            
            if (!heatmapTooltip) {
                heatmapTooltip = document.createElement('div');
                heatmapTooltip.className = 'heatmap-tooltip';
                document.body.appendChild(heatmapTooltip);
            }
            
            const dateObj = new Date(date + 'T12:00:00');
            const formattedDate = dateObj.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            heatmapTooltip.innerHTML = `<strong>${count} conquista${count !== 1 ? 's' : ''}</strong> em ${formattedDate}`;
            heatmapTooltip.style.display = 'block';
            
            const rect = cell.getBoundingClientRect();
            heatmapTooltip.style.left = `${rect.left + window.scrollX - heatmapTooltip.offsetWidth / 2 + 6}px`;
            heatmapTooltip.style.top = `${rect.top + window.scrollY - heatmapTooltip.offsetHeight - 8}px`;
        }
        
        function hideHeatmapTooltip() {
            if (heatmapTooltip) {
                heatmapTooltip.style.display = 'none';
            }
        }
        
        function updateGlobalStatsUI() { }
        function resetGlobalStats() { currentState.stats = { totalPlatinum: 0, totalAchievementsUnlocked: 0, sumPercentages: 0, gamesCounted: 0, totalPlayableGames: 0 }; document.getElementById('totalPlatinum').innerText = '0'; document.getElementById('totalAchievements').innerText = '0'; const completionRateEl = document.getElementById('completionRate'); if(completionRateEl) completionRateEl.innerText = '0%'; fetchQueue = []; activeRequests = 0; }
        function retryModalLoad() { if (currentState.currentModalGame) openGameModal(currentState.currentModalGame); }

        async function openGameModal(game) {
            currentState.currentModalGame = game; 
            const modal = document.getElementById('achievementModal'); 
            const title = document.getElementById('modalGameTitle'); 
            const list = document.getElementById('achievementsList'); 
            const loader = document.getElementById('modalLoader');
            title.innerText = game.name; 
            list.innerHTML = ''; 
            list.classList.add('hidden'); 
            loader.classList.remove('hidden'); 
            modal.classList.add('open'); 
            document.body.style.overflow = 'hidden';
            
            try {
                let playerAch = [];
                let schemaAch = [];
                let globalPerc = {};
                let fromCache = false;
                let needsSchemaFetch = false;
                
                // ===== TENTAR CACHE PRIMEIRO =====
                if (window.SteamCache) {
                    const cachedAch = await SteamCache.getAchievements(currentState.userId, game.appid);
                    if (cachedAch.length > 0) {
                        console.log(`üì¶ ${cachedAch.length} conquistas carregadas do cache`);
                        fromCache = true;
                        
                        // Verificar se cache tem dados completos (nome real, n√£o s√≥ apiname)
                        const hasCompleteData = cachedAch.some(a => a.name && a.name !== a.apiname && a.percent);
                        
                        if (hasCompleteData) {
                            // Converter do formato de cache completo
                            playerAch = cachedAch.map(a => ({
                                apiname: a.apiname,
                                achieved: a.unlocked || a.achieved ? 1 : 0,
                                unlocktime: a.unlocktime
                            }));
                            cachedAch.forEach(a => {
                                if (a.percent) globalPerc[a.apiname] = a.percent;
                            });
                            schemaAch = cachedAch.map(a => ({
                                name: a.apiname,
                                displayName: a.name || a.apiname,
                                description: a.description || 'Conquista Secreta',
                                icon: a.icon || '',
                                icongray: a.icongray || ''
                            }));
                        } else {
                            // Cache incompleto - tem s√≥ dados b√°sicos, precisa buscar schema
                            console.log('‚ö†Ô∏è Cache incompleto, buscando schema...');
                            playerAch = cachedAch.map(a => ({
                                apiname: a.apiname || a.name,
                                achieved: a.unlocked || a.achieved ? 1 : 0,
                                unlocktime: a.unlocktime
                            }));
                            needsSchemaFetch = true;
                        }
                    }
                }
                
                // ===== SE N√ÉO TEM NO CACHE OU CACHE INCOMPLETO, BUSCAR DA API =====
                if (!fromCache || needsSchemaFetch) {
                    // Se n√£o tem playerAch, buscar
                    if (!fromCache) {
                        const playerRes = await fetchFromSteam('ISteamUserStats/GetPlayerAchievements/v0001', { steamid: currentState.userId, appid: game.appid });
                        if (!playerRes.playerstats || !playerRes.playerstats.achievements) throw new Error("Sem dados.");
                        playerAch = playerRes.playerstats.achievements;
                    }
                    
                    // Buscar schema com nomes em portugu√™s
                    const schemaRes = await fetchFromSteam('ISteamUserStats/GetSchemaForGame/v0002', { appid: game.appid, l: 'brazilian' }); 
                    schemaAch = schemaRes.game && schemaRes.game.availableGameStats ? schemaRes.game.availableGameStats.achievements : [];
                    
                    // Buscar porcentagens globais
                    try { 
                        const globalRes = await fetchFromSteam('ISteamUserStats/GetGlobalAchievementPercentagesForApp/v0002', { gameid: game.appid }); 
                        if (globalRes.achievementpercentages) { 
                            globalRes.achievementpercentages.achievements.forEach(a => { globalPerc[a.name] = a.percent; }); 
                        } 
                    } catch(e) { console.log('Porcentagens globais n√£o dispon√≠veis'); }
                    
                    // Salvar dados completos no cache
                    if (window.SteamCache) {
                        const achToSave = playerAch.map(p => {
                            const schema = schemaAch.find(s => s.name === p.apiname) || {};
                            return {
                                apiname: p.apiname,
                                name: schema.displayName || p.apiname,
                                description: schema.description || 'Conquista Secreta',
                                icon: schema.icon || '',
                                icongray: schema.icongray || '',
                                unlocked: p.achieved === 1,
                                unlocktime: p.unlocktime || 0,
                                percent: globalPerc[p.apiname] || 0
                            };
                        });
                        await SteamCache.saveAchievements(currentState.userId, game.appid, achToSave);
                        await SteamCache.saveGameSchema(game.appid, { achievements: schemaAch });
                    }
                }
                
                const fullList = playerAch.map(p => {
                    const schema = schemaAch.find(s => s.name === p.apiname) || {};
                    let rawPercent = globalPerc[p.apiname]; let percent = "N/A";
                    if (typeof rawPercent === 'number') { percent = rawPercent.toFixed(1); } else if (typeof rawPercent === 'string' && !isNaN(parseFloat(rawPercent))) { percent = parseFloat(rawPercent).toFixed(1); rawPercent = parseFloat(rawPercent); }
                    let rClass = 'rarity-common'; let rText = 'Comum';
                    if (percent !== "N/A") { if (rawPercent < 10) { rClass = 'rarity-ultra'; rText = 'Ultra Rara'; } else if (rawPercent < 30) { rClass = 'rarity-rare'; rText = 'Rara'; } }
                    return { api: p.apiname, unlocked: p.achieved === 1, name: schema.displayName || p.apiname, desc: schema.description || "Conquista Secreta", icon: p.achieved ? schema.icon : schema.icongray, percent: percent, rarityClass: rClass, rarityText: rText };
                });
                renderAchievementList(fullList); list.dataset.fullData = JSON.stringify(fullList); loader.classList.add('hidden'); list.classList.remove('hidden');
            } catch (error) { console.error(error); }
        }

        function renderAchievementList(list) {
            const container = document.getElementById('achievementsList'); container.innerHTML = '';
            list.forEach(ach => {
                if (currentState.modalFilter === 'unlocked' && !ach.unlocked) return; if (currentState.modalFilter === 'locked' && ach.unlocked) return;
                container.innerHTML += `<div class="achievement-item ${ach.unlocked ? 'unlocked' : 'locked'}"><img src="${ach.icon}" class="ach-icon" onerror="this.src='https://placehold.co/64/black/white?text=?'"><div class="ach-info"><div class="ach-name">${ach.name} <span class="rarity-tag ${ach.rarityClass}">${ach.rarityText} (${ach.percent}%)</span></div><div class="ach-desc">${ach.desc}</div></div><div class="ach-status"><i class="fas ${ach.unlocked ? 'fa-check-circle' : 'fa-lock'}"></i></div></div>`;
            });
        }

        function renderFriendsList(friends) {
            const container = document.getElementById('friendsContainer');
            friends.forEach(f => {
                container.innerHTML += `<button class="friend-card" onclick="triggerSearch('${f.steamid}')" title="${f.personaname}"><img src="${f.avatarfull}" class="friend-avatar"><div class="friend-name">${f.personaname}</div></button>`;
            });
        }

        /* --- EXTRAS --- */
        function openSignatureModal() {
            if(!currentState.userId) return showToast(t('toast_enterSteamId') || 'Pesquise um perfil primeiro', 'warning');
            const select = document.getElementById('sigGameSelect'); select.innerHTML = '';
            const validGames = currentState.games.filter(g => g.name);
            validGames.forEach(g => { const opt = document.createElement('option'); opt.value = g.appid; opt.innerText = g.name; select.appendChild(opt); });
            if(validGames.length > 0) updateSignaturePreview(validGames[0].appid);
            document.getElementById('signatureModal').classList.add('open');
        }

        function updateSignaturePreview(appId) {
            const game = currentState.games.find(g => g.appid == appId); if(!game) return;
            document.getElementById('sigBg').style.backgroundImage = `url('${game.header_image}')`;
            document.getElementById('sigAvatar').src = currentState.user.avatarfull;
            document.getElementById('sigName').innerText = currentState.user.personaname;
            document.getElementById('sigGames').innerText = currentState.stats.gamesCounted;
            document.getElementById('sigPlat').innerText = currentState.stats.totalPlatinum;
            document.getElementById('sigAch').innerText = currentState.stats.totalAchievementsUnlocked.toLocaleString();
            document.getElementById('sigGameName').innerText = game.name;
            const unlocked = game.unlocked || 0; const total = game.total || 0; const percent = game.percent > -1 ? game.percent : 0;
            document.getElementById('sigGameProg').innerText = `${unlocked}/${total}`;
            document.getElementById('sigGamePct').innerText = `${percent}%`;
            document.getElementById('sigGameBar').style.width = `${percent}%`;
        }

        function downloadSignature() {
            const element = document.getElementById('signature-card-element');
            html2canvas(element, { useCORS: true, allowTaint: true, backgroundColor: null }).then(canvas => { const link = document.createElement('a'); link.download = `steam_card_${currentState.userId}.png`; link.href = canvas.toDataURL('image/png'); link.click(); });
        }

        // ===== MONTHLY GOAL SYSTEM =====
        function openMonthlyGoalModal() {
            if(!currentState.userId) return showToast('Pesquise um perfil primeiro', 'warning');
            loadMonthlyGoals();
            document.getElementById('monthlyGoalModal').classList.add('open');
        }
        
        function loadMonthlyGoals() {
            const saved = localStorage.getItem('monthlyGoals');
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
            
            let goals = saved ? JSON.parse(saved) : { month: currentMonth, platinums: 0, achievements: 0, hours: 0, targets: { platinums: 5, achievements: 50, hours: 30 } };
            
            // Resetar se √© um novo m√™s
            if (goals.month !== currentMonth) {
                goals = { month: currentMonth, platinums: 0, achievements: 0, hours: 0, targets: goals.targets };
            }
            
            // Atualizar valores dos inputs
            document.getElementById('goalPlatinumTarget').value = goals.targets.platinums;
            document.getElementById('goalAchievementTarget').value = goals.targets.achievements;
            document.getElementById('goalHoursTarget').value = goals.targets.hours;
            
            // Atualizar progresso visual (usando platinas como principal)
            const progress = Math.min(100, (currentState.stats.totalPlatinum / goals.targets.platinums) * 100);
            const circumference = 2 * Math.PI * 65;
            const offset = circumference - (progress / 100) * circumference;
            
            document.getElementById('goalProgressCircle').style.strokeDashoffset = offset;
            document.getElementById('goalCurrentValue').textContent = currentState.stats.totalPlatinum;
            document.getElementById('goalLabel').textContent = `de ${goals.targets.platinums} platinas`;
        }
        
        function saveMonthlyGoals() {
            const now = new Date();
            const goals = {
                month: `${now.getFullYear()}-${now.getMonth()}`,
                platinums: currentState.stats.totalPlatinum,
                achievements: currentState.stats.totalAchievementsUnlocked,
                hours: 0,
                targets: {
                    platinums: parseInt(document.getElementById('goalPlatinumTarget').value) || 5,
                    achievements: parseInt(document.getElementById('goalAchievementTarget').value) || 50,
                    hours: parseInt(document.getElementById('goalHoursTarget').value) || 30
                }
            };
            localStorage.setItem('monthlyGoals', JSON.stringify(goals));
            showToast('Metas salvas com sucesso!', 'success');
            loadMonthlyGoals();
        }

        // ===== DISCORD INTEGRATION =====
        function openDiscordModal() {
            if(!currentState.userId) return showToast('Pesquise um perfil primeiro', 'warning');
            
            // Carregar webhook salvo
            const savedWebhook = localStorage.getItem('discordWebhook');
            if (savedWebhook) {
                document.getElementById('discordWebhook').value = savedWebhook;
            }
            
            // Atualizar preview
            document.getElementById('discordPlayerName').textContent = currentState.user?.personaname || '-';
            document.getElementById('discordPlatinas').textContent = currentState.stats.totalPlatinum;
            document.getElementById('discordConquistas').textContent = currentState.stats.totalAchievementsUnlocked;
            
            document.getElementById('discordModal').classList.add('open');
        }
        
        async function sendToDiscord() {
            const webhookUrl = document.getElementById('discordWebhook').value.trim();
            if (!webhookUrl || !webhookUrl.includes('discord.com/api/webhooks')) {
                return showToast('URL do webhook inv√°lida', 'error');
            }
            
            // Salvar webhook para uso futuro
            localStorage.setItem('discordWebhook', webhookUrl);
            
            const shareType = document.querySelector('input[name="discordShareType"]:checked').value;
            
            let embed = {
                title: 'üéÆ Steam Achievements Explorer',
                color: 5793266, // Cor azul/roxo
                thumbnail: { url: currentState.user?.avatarfull },
                footer: { text: 'Steam Achievements Explorer ‚Ä¢ github.com/jabalxp/SAE' },
                timestamp: new Date().toISOString()
            };
            
            if (shareType === 'profile') {
                embed.description = `**${currentState.user?.personaname}** est√° ca√ßando conquistas!`;
                embed.fields = [
                    { name: 'üèÜ Platinas', value: currentState.stats.totalPlatinum.toString(), inline: true },
                    { name: '‚≠ê Conquistas', value: currentState.stats.totalAchievementsUnlocked.toLocaleString(), inline: true },
                    { name: 'üéÆ Jogos', value: currentState.games.length.toString(), inline: true }
                ];
            } else if (shareType === 'platinum') {
                const lastPlatinum = currentState.games.find(g => g.percent === 100);
                embed.description = lastPlatinum 
                    ? `**${currentState.user?.personaname}** zerou **${lastPlatinum.name}**! üèÜ`
                    : `**${currentState.user?.personaname}** ainda n√£o tem platinas!`;
                if (lastPlatinum) {
                    embed.image = { url: lastPlatinum.header_image };
                }
            } else {
                const avgPercent = currentState.stats.gamesCounted > 0 
                    ? Math.floor(currentState.stats.sumPercentages / currentState.stats.gamesCounted) : 0;
                embed.description = `üìä Estat√≠sticas completas de **${currentState.user?.personaname}**`;
                embed.fields = [
                    { name: 'üèÜ Total de Platinas', value: currentState.stats.totalPlatinum.toString(), inline: true },
                    { name: '‚≠ê Conquistas Desbloqueadas', value: currentState.stats.totalAchievementsUnlocked.toLocaleString(), inline: true },
                    { name: 'üìà M√©dia de Conclus√£o', value: `${avgPercent}%`, inline: true },
                    { name: 'üéÆ Jogos na Biblioteca', value: currentState.games.length.toString(), inline: true },
                    { name: '‚úÖ Jogos Analisados', value: currentState.stats.gamesCounted.toString(), inline: true }
                ];
            }
            
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ embeds: [embed] })
                });
                
                if (response.ok) {
                    showToast('Enviado para o Discord com sucesso!', 'success');
                    document.getElementById('discordModal').classList.remove('open');
                } else {
                    throw new Error('Falha no envio');
                }
            } catch (e) {
                showToast('Erro ao enviar para o Discord. Verifique a URL do webhook.', 'error');
            }
        }

        function openChartsModal() { document.getElementById('chartsModal').classList.add('open'); renderCharts(); }
        let chartsInstance = {};
        function renderCharts() {
            const ctxPie = document.getElementById('gamesPieChart').getContext('2d'); const ctxBar = document.getElementById('playtimeBarChart').getContext('2d');
            if(chartsInstance.pie) chartsInstance.pie.destroy(); if(chartsInstance.bar) chartsInstance.bar.destroy();
            const platinums = currentState.stats.totalPlatinum; const started = currentState.stats.gamesCounted - platinums; const unplayed = currentState.games.length - currentState.stats.gamesCounted;
            chartsInstance.pie = new Chart(ctxPie, { type: 'doughnut', data: { labels: ['Platinados', 'Iniciados', 'N√£o Jogados'], datasets: [{ data: [platinums, started, unplayed], backgroundColor: ['#ffd700', '#00f3ff', '#333'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { labels: { color: '#fff' } } } } });
            const topGames = currentState.games.slice(0, 10);
            chartsInstance.bar = new Chart(ctxBar, { type: 'bar', data: { labels: topGames.map(g => g.name.substring(0, 15) + '...'), datasets: [{ label: 'Horas', data: topGames.map(g => g.playtime_hours), backgroundColor: '#bc13fe' }] }, options: { responsive: true, plugins: { legend: { display: false }, tooltip: { mode: 'index' } }, scales: { y: { ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } } } });
        }

        function filterModal(type) { currentState.modalFilter = type; document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); const list = document.getElementById('achievementsList'); if(list.dataset.fullData) renderAchievementList(JSON.parse(list.dataset.fullData)); }
        function closeGameModal() { 
            document.getElementById('achievementModal').classList.remove('open'); 
            document.body.style.overflow = 'auto'; 
            document.getElementById('dynamic-bg').style.opacity = '0';
            // Parar m√∫sica ao fechar modal
            stopModalSoundtrack();
        }
        
        // ===== SOUNDTRACK SYSTEM =====
        let soundtrackAudio = null;
        let isSoundtrackModeEnabled = false;
        let currentPlayingAppId = null;
        let isModalSoundtrackPlaying = false;
        
        // URLs de trilhas sonoras diretas (arquivos de √°udio gratuitos ou samples)
        // Usando trilhas tem√°ticas gen√©ricas para jogos que n√£o temos
        const gameSoundtrackUrls = {
            // Para uma implementa√ß√£o real, usar√≠amos URLs de arquivos de √°udio
            // Por agora, usamos o YouTube como fallback no modal
        };
        
        // IDs do YouTube para trilhas (usado no modal e hover)
        const gameSoundtracksYT = {
            1245620: 'DgpYfCnLhAo', // Elden Ring - Main Theme
            1593500: 'y9hh91-2qaA', // God of War
            1091500: '294UYpnL3zY', // Cyberpunk 2077
            1174180: 'DKuFA8LhpMk', // Red Dead Redemption 2
            1145360: 'Yko-0MpTwPM', // Hades - Good Riddance
            367520: 'WZPAfSGlGbQ', // Hollow Knight - Greenpath
            292030: 'NknjE2SBPxw', // The Witcher 3
            814380: 'pKUaHfoMoFg', // Sekiro
            374320: 'stWae6r7Blw', // Dark Souls III
            504230: 'iDVM9KED46Q', // Celeste
            268910: 'HGH4yJ-BSXk', // Cuphead
            588650: 'k5IYgbAJlJQ', // Dead Cells
            570: 'HmZYgqBp1gI', // Dota 2
            730: 'mB6fq9Aadwk', // CS:GO
            271590: '8XLUuqC8wvA', // GTA V
            377160: 'qdFmSlLdjms', // Fallout 4
            582010: 'qlZNRrD2eB8', // Monster Hunter World
            1817070: 'WVnUR5WL2bc', // Hogwarts Legacy
            730: 'fM3pFBDXhDQ', // CS2/CSGO Menu Theme
            440: 'b8maq4Bb8xU', // Team Fortress 2
            578080: 'xYvX1VknChU', // PUBG
            1172470: 'UDxZ7bU4SAs', // Apex Legends
            252490: 'AoFoAuCl2Xo', // Rust
            1086940: 'TYxFYnhGjLA', // Baldur's Gate 3
            105600: 'gsNaR6FRuO0', // Terraria
            413150: 'WXfUPuVSeYo', // Stardew Valley
            1238810: '3sQlQn-gFRA', // Battlefield 2042
            1238060: 'X3CKNVJmUoI', // PowerWash Simulator
            1172380: '6hDIvBt_gmI', // Star Wars Jedi
            1222670: '_4Xpb2F3Rr4', // The Sims 4
            1517290: 'pOPVjsRRqaY', // Forza Horizon 5
        };
        
        // Criar elemento de √°udio global
        function initSoundtrackSystem() {
            if (!soundtrackAudio) {
                soundtrackAudio = document.createElement('audio');
                soundtrackAudio.id = 'globalSoundtrack';
                soundtrackAudio.volume = 0.3;
                soundtrackAudio.loop = true;
                document.body.appendChild(soundtrackAudio);
            }
        }
        
        // Toggle modo soundtrack (hover em game cards)
        function toggleSoundtrackMode() {
            isSoundtrackModeEnabled = !isSoundtrackModeEnabled;
            const toggle = document.getElementById('soundtrackToggle');
            
            if (isSoundtrackModeEnabled) {
                toggle.classList.add('active');
                initSoundtrackSystem();
                attachSoundtrackListeners();
            } else {
                toggle.classList.remove('active', 'playing');
                removeSoundtrackListeners();
                stopHoverSoundtrack();
            }
            
            // Salvar prefer√™ncia
            localStorage.setItem('soundtrackMode', isSoundtrackModeEnabled);
        }
        
        // Anexar listeners de hover nos game cards
        function attachSoundtrackListeners() {
            document.querySelectorAll('.game-card').forEach(card => {
                card.addEventListener('mouseenter', onGameCardHover);
                card.addEventListener('mouseleave', onGameCardLeave);
            });
        }
        
        function removeSoundtrackListeners() {
            document.querySelectorAll('.game-card').forEach(card => {
                card.removeEventListener('mouseenter', onGameCardHover);
                card.removeEventListener('mouseleave', onGameCardLeave);
            });
        }
        
        function onGameCardHover(e) {
            if (!isSoundtrackModeEnabled) return;
            
            const cardId = e.currentTarget.id;
            const appId = cardId.replace('game-', '');
            
            if (currentPlayingAppId === appId) return; // J√° est√° tocando esse
            
            playHoverSoundtrack(appId);
        }
        
        function onGameCardLeave(e) {
            // Deixar tocando at√© outro card ser hoverado ou modo desativado
        }
        
        async function playHoverSoundtrack(appId) {
            const toggle = document.getElementById('soundtrackToggle');
            const game = currentState.games?.find(g => g.appid == appId);
            
            if (!game) return;
            
            currentPlayingAppId = appId;
            toggle.classList.add('playing');
            
            // Mostrar toast com nome do jogo
            showOSTToast(game.name);
            
            // Tocar √°udio real via YouTube IFrame (oculto)
            playYouTubeAudio(game.name, appId);
        }
        
        // Sistema de YouTube Player oculto
        let ytPlayer = null;
        let ytPlayerReady = false;
        
        function loadYouTubeAPI() {
            if (window.YT) return;
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            document.head.appendChild(tag);
        }
        
        window.onYouTubeIframeAPIReady = function() {
            ytPlayerReady = true;
        };
        
        async function playYouTubeAudio(gameName, appId) {
            // Verificar se temos um ID de v√≠deo mapeado
            const youtubeId = gameSoundtracksYT[appId];
            
            if (youtubeId) {
                createOrUpdateYTPlayer(youtubeId);
            } else {
                // Buscar v√≠deo da OST automaticamente
                searchAndPlayYouTubeOST(gameName);
            }
        }
        
        function createOrUpdateYTPlayer(videoId) {
            // Criar container se n√£o existir
            let container = document.getElementById('ytPlayerContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'ytPlayerContainer';
                container.style.cssText = 'position: fixed; bottom: -1000px; left: -1000px; width: 1px; height: 1px; opacity: 0; pointer-events: none;';
                document.body.appendChild(container);
                
                const iframe = document.createElement('div');
                iframe.id = 'ytPlayer';
                container.appendChild(iframe);
            }
            
            if (window.YT && window.YT.Player) {
                if (ytPlayer && ytPlayer.loadVideoById) {
                    ytPlayer.loadVideoById(videoId);
                    ytPlayer.setVolume(30);
                } else {
                    ytPlayer = new YT.Player('ytPlayer', {
                        height: '1',
                        width: '1',
                        videoId: videoId,
                        playerVars: { autoplay: 1, controls: 0 },
                        events: {
                            onReady: (e) => { e.target.setVolume(30); e.target.playVideo(); }
                        }
                    });
                }
            }
        }
        
        async function searchAndPlayYouTubeOST(gameName) {
            // Para evitar rate limits, usar √°udio local ou placeholder
            console.log(`üéµ Searching OST for: ${gameName}`);
            // Em produ√ß√£o, voc√™ pode usar a YouTube Data API para buscar v√≠deos
        }
        
        function stopYouTubeAudio() {
            if (ytPlayer && ytPlayer.pauseVideo) {
                ytPlayer.pauseVideo();
            }
        }
        
        // Carregar API do YouTube ao iniciar
        loadYouTubeAPI();
        
        // Toast gen√©rico para substituir alerts
        function showToast(message, type = 'info', duration = 3000) {
            const existingToast = document.querySelector('.sae-toast');
            if (existingToast) existingToast.remove();
            
            const icons = { success: 'check-circle', error: 'times-circle', warning: 'exclamation-triangle', info: 'info-circle' };
            const toast = document.createElement('div');
            toast.className = `sae-toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${icons[type]}"></i> <span>${message}</span>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // Toast de OST - fica acima do painel de cache
        function showOSTToast(gameName) {
            // Remover toast existente
            const existingToast = document.querySelector('.ost-toast');
            if (existingToast) existingToast.remove();
            
            // Calcular posi√ß√£o: acima do scan-status-panel se vis√≠vel
            const scanPanel = document.getElementById('scanStatusPanel');
            const bottomPos = scanPanel && scanPanel.classList.contains('active') ? '140px' : '100px';
            
            const toast = document.createElement('div');
            toast.className = 'ost-toast';
            toast.innerHTML = `<i class="fas fa-volume-up fa-beat"></i> <span>${gameName}</span>`;
            toast.style.cssText = `
                position: fixed; bottom: ${bottomPos}; right: 20px; z-index: 9999;
                background: rgba(0,0,0,0.95); border: 1px solid var(--primary-color);
                padding: 12px 20px; border-radius: 25px; color: var(--primary-color);
                font-family: var(--font-body); font-size: 14px; display: flex;
                align-items: center; gap: 10px; animation: slideInRight 0.3s ease;
                box-shadow: 0 0 20px rgba(0,243,255,0.3);
            `;
            document.body.appendChild(toast);
            
            // Remover ap√≥s 3s
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function stopHoverSoundtrack() {
            const toggle = document.getElementById('soundtrackToggle');
            toggle.classList.remove('playing');
            currentPlayingAppId = null;
            
            // Parar YouTube player
            stopYouTubeAudio();
            
            // Parar √°udio HTML5 se existir
            if (soundtrackAudio) {
                soundtrackAudio.pause();
                soundtrackAudio.currentTime = 0;
            }
            
            // Remover toast
            const toast = document.querySelector('.ost-toast');
            if (toast) toast.remove();
        }
        
        // Restaurar prefer√™ncia de soundtrack
        function restoreSoundtrackPreference() {
            const saved = localStorage.getItem('soundtrackMode');
            if (saved === 'true') {
                setTimeout(() => toggleSoundtrackMode(), 1000);
            }
        }
        
        // Modal soundtrack - toggle play/pause
        function toggleSoundtrack() {
            const btn = document.getElementById('soundtrackBtn');
            const icon = document.getElementById('soundtrackIcon');
            
            if (isModalSoundtrackPlaying) {
                stopModalSoundtrack();
            } else {
                playModalSoundtrack();
            }
        }
        
        function playModalSoundtrack() {
            if (!currentState.currentModalGame) return;
            
            const appId = currentState.currentModalGame.appid;
            const gameName = currentState.currentModalGame.name;
            const youtubeId = gameSoundtracksYT[appId];
            
            const btn = document.getElementById('soundtrackBtn');
            const icon = document.getElementById('soundtrackIcon');
            
            btn.classList.add('playing');
            icon.className = 'fas fa-pause';
            isModalSoundtrackPlaying = true;
            
            // Mostrar toast
            showOSTToast(gameName);
            
            if (youtubeId) {
                // Tocar via YouTube IFrame
                createOrUpdateYTPlayer(youtubeId);
            } else {
                // Abrir busca do YouTube em nova aba como fallback
                window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(gameName + ' soundtrack OST')}`, '_blank');
                
                setTimeout(() => {
                    btn.classList.remove('playing');
                    icon.className = 'fas fa-music';
                    isModalSoundtrackPlaying = false;
                }, 2000);
            }
        }
        
        function stopModalSoundtrack() {
            const btn = document.getElementById('soundtrackBtn');
            const icon = document.getElementById('soundtrackIcon');
            
            // Parar YouTube
            stopYouTubeAudio();
            
            if (btn) btn.classList.remove('playing');
            if (icon) icon.className = 'fas fa-music';
            isModalSoundtrackPlaying = false;
            
            // Remover toast
            const toast = document.querySelector('.ost-toast');
            if (toast) toast.remove();
        }
        
        // Inicializar sistema de soundtrack
        document.addEventListener('DOMContentLoaded', () => {
            restoreSoundtrackPreference();
            initLanguage();
        });
        // ===== FIM SOUNDTRACK SYSTEM =====
        function filterGames() { const term = document.getElementById('gameSearchInput').value.toLowerCase(); document.querySelectorAll('.game-card').forEach(card => { const pct = parseFloat(card.dataset.percent); let show = card.dataset.name.includes(term); if (currentState.activeFilter === 'platinado' && pct < 100) show = false; if (currentState.activeFilter === 'platinando' && (pct < 70 || pct === 100)) show = false; show ? card.classList.remove('hidden-card') : card.classList.add('hidden-card'); }); }
        function setFilter(type) { currentState.activeFilter = type; document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === type)); filterGames(); }
        function sortGames() { const type = document.getElementById('sortSelect').value; if (type === 'playtime') currentState.games.sort((a,b) => b.playtime_forever - a.playtime_forever); if (type === 'completion') currentState.games.sort((a,b) => b.percent - a.percent); if (type === 'name') currentState.games.sort((a,b) => a.name.localeCompare(b.name)); renderGamesGrid(); }
        function filterFriends() { const term = document.getElementById('friendSearchInput').value.toLowerCase(); document.querySelectorAll('.friend-card').forEach(c => c.dataset.name.includes(term) ? c.classList.remove('hidden') : c.classList.add('hidden')); }
        function toggleTheme() { const b = document.body; if (!b.className) b.className = 'theme-matrix'; else if (b.className === 'theme-matrix') b.className = 'theme-fire'; else b.className = ''; }
        
        function changeTheme(theme) { 
            // Limpar apenas classes de tema (n√£o sazonais)
            document.body.classList.remove('theme-rgb', 'theme-retro', 'theme-light', 'theme-dark');
            
            // Aplicar novo tema
            if (theme !== 'default') {
                document.body.classList.add(`theme-${theme}`);
            }
            
            localStorage.setItem('selectedTheme', theme);
            
            // Re-aplicar sazonal se estiver ativo
            applySeasonalTheme();
        }
        
        function changeLanguage(lang) {
            if (typeof setLanguage === 'function') {
                setLanguage(lang);
            }
            localStorage.setItem('preferredLanguage', lang);
            document.getElementById('langSelector').value = lang;
        }
        
        function initLanguage() {
            const savedLang = localStorage.getItem('preferredLanguage') || 'pt';
            document.getElementById('langSelector').value = savedLang;
            if (typeof setLanguage === 'function') {
                setLanguage(savedLang);
            }
        }
        
        function toggleSeasonalTheme() {
            const isEnabled = localStorage.getItem('seasonalEnabled') === 'true';
            localStorage.setItem('seasonalEnabled', !isEnabled);
            applySeasonalTheme();
        }
        
        function applySeasonalTheme() {
            const isEnabled = localStorage.getItem('seasonalEnabled') === 'true';
            const btn = document.getElementById('seasonalToggleBtn');
            const icon = document.getElementById('seasonalIcon');
            
            // Remove efeitos sazonais
            document.body.classList.remove('theme-seasonal-christmas', 'theme-seasonal-halloween');
            btn.classList.remove('active', 'christmas', 'halloween');
            
            if (!isEnabled) {
                icon.className = 'fas fa-snowflake';
                return;
            }
            
            // Determinar qual tema sazonal aplicar baseado na data
            const month = new Date().getMonth(); // 0-11
            const day = new Date().getDate();
            
            // Outubro = Halloween, Dezembro = Natal, outras datas = Natal como padr√£o para teste
            if (month === 9 || (month === 10 && day <= 2)) { // Outubro at√© 2 Nov
                document.body.classList.add('theme-seasonal-halloween');
                btn.classList.add('active', 'halloween');
                icon.className = 'fas fa-ghost';
                console.log('üéÉ Tema Halloween ativado!');
            } else if (month === 11 || month === 0) { // Dezembro e Janeiro
                document.body.classList.add('theme-seasonal-christmas');
                btn.classList.add('active', 'christmas');
                icon.className = 'fas fa-snowflake';
                console.log('üéÑ Tema Natal ativado!');
            } else {
                // Fora de √©poca - permite escolher qual quer testar
                document.body.classList.add('theme-seasonal-christmas');
                btn.classList.add('active', 'christmas');
                icon.className = 'fas fa-snowflake';
                console.log('‚ùÑÔ∏è Modo sazonal ativo (Natal fora de √©poca)');
            }
        }

        function setDynamicBackground(appId) { const bg = document.getElementById('dynamic-bg'); bg.style.backgroundImage = `url('https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/${appId}/page_bg_generated_v6b.jpg')`; bg.style.opacity = '0.3'; }
        function saveToHistory(id) { 
            localStorage.setItem('lastSteamId', id); 
            localStorage.setItem('steamId', id); // Tamb√©m salvar como steamId para outras p√°ginas
        }
        function loadFromHistory() { 
            const last = localStorage.getItem('lastSteamId'); 
            if (last) document.getElementById('steamInput').value = last;
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            if (savedTheme !== 'default') document.body.classList.add(`theme-${savedTheme}`);
            document.getElementById('themeSelector').value = savedTheme;
            
            // Aplicar tema sazonal se estiver ativado
            applySeasonalTheme();
        }
        
        // ===== LAZY LOADING =====
        let lazyLoadObserver = null;
        function initLazyLoading() {
            // Se j√° tem um observer, desconectar
            if (lazyLoadObserver) lazyLoadObserver.disconnect();
            
            const options = {
                root: null, // viewport
                rootMargin: '100px', // carregar 100px antes de aparecer
                threshold: 0.01
            };
            
            lazyLoadObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.classList.add('loaded');
                            lazyLoadObserver.unobserve(img);
                        }
                    }
                });
            }, options);
            
            // Observar todas as imagens lazy
            document.querySelectorAll('img.lazy-img').forEach(img => {
                if (!img.src || img.src === '') {
                    lazyLoadObserver.observe(img);
                }
            });
            
            console.log('üì∑ Lazy loading inicializado');
        }
        
        function triggerSearch(id) { document.getElementById('steamInput').value = id; handleSearch(); window.scrollTo({top:0, behavior:'smooth'}); }
        function refreshData() { if(currentState.userId) handleSearch(true); }
        function openVersusModal() { document.getElementById('vsInput1').value = currentState.userId || ""; document.getElementById('versusModal').classList.add('open'); }
        async function runVersus() {
            const id1 = currentState.userId; const input2 = document.getElementById('vsInput2').value;
            if(!id1 || !input2) return showToast('Carregue seu perfil primeiro e digite o ID do oponente', 'warning');
            document.getElementById('versusContent').innerHTML = '<div class="loader"></div>';
            try {
                let id2 = input2; if(isNaN(input2)) { const r = await fetchFromSteam('ISteamUser/ResolveVanityURL/v0001', { vanityurl: input2 }); id2 = r.response.steamid; }
                const [p1, p2, g1, g2] = await Promise.all([fetchFromSteam('ISteamUser/GetPlayerSummaries/v0002', { steamids: id1 }), fetchFromSteam('ISteamUser/GetPlayerSummaries/v0002', { steamids: id2 }), fetchFromSteam('IPlayerService/GetOwnedGames/v0001', { steamid: id1 }), fetchFromSteam('IPlayerService/GetOwnedGames/v0001', { steamid: id2 })]);
                const user1 = p1.response.players[0]; const user2 = p2.response.players[0];
                const games1 = g1.response.game_count || 0; const games2 = g2.response.game_count || 0;
                let time1 = 0; if (g1.response.games) g1.response.games.forEach(g => time1 += g.playtime_forever); time1 = (time1 / 60).toFixed(0);
                let time2 = 0; if (g2.response.games) g2.response.games.forEach(g => time2 += g.playtime_forever); time2 = (time2 / 60).toFixed(0);
                let score1 = games1 + parseInt(time1); let score2 = games2 + parseInt(time2);
                let totalScore = score1 + score2; let p1Width = totalScore > 0 ? (score1 / totalScore) * 100 : 50;
                document.getElementById('versusContent').innerHTML = `<div class="vs-player ${count1 > count2 ? 'winner-bg' : ''}"><img src="${user1.avatarfull}" class="vs-avatar ${count1 > count2 ? 'winner' : ''}"><h3>${user1.personaname}</h3><div class="vs-stat-row"><span class="vs-stat-label">Jogos</span><span class="vs-stat-val ${count1 > count2 ? 'win' : ''}">${count1}</span></div><div class="vs-stat-row"><span class="vs-stat-label">Horas</span><span class="vs-stat-val ${parseInt(time1) > parseInt(time2) ? 'win' : ''}">${time1}h</span></div></div><div class="vs-divider">VS</div><div class="vs-player ${count2 > count1 ? 'winner-bg' : ''}"><img src="${user2.avatarfull}" class="vs-avatar ${count2 > count1 ? 'winner' : ''}"><h3>${user2.personaname}</h3><div class="vs-stat-row"><span class="vs-stat-label">Jogos</span><span class="vs-stat-val ${count2 > count1 ? 'win' : ''}">${count2}</span></div><div class="vs-stat-row"><span class="vs-stat-label">Horas</span><span class="vs-stat-val ${parseInt(time2) > parseInt(time1) ? 'win' : ''}">${time2}h</span></div></div>`;
                document.getElementById('tugContainer').style.display = 'block';
                document.getElementById('tugBarP1').style.width = `${p1Width}%`;
            } catch(e) { showToast('Erro ao comparar: ' + e.message, 'error'); }
        }

        // ==================== SERVICE WORKER REGISTRATION ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/SAE/sw.js', { scope: '/SAE/' });
                    console.log('‚úÖ Service Worker registrado:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                if (confirm('Nova vers√£o dispon√≠vel! Recarregar para atualizar?')) {
                                    newWorker.postMessage('skipWaiting');
                                    window.location.reload();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('‚ùå Erro ao registrar Service Worker:', error);
                }
            });
        }

        // ===== SHARE FUNCTIONS =====
        function toggleShareMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('shareMenu');
            menu.classList.toggle('active');
            
            // Atualizar link do perfil p√∫blico
            if (currentState.steamId) {
                document.getElementById('publicProfileLink').href = `profile.html?id=${currentState.steamId}`;
            }
            
            // Fechar ao clicar fora
            document.addEventListener('click', closeShareMenu);
        }
        
        function closeShareMenu(e) {
            const menu = document.getElementById('shareMenu');
            const btn = document.querySelector('.share-btn');
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('active');
                document.removeEventListener('click', closeShareMenu);
            }
        }
        
        function shareTwitter() {
            const username = document.getElementById('userNameText').innerText;
            const platinas = document.getElementById('totalPlatinum').innerText;
            const conquistas = document.getElementById('totalAchievements').innerText;
            const url = `${window.location.origin}/profile.html?id=${currentState.steamId}`;
            const text = `üéÆ Perfil Steam de ${username}\nüèÜ ${platinas} Platinas | ‚≠ê ${conquistas} Conquistas\n\nConfira meu perfil no Steam Explorer!`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
            document.getElementById('shareMenu').classList.remove('active');
        }
        
        function shareDiscord() {
            copyProfileLink();
            showToast('Link copiado! Cole no Discord para compartilhar', 'success');
        }
        
        function copyProfileLink() {
            const url = `${window.location.origin}/profile.html?id=${currentState.steamId}`;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copiado!', 'success');
                const copyItem = document.querySelector('.share-item.copy');
                if (copyItem) {
                    const originalText = copyItem.innerHTML;
                    copyItem.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                    setTimeout(() => { copyItem.innerHTML = originalText; }, 2000);
                }
            }).catch(() => {
                // Fallback silencioso
            });
            document.getElementById('shareMenu').classList.remove('active');
        }

        // Install prompt for PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install button after profile loads
            const installBtn = document.createElement('button');
            installBtn.id = 'pwa-install-btn';
            installBtn.className = 'btn btn-secondary';
            installBtn.innerHTML = '<i class="fas fa-download"></i> Instalar App';
            installBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: none;';
            installBtn.onclick = async () => {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('PWA install:', outcome);
                deferredPrompt = null;
                installBtn.style.display = 'none';
            };
            document.body.appendChild(installBtn);
            // Show after 5 seconds
            setTimeout(() => { if(deferredPrompt) installBtn.style.display = 'block'; }, 5000);
        });

    </script>
</body>
</html>
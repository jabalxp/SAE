<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Steam Wrapped - Seu Ano Gamer</title>
    
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="js/idb-cache.js"></script>

    <script>
        // --- FIX CRÍTICO: MATAR SERVICE WORKER ---
        // Adicionado try-catch para evitar InvalidStateError se o documento não permitir acesso ao SW
        try {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister()
                            .then(() => console.log("Service Worker desregistrado."))
                            .catch(e => console.warn("Erro ao desregistrar SW:", e));
                    }
                }).catch(e => console.warn("Falha ao obter registros de SW:", e));
            }
        } catch (e) {
            console.warn("Navegador bloqueou acesso ao ServiceWorker:", e);
        }
    </script>

    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --bg: #050b14;
            --glass: rgba(255, 255, 255, 0.1);
            --story-bg: linear-gradient(180deg, #1a0b2e 0%, #000000 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Container Principal */
        .story-container {
            width: 100%;
            height: 100%;
            max-width: 480px;
            background: var(--story-bg);
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(188, 19, 254, 0.2);
        }

        /* Barras de Progresso */
        .progress-container {
            position: absolute;
            top: 15px; left: 10px; right: 10px;
            display: flex; gap: 5px; z-index: 100;
        }
        
        .progress-bar {
            flex: 1; height: 3px; background: rgba(255,255,255,0.3);
            border-radius: 2px; overflow: hidden;
        }
        
        .progress-fill {
            height: 100%; background: #fff; width: 0%;
            transition: width 0.1s linear;
        }
        
        /* Slides */
        .slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 30px; text-align: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease; z-index: 1;
        }
        
        .slide.active { opacity: 1; pointer-events: all; z-index: 10; }

        /* Tipografia e Visuais */
        .big-text {
            font-family: 'Orbitron', sans-serif; font-size: 38px; font-weight: 900;
            line-height: 1.1; margin-bottom: 20px;
            background: linear-gradient(45deg, #fff, var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .sub-text {
            font-size: 18px; color: #ccc; margin-bottom: 20px;
            animation: fadeIn 1s ease 0.5s backwards;
        }

        .highlight-stat {
            font-size: 70px; font-weight: bold; color: var(--secondary);
            text-shadow: 0 0 20px rgba(188, 19, 254, 0.5); margin: 15px 0;
            font-family: 'Orbitron'; animation: scaleUp 0.8s ease;
        }

        /* Navegação */
        .nav-area { position: absolute; top: 50px; bottom: 120px; width: 35%; z-index: 50; }
        .nav-left { left: 0; }
        .nav-right { right: 0; }

        /* Botões */
        .action-container {
            margin-top: auto; margin-bottom: 40px; z-index: 200;
            display: flex; gap: 10px;
            position: relative;
        }
        .btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: #fff; padding: 12px 24px; border-radius: 30px;
            font-family: 'Orbitron'; font-size: 14px; cursor: pointer;
            text-decoration: none; backdrop-filter: blur(5px);
            position: relative;
            z-index: 200;
        }
        .btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-primary { background: var(--primary); color: #000; border: none; font-weight: bold; }

        /* Slide 0: User Intro */
        .user-oval {
            display: flex; align-items: center; gap: 15px;
            background: rgba(255,255,255,0.1); padding: 10px 25px 10px 10px;
            border-radius: 50px; border: 1px solid var(--glass);
            margin-top: 20px; animation: fadeIn 1s ease 0.8s backwards;
        }
        .user-oval-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
        .user-oval-name { font-family: 'Orbitron'; font-size: 18px; font-weight: bold; color: var(--primary); }

        /* Slide 2: Top Game */
        .top-game-container {
            display: flex; flex-direction: column; align-items: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.3) 100%);
            padding: 30px; border-radius: 20px; border: 1px solid var(--glass);
            width: 100%; max-width: 350px;
            animation: fadeIn 1s ease 0.5s backwards;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .top-game-cover {
            width: 180px; height: 270px; object-fit: cover; border-radius: 12px;
            box-shadow: 0 0 25px rgba(0, 243, 255, 0.3); margin-bottom: 20px;
            transform: rotate(-3deg); border: 2px solid #fff;
        }
        .top-game-title { font-family: 'Orbitron'; font-size: 24px; font-weight: bold; line-height: 1.2; margin-bottom: 10px; }

        /* Slide 3: Chart */
        .chart-container { width: 100%; height: 350px; margin: 20px 0; }

        /* Slide 4: Cronograma */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1px 1fr;
            gap: 10px; width: 100%; margin-bottom: 20px; align-items: center;
        }
        .stat-divider { width: 1px; height: 50px; background: rgba(255,255,255,0.2); }
        .stat-box { text-align: center; }
        .stat-box .label { font-size: 10px; text-transform: uppercase; color: #888; letter-spacing: 1px; margin-bottom: 5px; }
        .stat-box .value { font-family: 'Orbitron'; font-size: 24px; font-weight: bold; }

        /* Conquista Rara */
        .rarest-ach-container {
            display: flex; align-items: center; gap: 15px;
            background: linear-gradient(90deg, rgba(255,215,0,0.1), rgba(0,0,0,0));
            padding: 15px; border-radius: 10px; border-left: 4px solid #ffd700;
            width: 100%; text-align: left; position: relative; overflow: hidden;
        }
        .rarest-ach-icon { width: 64px; height: 64px; border-radius: 8px; border: 1px solid #ffd700; background: #000; object-fit: cover; }
        .rarest-ach-info { flex: 1; z-index: 2; }
        .rarest-ach-name { font-family: 'Orbitron'; font-size: 16px; font-weight: bold; color: #ffd700; margin-bottom: 4px; }
        .rarest-ach-game { font-size: 12px; color: #aaa; margin-bottom: 4px; }
        .rarest-ach-pct { font-weight: bold; color: #fff; font-size: 14px; background: rgba(255,215,0,0.2); padding: 2px 8px; border-radius: 4px; display: inline-block; }

        /* NOVO SLIDE: TOP 5 & HOURS */
        .ranking-list {
            width: 100%; text-align: left; margin-top: 20px;
        }
        .ranking-item {
            display: flex; align-items: center; gap: 15px;
            margin-bottom: 12px; padding: 10px;
            background: rgba(255,255,255,0.05); border-radius: 10px;
            animation: fadeIn 0.5s ease backwards;
        }
        .rank-num {
            font-family: 'Orbitron'; font-size: 24px; font-weight: bold; color: rgba(255,255,255,0.2); width: 30px; text-align: center;
        }
        .rank-img { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; }
        .rank-info { flex: 1; overflow: hidden; }
        .rank-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; }
        .rank-meta { font-size: 11px; color: var(--primary); }

        /* Animações */
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes scaleUp { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #loader {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #333;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Share Preview - Movido para fora da tela */
        #shareCardCanvas { position: fixed; left: -9999px; top: 0; }
        .share-img-preview {
            max-width: 100%; 
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 10px; 
            border: 2px solid #fff;
            box-shadow: 0 0 30px rgba(0,243,255,0.3);
        }

        /* ============ VERSÃO DESKTOP ============ */
        @media (min-width: 768px) {
            body {
                background: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #000 100%);
            }
            
            .story-container {
                max-width: 500px;
                height: 90vh;
                max-height: 900px;
                border-radius: 20px;
                border: 1px solid rgba(255,255,255,0.1);
                margin: 20px;
            }
            
            .progress-container {
                top: 25px;
                left: 20px;
                right: 20px;
            }
            
            .progress-bar {
                height: 4px;
            }
            
            .slide {
                padding: 50px 40px;
            }
            
            .big-text {
                font-size: 48px;
            }
            
            .sub-text {
                font-size: 20px;
            }
            
            .highlight-stat {
                font-size: 90px;
            }
            
            .user-oval {
                padding: 15px 30px 15px 15px;
            }
            
            .user-oval-avatar {
                width: 80px;
                height: 80px;
            }
            
            .user-oval-name {
                font-size: 22px;
            }
            
            .top-game-container {
                padding: 40px;
                max-width: 400px;
            }
            
            .top-game-cover {
                width: 200px;
                height: 300px;
            }
            
            .top-game-title {
                font-size: 28px;
            }
            
            .chart-container {
                height: 400px;
            }
            
            .action-container {
                gap: 15px;
                margin-bottom: 50px;
            }
            
            .btn {
                padding: 14px 28px;
                font-size: 15px;
            }
            
            .nav-area {
                top: 60px;
                cursor: pointer;
            }
            
            .nav-area:hover {
                background: rgba(255,255,255,0.02);
            }
            
            .ranking-item {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .rank-num {
                font-size: 28px;
            }
            
            .rank-img {
                width: 50px;
                height: 50px;
            }
            
            .rank-name {
                font-size: 16px;
            }
            
            .rank-meta {
                font-size: 13px;
            }
            
            .stats-grid {
                gap: 20px;
            }
            
            .stat-box .value {
                font-size: 28px;
            }
            
            .rarest-ach-container {
                padding: 20px;
            }
            
            .rarest-ach-icon {
                width: 80px;
                height: 80px;
            }
            
            .rarest-ach-name {
                font-size: 18px;
            }
            
            .share-img-preview {
                max-width: 100%;
                max-height: 70vh;
            }
            
            #slide6 {
                padding-top: 60px !important;
            }
        }

        /* Telas muito grandes */
        @media (min-width: 1200px) {
            .story-container {
                max-width: 550px;
                max-height: 950px;
            }
            
            .big-text {
                font-size: 52px;
            }
            
            .highlight-stat {
                font-size: 100px;
            }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:20px; color:#888;">Preparando sua retrospectiva...</p>
    </div>

    <div class="story-container" id="storyContainer">
        <!-- Barras de Progresso -->
        <div class="progress-container" id="progressContainer"></div>

        <!-- Áreas de Toque -->
        <div class="nav-area nav-left" onclick="prevSlide()"></div>
        <div class="nav-area nav-right" onclick="nextSlide()"></div>

        <!-- SLIDE 0: Intro -->
        <div class="slide active" id="slide0">
            <div class="sub-text" style="color:var(--primary)">STEAM WRAPPED <span id="displayYear"></span></div>
            <div class="big-text" style="margin-bottom:10px;">Olá,</div>
            <div class="user-oval">
                <img id="userAvatar" src="" class="user-oval-avatar" crossorigin="anonymous" onerror="this.src='https://placehold.co/100/00f3ff/000?text=User'">
                <span id="userName" class="user-oval-name">Gamer</span>
            </div>
            <div class="sub-text" style="margin-top:30px;">Foi um ano e tanto. Vamos ver o que você aprontou?</div>
        </div>

        <!-- SLIDE 1: Resumo Geral -->
        <div class="slide" id="slide1">
            <div class="sub-text">Neste ano, você explorou</div>
            <div class="highlight-stat" id="gamesPlayedCount">0</div>
            <div class="big-text">JOGOS</div>
            <div class="sub-text">E desbloqueou <strong style="color:var(--success)" id="totalAchsCount">0</strong> novas conquistas.</div>
        </div>

        <!-- SLIDE 2: O Viciado (Top Jogo) -->
        <div class="slide" id="slide2">
            <div class="sub-text">Mas um jogo roubou seu coração...</div>
            <div class="top-game-container">
                <img src="" id="topGameImg" class="top-game-cover" crossorigin="anonymous" onerror="this.src='https://placehold.co/200x300/222/FFF?text=Game'">
                <div class="top-game-title" id="topGameName">Nome do Jogo</div>
                <div class="sub-text" style="margin:0; font-size:14px; color:#ccc;">
                    Você conquistou <span style="color:var(--primary); font-weight:bold; font-size:18px;" id="topGameAchs">0</span> troféus nele só este ano.
                </div>
            </div>
        </div>

        <!-- SLIDE 3: Gêneros -->
        <div class="slide" id="slide3">
            <div class="big-text" style="font-size:32px;">Sua Vibe</div>
            <div class="chart-container">
                <canvas id="genreChart"></canvas>
            </div>
            <div class="sub-text" id="topGenreText">Analisando seus gostos...</div>
        </div>

        <!-- SLIDE 4: Cronograma & Joia -->
        <div class="slide" id="slide4">
            <div class="sub-text" style="margin-bottom:20px; font-family:'Orbitron'; color:var(--primary);">SEU CRONOGRAMA</div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="label">DIA DE OURO</div>
                    <div class="value" style="color:#ffd700;" id="goldenDay">--/--</div>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-box">
                    <div class="label">DIA FAVORITO</div>
                    <div class="value" style="color:#00f3ff;" id="favWeekDay">---</div>
                </div>
            </div>
            
            <div class="sub-text" style="font-size:14px; margin-bottom:30px;">
                Sua semana mais insana foi de <strong style="color:#fff;" id="peakWeekRange">-- a --</strong>.
            </div>
            
            <hr style="width:50%; border-color:rgba(255,255,255,0.1); margin:10px 0 30px 0;">
            
            <div class="sub-text" style="margin-bottom:15px; font-size:12px; letter-spacing:2px;">A JOIA DA COROA (MAIS RARA)</div>
            <div class="rarest-ach-container">
                <!-- Ícone Dourado Base64 para garantir carregamento offline/erro -->
                <img id="rarestAchIcon" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1NzYgNTEyIj48cGF0aCBmaWxsPSIjRkZENzAwIiBkPSJNNDAwIDMySDQ4QzIxLjUgMzIgMCA1My41IDAgODB2MzUuMmMwIDQ4LjMgMzIuNCA4OS41IDc4LjEgOTYuOWw2LjkgNDA5LjZjOS44IDU4LjUgNTkuOSAxMDMuNiAxMTkuNCAxMDMuNmgxNjcuMWM1OS41IDAgMTA5LjYtNDUuMSAxMTkuNC0xMDMuNmw2LjktNDA5LjZDNTEzLjQgMTIxLjUgNTQ1LjggODAuMyA1NDUuOCAzMiA1NzYgMy41IDU3NiAwIDUyNy41IDU3NiA0NzkuM3oiLz48L3N2Zz4=" class="rarest-ach-icon" crossorigin="anonymous">
                <div class="rarest-ach-info">
                    <div id="rarestAchName" class="rarest-ach-name">Conquista</div>
                    <div id="rarestAchGame" class="rarest-ach-game">Jogo</div>
                    <div id="rarestAchPct" class="rarest-ach-pct">0.1%</div>
                </div>
            </div>
        </div>

        <!-- SLIDE 5: TOP 5 & HORAS (NOVO) -->
        <div class="slide" id="slide5">
            <div class="sub-text" style="margin-bottom:10px;">TEMPO BEM GASTO</div>
            <div class="highlight-stat" style="font-size:50px; margin:5px 0;" id="estimatedHours">~0h</div>
            <div class="sub-text" style="font-size:12px; margin-bottom:20px;">(Estimado baseada na atividade)</div>

            <div class="ranking-list" id="top5List">
                <!-- Gerado via JS -->
            </div>
        </div>

        <!-- SLIDE 6: Resumo & Share -->
        <div class="slide" id="slide6" style="padding: 20px 15px; justify-content: flex-start; padding-top: 50px;">
            <div class="big-text" style="font-size:24px; margin-bottom: 10px;">ISSO É TUDO.</div>
            <div id="finalCardContainer" style="flex: 1; width: 100%; max-width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden;">
                <div style="color: #888;">Gerando card...</div>
            </div>
            <div class="action-container" style="margin-top: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
                <button class="btn" onclick="replayWrapped()" style="cursor:pointer;"><i class="fas fa-redo"></i> Replay</button>
                <button class="btn btn-primary" onclick="downloadCard()" style="cursor:pointer;"><i class="fas fa-download"></i> Salvar Card</button>
                <button class="btn" onclick="window.location.href='index.html'" style="cursor:pointer;"><i class="fas fa-home"></i> Home</button>
            </div>
        </div>

    </div>

    <!-- CARD CANVAS (OCULTO - USADO PARA PRINT) -->
    <div id="shareCardCanvas" style="width: 400px; height: 600px; background: #1a0b2e; padding: 30px; display: flex; flex-direction: column; align-items: center; text-align: center; color: #fff; font-family: 'Rajdhani'; position: relative; overflow: hidden;">
        <div style="position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at 50% 0%, #bc13fe 0%, #000 70%); opacity: 0.5;"></div>
        
        <div style="position:relative; z-index:2; width:100%; height:100%; display:flex; flex-direction:column; justify-content:space-between;">
            <div>
                <div style="font-family:'Orbitron'; font-size:24px; color: #00f3ff; margin-top:20px;">STEAM WRAPPED</div>
                <div style="font-size:18px; letter-spacing: 2px;" id="cardYear">2025</div>
            </div>
            
            <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                <img id="cardAvatar" src="" style="width:100px; height:100px; border-radius:50%; border:3px solid #00f3ff;" crossorigin="anonymous">
                <div id="cardUser" style="font-size:28px; font-weight:bold;">User</div>
                <div style="background:rgba(255,255,255,0.1); padding:5px 20px; border-radius:20px; font-size:14px; color:#ccc;">Gamer</div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; width:100%;">
                <div style="background:rgba(0,0,0,0.5); padding:15px; border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                    <div style="color:#888; font-size:10px; text-transform:uppercase;">Jogos</div>
                    <div style="font-size:24px; font-weight:bold; color:#00f3ff;" id="cardGames">0</div>
                </div>
                <div style="background:rgba(0,0,0,0.5); padding:15px; border-radius:15px; border:1px solid rgba(255,255,255,0.1);">
                    <div style="color:#888; font-size:10px; text-transform:uppercase;">Conquistas</div>
                    <div style="font-size:24px; font-weight:bold; color:#bc13fe;" id="cardAchs">0</div>
                </div>
            </div>

            <div style="text-align:left; background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; display:flex; gap:15px; align-items:center; border:1px solid rgba(255,255,255,0.1);">
                <img id="cardTopGameImg" src="" style="width:60px; height:80px; object-fit:cover; border-radius:8px;" crossorigin="anonymous">
                <div>
                    <div style="font-size:10px; color:#888; text-transform:uppercase;">Jogo do Ano</div>
                    <div style="font-weight:bold; font-size:16px; line-height:1.2; color:#fff;" id="cardTopGameName">Game</div>
                </div>
            </div>

            <div style="font-size:10px; color:#555; margin-top:10px;">Gerado por Steam Achievements Explorer</div>
        </div>
    </div>

    <script>
        const CURRENT_YEAR = new Date().getFullYear(); 
        document.querySelectorAll('#displayYear, #cardYear').forEach(el => el.innerText = CURRENT_YEAR);

        let currentSlide = 0;
        const totalSlides = 7;
        let slideInterval;
        const slideDuration = 6000;

        let wrappedData = {
            gamesPlayed: [],
            totalAchs: 0,
            topGame: null,
            genres: {},
            goldenDay: null,
            rarestAch: null,
            favWeekDay: null,
            peakWeekRange: null,
            estimatedHours: 0,
            user: {}
        };

        window.onload = async () => {
            const progContainer = document.getElementById('progressContainer');
            progContainer.innerHTML = '';
            for(let i=0; i<totalSlides; i++) {
                progContainer.innerHTML += `<div class="progress-bar" id="prog${i}"><div class="progress-fill"></div></div>`;
            }

            try {
                await loadData();
                renderData();
                document.getElementById('loader').style.display = 'none';
                startStory();
            } catch (e) {
                console.error("Erro fatal no carregamento:", e);
                
                // --- MODO DEMONSTRAÇÃO (FALLBACK) ---
                console.log("Ativando Modo Demo por falta de dados...");
                loadDemoMode();
                renderData();
                document.getElementById('loader').style.display = 'none';
                startStory();
                
                // Aviso visual discreto
                const toast = document.createElement('div');
                toast.innerHTML = '<i class="fas fa-info-circle"></i> Modo Demo (Sem dados locais)';
                toast.style.cssText = "position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#fff; padding:8px 15px; border-radius:20px; font-size:12px; z-index:9999; border:1px solid #333;";
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            }
        };

        function loadDemoMode() {
            wrappedData = {
                user: {
                    personaname: 'Gamer Visitante',
                    avatarfull: 'https://avatars.akamai.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg'
                },
                gamesPlayed: [
                    { game: { name: 'Elden Ring', header_image: 'https://cdn.akamai.steamstatic.com/steam/apps/1245620/header.jpg' }, achsCount: 42 },
                    { game: { name: 'Hades', header_image: 'https://cdn.akamai.steamstatic.com/steam/apps/1145360/header.jpg' }, achsCount: 35 },
                    { game: { name: 'Cyberpunk 2077', header_image: 'https://cdn.akamai.steamstatic.com/steam/apps/1091500/header.jpg' }, achsCount: 20 },
                    { game: { name: 'Stardew Valley', header_image: 'https://cdn.akamai.steamstatic.com/steam/apps/413150/header.jpg' }, achsCount: 15 },
                    { game: { name: 'Vampire Survivors', header_image: 'https://cdn.akamai.steamstatic.com/steam/apps/1794680/header.jpg' }, achsCount: 10 }
                ],
                totalAchs: 122,
                topGame: { 
                    game: { name: 'Elden Ring', header_image: 'https://cdn.akamai.steamstatic.com/steam/apps/1245620/header.jpg' }, 
                    achsCount: 42 
                },
                genres: { 'RPG': 15, 'Ação': 10, 'Indie': 8, 'Estratégia': 5 },
                goldenDay: '15/07',
                rarestAch: {
                    displayName: 'Elden Lord',
                    gameName: 'Elden Ring',
                    percent: 1.2,
                    icon: 'https://cdn.akamai.steamstatic.com/steamcommunity/public/images/apps/1245620/381773e5a3233ebc402947b7ecf7a7751969a469.jpg' 
                },
                favWeekDay: 'SÁBADO',
                peakWeekRange: '15/07 até 21/07',
                estimatedHours: 450
            };
        }

        // Função para converter número da semana em data
        function getDateRangeOfWeek(w, y) {
            const d = (1 + (w - 1) * 7); 
            const simple = new Date(y, 0, d);
            const dayOfWeek = simple.getDay();
            const diff = simple.getDate() - dayOfWeek + (dayOfWeek == 0 ? -6 : 1); 
            
            const start = new Date(simple.setDate(diff));
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            
            const format = date => `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth()+1).padStart(2, '0')}`;
            return `${format(start)} até ${format(end)}`;
        }

        async function loadData() {
            const user = JSON.parse(localStorage.getItem('currentProfile'));
            if(!user) throw new Error("Usuário não encontrado no LocalStorage");
            wrappedData.user = user;

            // Tentar inicializar o cache e buscar jogos
            let games = [];
            let allCachedAchievements = [];
            
            try {
                if(window.SteamCache) {
                    await SteamCache.init();
                    games = await SteamCache.getGames(user.steamid);
                    
                    // Usar getAllAchievements para buscar todas de uma vez (evita erro do índice composto)
                    if(SteamCache.getAllAchievements) {
                        allCachedAchievements = await SteamCache.getAllAchievements(user.steamid);
                    }
                }
            } catch (e) {
                console.warn("SteamCache falhou, usando localStorage de fallback", e);
            }

            // Fallback para localStorage se cache vazio
            if(games.length === 0) {
                games = JSON.parse(localStorage.getItem('currentGames') || '[]');
            }

            if(games.length === 0) throw new Error("Sem jogos encontrados.");

            const gamesWithActivity = [];
            const achievementsThisYear = [];
            const genreCounts = {};
            const activeDays = new Set();
            
            // Criar mapa de conquistas por appid para acesso rápido
            const achsByAppId = {};
            if(allCachedAchievements && allCachedAchievements.length > 0) {
                allCachedAchievements.forEach(a => {
                    const appid = parseInt(a.appid, 10);
                    if(!achsByAppId[appid]) achsByAppId[appid] = [];
                    achsByAppId[appid].push(a);
                });
            }

            for (const game of games) {
                const appid = parseInt(game.appid, 10);
                let achs = achsByAppId[appid] || [];
                
                if (achs.length > 0) {
                    const yearAchs = achs.filter(a => {
                        if(!a.unlocked || !a.unlocktime) return false;
                        const date = new Date(a.unlocktime * 1000);
                        return date.getFullYear() === CURRENT_YEAR;
                    });

                    if (yearAchs.length > 0) {
                        gamesWithActivity.push({
                            game: game,
                            achsCount: yearAchs.length
                        });
                        achievementsThisYear.push(...yearAchs);
                        identifyGenre(game.name, genreCounts);
                        yearAchs.forEach(a => {
                            const d = new Date(a.unlocktime * 1000);
                            activeDays.add(d.toDateString());
                        });
                    }
                } else if(game.unlocked > 0 || game.playtime_forever > 0) {
                    // Fallback: se não tem dados detalhados mas tem conquistas ou tempo jogado, adiciona
                    gamesWithActivity.push({
                        game: game,
                        achsCount: game.unlocked || 0
                    });
                    identifyGenre(game.name, genreCounts);
                }
            }

            // Se não encontrou atividade com dados detalhados, usar todos os jogos com conquistas
            if(gamesWithActivity.length === 0) {
                games.forEach(game => {
                    if(game.unlocked > 0 || game.playtime_forever > 60) {
                        gamesWithActivity.push({
                            game: game,
                            achsCount: game.unlocked || 0
                        });
                        identifyGenre(game.name, genreCounts);
                    }
                });
            }

            gamesWithActivity.sort((a,b) => b.achsCount - a.achsCount);

            wrappedData.gamesPlayed = gamesWithActivity;
            // Se temos conquistas detalhadas do ano, usa esse total. Senão, soma os achsCount dos jogos
            wrappedData.totalAchs = achievementsThisYear.length > 0 
                ? achievementsThisYear.length 
                : gamesWithActivity.reduce((sum, g) => sum + g.achsCount, 0);
            wrappedData.topGame = gamesWithActivity.length > 0 ? gamesWithActivity[0] : null;
            wrappedData.genres = genreCounts;
            
            // Estimativa de Horas baseada em playtime dos jogos ou dias ativos
            if(activeDays.size > 0) {
                wrappedData.estimatedHours = Math.round(activeDays.size * 2.5);
            } else {
                // Usar playtime real dos jogos jogados este ano (estimativa)
                const totalPlaytimeMinutes = gamesWithActivity.reduce((sum, g) => sum + (g.game.playtime_forever || 0), 0);
                wrappedData.estimatedHours = Math.round(totalPlaytimeMinutes / 60) || Math.round(gamesWithActivity.length * 5);
            }

            if(achievementsThisYear.length > 0) {
                const days = {};
                const weekCounts = {};
                const dayOfWeekCounts = [0,0,0,0,0,0,0];
                
                achievementsThisYear.forEach(a => {
                    const date = new Date(a.unlocktime * 1000);
                    days[`${date.getDate()}/${date.getMonth()+1}`] = (days[`${date.getDate()}/${date.getMonth()+1}`] || 0) + 1;
                    
                    const weekNum = Math.ceil(((date - new Date(date.getFullYear(),0,1)) / 86400000 + new Date(date.getFullYear(),0,1).getDay()+1)/7);
                    weekCounts[weekNum] = (weekCounts[weekNum] || 0) + 1;
                    dayOfWeekCounts[date.getDay()]++;
                });
                
                wrappedData.goldenDay = Object.keys(days).reduce((a, b) => days[a] > days[b] ? a : b);
                const peakWeekNum = Object.keys(weekCounts).reduce((a, b) => weekCounts[a] > weekCounts[b] ? a : b);
                wrappedData.peakWeekRange = getDateRangeOfWeek(peakWeekNum, CURRENT_YEAR);
                
                const dayNames = ['DOMINGO', 'SEGUNDA', 'TERÇA', 'QUARTA', 'QUINTA', 'SEXTA', 'SÁBADO'];
                wrappedData.favWeekDay = dayNames[dayOfWeekCounts.indexOf(Math.max(...dayOfWeekCounts))];

                let rarest = null;
                let minPct = 101;
                for(const a of achievementsThisYear) {
                    if(a.percent !== undefined && a.percent < minPct) {
                        minPct = a.percent;
                        rarest = a;
                    }
                }
                
                if(rarest) {
                    const g = games.find(game => game.appid === rarest.appid);
                    rarest.gameName = g ? g.name : "Jogo Desconhecido";
                    if(!rarest.icon && rarest.icongray) rarest.icon = rarest.icongray; 
                    wrappedData.rarestAch = rarest;
                }
            }
        }

        function renderData() {
            document.getElementById('userName').innerText = wrappedData.user.personaname;
            document.getElementById('userAvatar').src = wrappedData.user.avatarfull;

            document.getElementById('gamesPlayedCount').innerText = wrappedData.gamesPlayed.length;
            document.getElementById('totalAchsCount').innerText = wrappedData.totalAchs;
            
            if(wrappedData.topGame) {
                document.getElementById('topGameName').innerText = wrappedData.topGame.game.name;
                document.getElementById('topGameImg').src = wrappedData.topGame.game.header_image;
                document.getElementById('topGameAchs').innerText = wrappedData.topGame.achsCount;
            }

            renderGenreChart();

            document.getElementById('goldenDay').innerText = wrappedData.goldenDay || "N/A";
            document.getElementById('peakWeekRange').innerText = wrappedData.peakWeekRange || "--/--";
            document.getElementById('favWeekDay').innerText = wrappedData.favWeekDay || "---";
            
            if(wrappedData.rarestAch) {
                document.getElementById('rarestAchName').innerText = wrappedData.rarestAch.displayName || wrappedData.rarestAch.apiname || "Conquista Secreta";
                document.getElementById('rarestAchGame').innerText = wrappedData.rarestAch.gameName;
                if(wrappedData.rarestAch.icon && wrappedData.rarestAch.icon.startsWith('http')) {
                     document.getElementById('rarestAchIcon').src = wrappedData.rarestAch.icon;
                }
                document.getElementById('rarestAchPct').innerText = wrappedData.rarestAch.percent ? wrappedData.rarestAch.percent.toFixed(1) + "%" : "Rara";
            }

            document.getElementById('estimatedHours').innerText = `~${wrappedData.estimatedHours}h`;
            const top5 = wrappedData.gamesPlayed.slice(0, 5);
            const listEl = document.getElementById('top5List');
            top5.forEach((item, index) => {
                const delay = 0.2 + (index * 0.1);
                listEl.innerHTML += `
                    <div class="ranking-item" style="animation-delay:${delay}s">
                        <div class="rank-num">#${index+1}</div>
                        <img src="${item.game.header_image}" class="rank-img" crossorigin="anonymous" onerror="this.src='https://placehold.co/50/222/FFF?text=IMG'">
                        <div class="rank-info">
                            <div class="rank-name">${item.game.name}</div>
                            <div class="rank-meta">${item.achsCount} conquistas</div>
                        </div>
                    </div>
                `;
            });

            // Preencher dados do card oculto
            document.getElementById('cardAvatar').src = wrappedData.user.avatarfull;
            document.getElementById('cardUser').innerText = wrappedData.user.personaname;
            document.getElementById('cardGames').innerText = wrappedData.gamesPlayed.length;
            document.getElementById('cardAchs').innerText = wrappedData.totalAchs;
            if(wrappedData.topGame) {
                document.getElementById('cardTopGameName').innerText = wrappedData.topGame.game.name;
                document.getElementById('cardTopGameImg').src = wrappedData.topGame.game.header_image;
            }
            
            // Gerar card com atraso para garantir carregamento das imagens
            setTimeout(() => {
                const shareCanvas = document.getElementById('shareCardCanvas');
                html2canvas(shareCanvas, {
                    backgroundColor: null, 
                    scale: 2,
                    useCORS: true, // Importante para imagens externas
                    allowTaint: true
                }).then(canvas => {
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL("image/png");
                    img.className = "share-img-preview";
                    
                    const container = document.getElementById('finalCardContainer');
                    container.innerHTML = '';
                    container.appendChild(img);
                }).catch(err => {
                    console.error("Erro ao gerar card:", err);
                    document.getElementById('finalCardContainer').innerHTML = '<div style="color:#f55">Erro ao gerar imagem. Tente recarregar.</div>';
                });
            }, 3000); // Aumentado tempo para 3s para garantir carregamento de imagens lentas
        }

        // --- SISTEMA DE STORIES ---
        function startStory() { showSlide(0); startTimer(); }

        function startTimer() {
            clearInterval(slideInterval);
            const bar = document.querySelector(`#prog${currentSlide} .progress-fill`);
            if(bar) {
                bar.style.transition = `width ${slideDuration}ms linear`;
                setTimeout(() => bar.style.width = '100%', 10);
            }
            slideInterval = setInterval(() => { nextSlide(); }, slideDuration);
        }

        function nextSlide() {
            if(currentSlide < totalSlides - 1) {
                const bar = document.querySelector(`#prog${currentSlide} .progress-fill`);
                if(bar) { bar.style.transition = 'none'; bar.style.width = '100%'; }
                currentSlide++; showSlide(currentSlide); startTimer();
            } else { clearInterval(slideInterval); }
        }

        function prevSlide() {
            if(currentSlide > 0) {
                const currBar = document.querySelector(`#prog${currentSlide} .progress-fill`);
                if(currBar) { currBar.style.transition = 'none'; currBar.style.width = '0%'; }
                currentSlide--;
                const prevBar = document.querySelector(`#prog${currentSlide} .progress-fill`);
                if(prevBar) { prevBar.style.transition = 'none'; prevBar.style.width = '0%'; }
                showSlide(currentSlide); startTimer();
            }
        }

        function showSlide(index) {
            document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
            document.getElementById(`slide${index}`).classList.add('active');
        }

        function replayWrapped() {
            document.querySelectorAll('.progress-fill').forEach(bar => { bar.style.transition = 'none'; bar.style.width = '0%'; });
            currentSlide = 0; startStory();
        }

        function downloadCard() {
            const imgPreview = document.querySelector('#finalCardContainer img');
            if(imgPreview) {
                const link = document.createElement('a');
                link.download = `SteamWrapped_${CURRENT_YEAR}_${wrappedData.user.steamid}.png`;
                link.href = imgPreview.src;
                link.click();
            } else {
                alert("O card ainda está sendo gerado. Aguarde alguns segundos.");
            }
        }

        function identifyGenre(name, counts) {
            name = name.toLowerCase();
            const keywords = {
                'RPG': ['rpg', 'role-playing', 'souls', 'elden', 'witcher', 'final fantasy', 'skyrim', 'fallout', 'mass effect', 'persona', 'diablo', 'cyberpunk', 'baldur', 'tales of', 'dragon', 'kingdom hearts', 'xenoblade', 'divinity', 'pillars', 'torment', 'pathfinder', 'wasteland', 'outer worlds', 'starfield', 'hogwarts'],
                'Ação': ['action', 'god of war', 'assassin', 'gta', 'grand theft', 'devil may cry', 'sekiro', 'ghost', 'spider-man', 'spiderman', 'batman', 'arkham', 'tomb raider', 'uncharted', 'horizon', 'last of us', 'red dead', 'metal gear', 'resident evil', 'monster hunter', 'nioh', 'bayonetta', 'ninja', 'mortal kombat', 'street fighter', 'tekken', 'marvel', 'lego'],
                'Tiro': ['fps', 'shooter', 'call of duty', 'cod', 'battlefield', 'doom', 'counter-strike', 'cs:go', 'cs2', 'overwatch', 'apex', 'valorant', 'pubg', 'fortnite', 'destiny', 'bioshock', 'halo', 'sniper', 'borderlands', 'far cry', 'rainbow six', 'warzone', 'titanfall', 'payday', 'left 4 dead', 'back 4 blood', 'deep rock', 'hunt:', 'tarkov', 'arma', 'insurgency', 'squad', 'hell let loose', 'ready or not'],
                'Aventura': ['adventure', 'point and click', 'walking simulator', 'life is strange', 'telltale', 'detroit', 'heavy rain', 'death stranding', 'control', 'alan wake', 'firewatch', 'what remains', 'gone home', 'oxenfree', 'night in the woods', 'a plague tale', 'brothers', 'journey', 'abzu', 'flower', 'return to monkey', 'broken sword', 'disco elysium', 'kentucky route'],
                'Indie': ['indie', 'hollow knight', 'celeste', 'cuphead', 'hades', 'terraria', 'stardew', 'undertale', 'dead cells', 'ori', 'limbo', 'inside', 'spelunky', 'shovel knight', 'cave story', 'enter the gungeon', 'binding of isaac', 'slay the spire', 'vampire survivors', 'cult of the lamb', 'tunic', 'sifu', 'inscryption', 'outer wilds', 'subnautica', 'valheim', 'raft', 'the forest', 'rust', 'among us', 'fall guys', 'gang beasts', 'human fall flat', 'phasmophobia', 'lethal company', 'content warning', 'goose game', 'unpacking', 'dorfromantik', 'powerwash', 'dave the diver'],
                'Estratégia': ['strategy', 'rts', 'civilization', 'civ ', 'age of empires', 'aoe', 'total war', 'xcom', 'stellaris', 'crusader kings', 'europa universalis', 'hearts of iron', 'victoria', 'paradox', 'starcraft', 'warcraft', 'command & conquer', 'anno', 'northgard', 'frostpunk', 'tropico', 'rimworld', 'dwarf fortress', 'factorio', 'satisfactory', 'oxygen not included', 'prison architect', 'two point', 'planet coaster', 'planet zoo', 'jurassic world', 'dota', 'league of legends', 'lol'],
                'Corrida': ['racing', 'race', 'forza', 'need for speed', 'nfs', 'gran turismo', 'f1 ', 'formula', 'dirt', 'rally', 'wreckfest', 'burnout', 'crew', 'assetto', 'project cars', 'grid', 'hot wheels', 'trackmania', 'mario kart', 'rocket league', 'art of rally', 'beam.ng', 'car mechanic', 'snowrunner', 'mudrunner'],
                'Esportes': ['sport', 'fifa', 'pes', 'efootball', 'nba', 'nfl', 'madden', 'mlb', 'nhl', 'wwe', 'ufc', 'football manager', 'fm20', 'fm21', 'fm22', 'fm23', 'fm24', 'golf', 'tennis', 'skate', 'tony hawk', 'rider', 'steep'],
                'Simulação': ['simulator', 'simulation', 'sims', 'simcity', 'cities skylines', 'tycoon', 'manager', 'truck simulator', 'euro truck', 'american truck', 'flight simulator', 'msfs', 'x-plane', 'farming simulator', 'house flipper', 'thief simulator', 'pc building', 'cooking simulator', 'car mechanic', 'train sim', 'bus simulator', 'goat simulator'],
                'Terror': ['horror', 'terror', 'scary', 'resident evil', 're ', 'silent hill', 'dead by daylight', 'outlast', 'phasmophobia', 'amnesia', 'evil within', 'alien isolation', 'soma', 'little nightmares', 'layers of fear', 'visage', 'madison', 'devour', 'dead space', 'alan wake', 'until dawn', 'the quarry', 'dying light', 'zombie', 'fnaf', 'five nights']
            };
            
            let found = false;
            for(let genre in keywords) {
                if(keywords[genre].some(k => name.includes(k))) {
                    counts[genre] = (counts[genre] || 0) + 1;
                    found = true;
                    break;
                }
            }
            if(!found) counts['Outros'] = (counts['Outros'] || 0) + 1;
        }

        function renderGenreChart() {
            const ctx = document.getElementById('genreChart').getContext('2d');
            const labels = Object.keys(wrappedData.genres);
            const data = Object.values(wrappedData.genres);
            let topG = "Variado"; let max = 0;
            for(let g in wrappedData.genres) { if(wrappedData.genres[g] > max && g !== 'Outros') { max = wrappedData.genres[g]; topG = g; } }
            document.getElementById('topGenreText').innerHTML = `Seu ano foi dominado por <strong>${topG}</strong>.`;

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gêneros',
                        data: data,
                        backgroundColor: 'rgba(0, 243, 255, 0.4)',
                        borderColor: '#00f3ff',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        r: { 
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { color: '#fff', font: { family: 'Orbitron', size: 12 } },
                            ticks: { display: false, backdropColor: 'transparent' } 
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
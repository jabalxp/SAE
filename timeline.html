<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAE - Timeline & Stats</title>
    
    <!-- Fontes (Mesmas do Index) -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Cache System -->
    <script src="js/idb-cache.js"></script>

    <style>
        /* ================= Váriaveis e Reset ================= */
        :root {
            --primary-color: #00f3ff; 
            --secondary-color: #bc13fe;
            --bg-dark: #050b14;
            --bg-panel: rgba(16, 26, 46, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #e0e6ed;
            --text-dim: #94a3b8;
            --success: #00ff9d;
            --warning: #ffbd2e;
            --danger: #ff0055;
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
            --card-radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: var(--font-body); min-height: 100vh; overflow-x: hidden; }
        
        /* Background Dinâmico */
        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 50% 50%, rgba(188, 19, 254, 0.1), rgba(5, 11, 20, 1));
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 20px; }

        /* ================= Header ================= */
        .timeline-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; border-bottom: 1px solid var(--glass-border); margin-bottom: 40px;
        }
        .back-btn {
            background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color);
            padding: 8px 20px; border-radius: 20px; text-decoration: none; font-family: var(--font-display);
            font-size: 12px; transition: 0.3s; display: flex; align-items: center; gap: 10px;
        }
        .back-btn:hover { background: var(--primary-color); color: #000; box-shadow: 0 0 15px rgba(0, 243, 255, 0.4); }
        .page-title { font-family: var(--font-display); font-size: 24px; color: #fff; text-transform: uppercase; letter-spacing: 2px; }

        /* ================= Persona Card ================= */
        .persona-section { margin-bottom: 50px; display: flex; justify-content: center; }
        .persona-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(0,0,0,0.4));
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 40px; width: 100%; max-width: 900px;
            display: flex; align-items: center; gap: 40px;
            position: relative; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .persona-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        }
        
        .persona-avatar-container { position: relative; }
        .persona-avatar { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--secondary-color); object-fit: cover; box-shadow: 0 0 30px rgba(188, 19, 254, 0.4); }
        .persona-badge {
            position: absolute; bottom: 0; right: 0;
            background: var(--primary-color); color: #000;
            padding: 5px 12px; border-radius: 15px; font-weight: bold; font-family: var(--font-display); font-size: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .persona-info { flex: 1; }
        .persona-label { color: var(--text-dim); font-size: 12px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        .persona-archetype { font-family: var(--font-display); font-size: 36px; color: #fff; margin-bottom: 15px; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .persona-desc { color: var(--text-dim); font-size: 16px; line-height: 1.6; margin-bottom: 25px; border-left: 2px solid var(--glass-border); padding-left: 15px; }
        
        .persona-stats { display: flex; gap: 30px; }
        .p-stat { display: flex; flex-direction: column; }
        .p-val { font-size: 24px; font-weight: bold; color: var(--primary-color); font-family: var(--font-display); }
        .p-lbl { font-size: 11px; color: var(--text-dim); text-transform: uppercase; }

        /* ================= Grid de Gráficos ================= */
        .dashboard-grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 50px;
        }
        
        .chart-panel {
            background: var(--bg-panel); border: 1px solid var(--glass-border);
            border-radius: var(--card-radius); padding: 25px;
            position: relative; display: flex; flex-direction: column;
        }
        .panel-title { font-family: var(--font-display); color: var(--text-main); font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .panel-title i { color: var(--secondary-color); }
        
        .chart-box { position: relative; height: 350px; width: 100%; }

        /* ================= Highlights ================= */
        .highlights-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .highlight-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 20px; text-align: center;
            transition: 0.3s;
        }
        .highlight-card:hover { border-color: var(--primary-color); transform: translateY(-5px); }
        .h-icon { font-size: 24px; color: var(--primary-color); margin-bottom: 10px; }
        .h-val { font-size: 20px; font-weight: bold; color: #fff; margin-bottom: 5px; }
        .h-lbl { font-size: 12px; color: var(--text-dim); }

        /* ================= A JORNADA ================= */
        .journey-section { margin-top: 60px; position: relative; margin-bottom: 60px; }
        .section-title-center {
            text-align: center; font-family: var(--font-display); font-size: 28px;
            color: var(--success); margin-bottom: 40px; text-transform: uppercase;
            letter-spacing: 3px; position: relative;
        }
        .section-title-center::after {
            content: ''; display: block; width: 60px; height: 3px;
            background: var(--success); margin: 10px auto 0;
        }
        
        .journey-container { position: relative; max-width: 800px; margin: 0 auto; padding: 20px 0; }
        .journey-container::before {
            content: ''; position: absolute; top: 0; bottom: 0; left: 50%;
            width: 2px; background: rgba(255,255,255,0.1); transform: translateX(-50%);
        }
        
        .journey-item { position: relative; margin-bottom: 50px; width: 100%; display: flex; justify-content: center; align-items: center; }
        .journey-dot {
            position: absolute; left: 50%; transform: translateX(-50%);
            width: 16px; height: 16px; background: var(--bg-dark);
            border: 2px solid var(--primary-color); border-radius: 50%;
            z-index: 2; box-shadow: 0 0 10px var(--primary-color);
        }
        .journey-content {
            width: 45%; background: var(--bg-panel); border: 1px solid var(--glass-border);
            border-radius: 10px; padding: 15px; position: relative;
            transition: 0.3s; cursor: default;
        }
        .journey-content:hover { transform: scale(1.02); border-color: var(--primary-color); box-shadow: 0 0 20px rgba(0, 243, 255, 0.1); }
        
        .journey-item:nth-child(odd) .journey-content { margin-right: auto; text-align: right; }
        .journey-item:nth-child(even) .journey-content { margin-left: auto; text-align: left; }
        
        .journey-item:nth-child(odd) .journey-content::after {
            content: ''; position: absolute; top: 50%; right: -10px; transform: translateY(-50%);
            border-width: 10px 0 10px 10px; border-style: solid;
            border-color: transparent transparent transparent var(--glass-border);
        }
        .journey-item:nth-child(even) .journey-content::after {
            content: ''; position: absolute; top: 50%; left: -10px; transform: translateY(-50%);
            border-width: 10px 10px 10px 0; border-style: solid;
            border-color: transparent var(--glass-border) transparent transparent;
        }

        .j-date { font-size: 12px; color: var(--primary-color); font-weight: bold; margin-bottom: 5px; font-family: var(--font-display); }
        .j-title { font-size: 16px; color: #fff; font-weight: bold; margin-bottom: 5px; }
        .j-desc { font-size: 13px; color: var(--text-dim); }
        .j-icon { position: absolute; top: -15px; font-size: 24px; color: #fff; background: var(--bg-dark); padding: 5px; border-radius: 50%; border: 1px solid var(--glass-border); }
        .journey-item:nth-child(odd) .j-icon { right: 10px; }
        .journey-item:nth-child(even) .j-icon { left: 10px; }
        
        /* Tipos de Eventos da Journey */
        .j-type-plat { border-color: #ffd700 !important; }
        .j-type-plat .j-date { color: #ffd700; }
        .j-type-plat .j-icon { color: #ffd700; border-color: #ffd700; }
        
        .j-type-start { border-color: var(--success) !important; }
        .j-type-start .j-date { color: var(--success); }
        .j-type-start .j-icon { color: var(--success); border-color: var(--success); }
        
        .j-type-service { border-color: #3b82f6 !important; } /* Azul serviço */
        .j-type-service .j-date { color: #3b82f6; }
        .j-type-service .j-icon { color: #3b82f6; border-color: #3b82f6; }

        /* ================= GALERIA DE INSÍGNIAS ================= */
        .badges-section {
            margin-bottom: 80px;
        }
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            justify-content: center;
        }
        .badge-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(0,0,0,0.2));
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .badge-card:hover {
            transform: translateY(-8px) scale(1.05);
            border-color: var(--card-color, var(--primary-color));
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.05);
        }
        .badge-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            opacity: 0;
            transform: scale(0.5);
            transition: 0.5s;
        }
        .badge-card:hover::before {
            opacity: 1;
            transform: scale(1);
        }
        
        .badge-icon-wrapper {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            border: 2px solid var(--text-dim);
            font-size: 30px;
            color: var(--text-dim);
            transition: 0.3s;
            position: relative;
            z-index: 2;
        }
        
        /* Cores de Raridade para Badges */
        .badge-common { --card-color: #b0c3d9; }
        .badge-rare { --card-color: #00f3ff; }
        .badge-epic { --card-color: #bc13fe; }
        .badge-legendary { --card-color: #ffd700; }
        
        .badge-card.unlocked .badge-icon-wrapper {
            border-color: var(--card-color);
            color: var(--card-color);
            background: rgba(0,0,0,0.6);
            box-shadow: 0 0 15px var(--card-color);
        }
        
        .badge-name {
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dim);
            margin-bottom: 5px;
            transition: 0.3s;
            z-index: 2;
        }
        .badge-card.unlocked .badge-name { color: #fff; text-shadow: 0 0 5px var(--card-color); }
        
        .badge-desc {
            font-size: 11px;
            color: var(--text-dim);
            opacity: 0.7;
            z-index: 2;
        }
        .badge-card.locked { opacity: 0.5; filter: grayscale(1); }
        
        /* Loading */
        #loading {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .loader-spinner {
            width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .persona-card { flex-direction: column; text-align: center; }
            .persona-card::before { width: 100%; height: 4px; }
            .persona-desc { border-left: none; border-top: 2px solid var(--glass-border); padding-top: 15px; padding-left: 0; }
            .persona-stats { justify-content: center; }
            .journey-container::before { left: 20px; }
            .journey-item { flex-direction: column; align-items: flex-start; margin-left: 50px; width: auto; }
            .journey-dot { left: 20px; transform: translateX(-50%); }
            .journey-content { width: 100%; text-align: left !important; margin: 0 !important; }
            .journey-content::after { display: none; }
            .j-icon { display: none; }
            .badges-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        }
    </style>
</head>
<body>

    <div class="bg-overlay"></div>
    
    <div id="loading">
        <div class="loader-spinner"></div>
        <p style="color: var(--text-dim); font-size: 14px;">Analisando linhas temporais...</p>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="timeline-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <i class="fas fa-history" style="font-size:30px; color:var(--primary-color);"></i>
                <div>
                    <h1 class="page-title">Timeline Gamer</h1>
                    <span style="font-size:12px; color:var(--text-dim);">Análise temporal e estatísticas de vida</span>
                </div>
            </div>
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Voltar</a>
        </header>

        <!-- Persona / DNA -->
        <section class="persona-section" id="personaSection" style="display:none;">
            <div class="persona-card">
                <div class="persona-avatar-container">
                    <img src="" id="pAvatar" class="persona-avatar">
                    <div class="persona-badge" id="pLevel">LVL ??</div>
                </div>
                <div class="persona-info">
                    <div class="persona-label">Arquétipo de Jogador</div>
                    <div class="persona-archetype" id="pArchetype">Calculando...</div>
                    <div class="persona-desc" id="pDesc">
                        Analisando seus hábitos de jogo, gêneros favoritos e frequência de conquistas para determinar seu perfil gamer.
                    </div>
                    <div class="persona-stats">
                        <div class="p-stat">
                            <span class="p-val" id="pYearStart">----</span>
                            <span class="p-lbl">Ano de Início</span>
                        </div>
                        <div class="p-stat">
                            <span class="p-val" id="pPeakYear">----</span>
                            <span class="p-lbl">Ano de Ouro</span>
                        </div>
                        <div class="p-stat">
                            <span class="p-val" id="pTotalHours">0h</span>
                            <span class="p-lbl">Tempo de Vida</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Highlights -->
        <div class="highlights-row">
            <div class="highlight-card">
                <div class="h-icon"><i class="fas fa-trophy"></i></div>
                <div class="h-val" id="hMostPlat">----</div>
                <div class="h-lbl">Ano com mais Platinas</div>
            </div>
            <div class="highlight-card">
                <div class="h-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="h-val" id="hActiveMonth">----</div>
                <div class="h-lbl">Mês mais Ativo</div>
            </div>
            <div class="highlight-card">
                <div class="h-icon"><i class="fas fa-gamepad"></i></div>
                <div class="h-val" id="hFavGenre">----</div>
                <div class="h-lbl">Gênero Dominante</div>
            </div>
            <div class="highlight-card">
                <div class="h-icon"><i class="fas fa-clock"></i></div>
                <div class="h-val" id="hAvgPlaytime">0h</div>
                <div class="h-lbl">Média por Jogo</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="dashboard-grid">
            <div class="chart-panel">
                <div class="panel-title"><i class="fas fa-chart-line"></i> Atividade Anual (Conquistas)</div>
                <div class="chart-box">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
            <div class="chart-panel">
                <div class="panel-title"><i class="fas fa-radar"></i> Radar de Estilos</div>
                <div class="chart-box">
                    <canvas id="genreRadar"></canvas>
                </div>
            </div>
        </div>
        
        <div class="chart-panel" style="margin-bottom: 50px;">
            <div class="panel-title"><i class="fas fa-hourglass-half"></i> Estimativa de Horas por Gênero</div>
            <div class="chart-box" style="height: auto;">
                <canvas id="genreBarChart" height="80"></canvas>
            </div>
        </div>

        <!-- A JORNADA SECTION -->
        <section class="journey-section" id="journeySection">
            <div class="section-title-center">A Jornada</div>
            <div class="journey-container" id="journeyContainer">
                <!-- Gerado via JS -->
            </div>
        </section>

        <!-- BADGES SECTION -->
        <section class="badges-section" id="badgesSection">
            <div class="section-title-center" style="color:var(--primary-color);">Galeria de Insígnias</div>
            <div class="badges-grid" id="badgesContainer">
                <!-- Gerado via JS -->
            </div>
        </section>

    </div>

    <script>
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        Chart.defaults.font.family = "'Rajdhani', sans-serif";

        let userProfile = null;
        let userGames = [];
        let genres = {
            'RPG': { keywords: ['rpg', 'role-playing', 'witcher', 'final fantasy', 'souls', 'elden', 'skyrim', 'fallout', 'mass effect', 'persona', 'diablo', 'cyberpunk', 'baldur', 'tales of', 'dragons dogma'], count: 0, hours: 0 },
            'FPS/Shooter': { keywords: ['fps', 'shooter', 'call of duty', 'battlefield', 'doom', 'counter-strike', 'cs:go', 'cs2', 'overwatch', 'apex', 'valorant', 'pubg', 'destiny', 'bioshock', 'halo', 'sniper', 'borderlands', 'far cry'], count: 0, hours: 0 },
            'Action/Adventure': { keywords: ['adventure', 'action', 'assassin', 'uncharted', 'god of war', 'tomb raider', 'batman', 'spider-man', 'horizon', 'last of us', 'red dead', 'gta', 'devil may cry', 'sekiro', 'ghost of tsushima'], count: 0, hours: 0 },
            'Strategy/Sim': { keywords: ['strategy', 'simulation', 'civilization', 'age of empires', 'city', 'sims', 'tycoon', 'manager', 'total war', 'xcom', 'stellaris', 'crusader kings', 'truck simulator', 'dota', 'league'], count: 0, hours: 0 },
            'Horror': { keywords: ['horror', 'resident evil', 'silent hill', 'dead by daylight', 'outlast', 'phasmophobia', 'amnesia', 'evil within', 'alien', 'zombie', 'left 4 dead', 'dying light'], count: 0, hours: 0 },
            'Indie/Platformer': { keywords: ['indie', 'platformer', 'hollow knight', 'celeste', 'cuphead', 'hades', 'terraria', 'stardew', 'undertale', 'dead cells', 'ori', 'limbo', 'inside', 'spelunky'], count: 0, hours: 0 },
            'Sports/Racing': { keywords: ['sport', 'racing', 'fifa', 'nba', 'forza', 'need for speed', 'gran turismo', 'f1', 'dirt', 'rocket league', 'skate'], count: 0, hours: 0 }
        };

        window.onload = async () => {
            const storedProfile = localStorage.getItem('currentProfile');
            const storedGames = localStorage.getItem('currentGames');
            const storedStats = localStorage.getItem('userStats');

            if (!storedProfile || !storedGames) {
                alert("Por favor, carregue um perfil na página inicial primeiro.");
                window.location.href = 'index.html';
                return;
            }

            userProfile = JSON.parse(storedProfile);
            userGames = JSON.parse(storedGames);
            
            document.getElementById('pAvatar').src = userProfile.avatarfull;
            if(storedStats) {
                const stats = JSON.parse(storedStats);
                document.getElementById('pLevel').innerText = `LVL ${stats.level || 1}`;
            }

            try {
                await processCachedData();
            } catch (e) {
                console.error("Erro ao processar cache:", e);
                processGameDataOnly();
            }
        };

        // Função fallback quando não há dados de cache
        function processGameDataOnly() {
            let totalPlaytime = 0;
            
            // Analisar gêneros baseado apenas nos jogos
            userGames.forEach(game => {
                totalPlaytime += game.playtime_forever || 0;
                identifyGenre(game);
            });
            
            // Calcular badges básicas
            calculateBadges(totalPlaytime, 0, 0);
            
            // Finalizar análise
            finalizeAnalysis(totalPlaytime);
            
            // Mostrar mensagem sobre dados limitados
            document.getElementById('journeyContainer').innerHTML = '<div style="text-align:center; color:var(--text-dim); padding: 40px;">Escaneie seus jogos na página inicial para ver a linha do tempo completa com suas conquistas.</div>';
        }

        async function processCachedData() {
            await SteamCache.init();
            
            // Mapear dados para a Journey
            let allAchievements = [];
            let platinumEvents = []; // Array para guardar { date, gameName, appId }
            let totalPlaytime = 0;

            // 1. Analisar Gêneros
            userGames.forEach(game => {
                totalPlaytime += game.playtime_forever || 0;
                identifyGenre(game);
            });

            // 2. Buscar TODAS as conquistas do cache de uma vez (mais eficiente)
            let cachedAchievements = [];
            try {
                cachedAchievements = await SteamCache.getAllAchievements(userProfile.steamid);
            } catch (e) {
                console.warn("Erro ao buscar conquistas do cache:", e);
                cachedAchievements = [];
            }
            
            // Filtrar conquistas desbloqueadas
            if (cachedAchievements && cachedAchievements.length > 0) {
                const unlocked = cachedAchievements.filter(a => a.unlocked && a.unlocktime > 0);
                allAchievements = unlocked;
                
                // Agrupar por jogo para identificar platinas
                const gameAchMap = {};
                cachedAchievements.forEach(a => {
                    const appid = parseInt(a.appid, 10);
                    if (!gameAchMap[appid]) {
                        gameAchMap[appid] = { total: 0, unlocked: 0, achievements: [] };
                    }
                    gameAchMap[appid].total++;
                    if (a.unlocked) {
                        gameAchMap[appid].unlocked++;
                        gameAchMap[appid].achievements.push(a);
                    }
                });
                
                // Identificar platinas
                Object.entries(gameAchMap).forEach(([appid, data]) => {
                    if (data.total > 0 && data.unlocked === data.total) {
                        const userGameEntry = userGames.find(ug => parseInt(ug.appid, 10) === parseInt(appid, 10));
                        if (userGameEntry && data.achievements.length > 0) {
                            // Encontrar a data da última conquista
                            const lastAch = data.achievements.reduce((latest, current) => {
                                return (current.unlocktime > latest.unlocktime) ? current : latest;
                            }, data.achievements[0]);
                            
                            if (lastAch) {
                                platinumEvents.push({
                                    date: new Date(lastAch.unlocktime * 1000),
                                    game: userGameEntry.name,
                                    icon: 'trophy',
                                    type: 'plat'
                                });
                            }
                        }
                    }
                });
            }

            // Se não tiver conquistas no cache (usuário novo), tentar usar userGames para estimativa
            if (allAchievements.length === 0) {
                document.getElementById('loading').innerHTML = '<div style="text-align:center"><i class="fas fa-exclamation-triangle" style="font-size:30px; color:var(--warning)"></i><br><br>Dados de timeline insuficientes.<br>Escaneie seus jogos na página inicial para ver a linha do tempo completa.</div>';
                setTimeout(() => { document.getElementById('loading').style.display = 'none'; document.getElementById('personaSection').style.display = 'flex'; }, 3000);
            } else {
                analyzeTimeline(allAchievements);
                renderJourney(allAchievements, platinumEvents);
            }
            
            // 3. Gerar Insígnias
            calculateBadges(totalPlaytime, allAchievements.length, platinumEvents.length);

            finalizeAnalysis(totalPlaytime);
        }

        function calculateBadges(totalMinutes, totalAch, totalPlats) {
            const totalHours = Math.floor(totalMinutes / 60);
            const badges = [];

            // Helper para adicionar badge
            const addBadge = (id, name, desc, icon, rarity, condition) => {
                badges.push({ id, name, desc, icon, rarity, unlocked: condition });
            };

            // === GÊNEROS ===
            addBadge('fps_master', 'General de Guerra', '+100h em FPS', 'crosshairs', 'badge-rare', genres['FPS/Shooter'].hours >= 100);
            addBadge('rpg_mage', 'Arquimago', '+200h em RPGs', 'scroll', 'badge-epic', genres['RPG'].hours >= 200);
            addBadge('horror_survivor', 'Sobrevivente', '+50h em Horror', 'ghost', 'badge-rare', genres['Horror'].hours >= 50);
            addBadge('strategy_king', 'Imperador', '+150h em Estratégia', 'chess-rook', 'badge-epic', genres['Strategy/Sim'].hours >= 150);
            addBadge('indie_hipster', 'Sommelier Indie', '+50h em Indies', 'palette', 'badge-rare', genres['Indie/Platformer'].hours >= 50);

            // === QUANTIDADE DE JOGOS ===
            addBadge('hoarder_1', 'Iniciante', 'Possui 10+ jogos', 'gamepad', 'badge-common', userGames.length >= 10);
            addBadge('hoarder_2', 'Colecionador', 'Possui 50+ jogos', 'layer-group', 'badge-rare', userGames.length >= 50);
            addBadge('hoarder_3', 'Bibliotecário', 'Possui 100+ jogos', 'university', 'badge-epic', userGames.length >= 100);
            addBadge('hoarder_4', 'Museu Vivo', 'Possui 500+ jogos', 'landmark', 'badge-legendary', userGames.length >= 500);

            // === CONQUISTAS ===
            addBadge('ach_1', 'Caçador', '100+ Conquistas', 'medal', 'badge-common', totalAch >= 100);
            addBadge('ach_2', 'Lenda', '1.000+ Conquistas', 'star', 'badge-rare', totalAch >= 1000);
            addBadge('ach_3', 'Divindade', '5.000+ Conquistas', 'sun', 'badge-legendary', totalAch >= 5000);

            // === PLATINAS ===
            addBadge('plat_1', 'Platinador', '1ª Platina', 'trophy', 'badge-common', totalPlats >= 1);
            addBadge('plat_2', 'Elite 10', '10 Platinas', 'crown', 'badge-epic', totalPlats >= 10);
            addBadge('plat_3', 'Deus da Platina', '50 Platinas', 'dragon', 'badge-legendary', totalPlats >= 50);

            // === DEDICAÇÃO ===
            addBadge('time_1', 'Dedidaco', '+1.000h totais', 'clock', 'badge-rare', totalHours >= 1000);
            addBadge('time_2', 'Sem Vida', '+5.000h totais', 'skull', 'badge-legendary', totalHours >= 5000);
            
            // Monogamista (Mais de 200h em um único jogo)
            const hasOneGameObsession = userGames.some(g => (g.playtime_forever/60) > 200);
            addBadge('obsessed', 'Monogamista', '+200h num único jogo', 'ring', 'badge-epic', hasOneGameObsession);

            // === TEMPO DE CONTA ===
            // Steam Time Created (Unix Timestamp)
            if (userProfile.timecreated) {
                const years = (Date.now() / 1000 - userProfile.timecreated) / (365 * 24 * 3600);
                addBadge('vet_5', 'Veterano', 'Conta com +5 anos', 'shield-alt', 'badge-rare', years >= 5);
                addBadge('vet_10', 'Old School', 'Conta com +10 anos', 'dungeon', 'badge-legendary', years >= 10);
            }

            renderBadges(badges);
        }

        function renderBadges(badges) {
            const container = document.getElementById('badgesContainer');
            container.innerHTML = '';

            // Ordenar: Desbloqueados primeiro, depois por raridade
            badges.sort((a, b) => {
                if (a.unlocked && !b.unlocked) return -1;
                if (!a.unlocked && b.unlocked) return 1;
                // Raridade (Ordem: Legendary > Epic > Rare > Common)
                const rarityOrder = { 'badge-legendary': 4, 'badge-epic': 3, 'badge-rare': 2, 'badge-common': 1 };
                return rarityOrder[b.rarity] - rarityOrder[a.rarity];
            });

            badges.forEach(b => {
                const statusClass = b.unlocked ? 'unlocked' : 'locked';
                const html = `
                    <div class="badge-card ${b.rarity} ${statusClass}" title="${b.unlocked ? 'Desbloqueado' : 'Bloqueado'}">
                        <div class="badge-icon-wrapper">
                            <i class="fas fa-${b.icon}"></i>
                        </div>
                        <div class="badge-name">${b.name}</div>
                        <div class="badge-desc">${b.desc}</div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function renderJourney(achievements, platinums) {
            // Ordenar conquistas cronologicamente
            achievements.sort((a, b) => a.unlocktime - b.unlocktime);
            
            const journeyEvents = [];
            
            // 1. O Despertar (Primeira Conquista)
            if (achievements.length > 0) {
                const first = achievements[0];
                journeyEvents.push({
                    date: new Date(first.unlocktime * 1000),
                    title: "O Despertar",
                    desc: `Sua primeira conquista registrada: <strong>${first.name}</strong>. A jornada começou aqui.`,
                    icon: 'star',
                    type: 'start'
                });
            }

            // 2. Adicionar Platinas
            platinums.forEach(p => {
                journeyEvents.push({
                    date: p.date,
                    title: `Platina: ${p.game}`,
                    desc: `Você dominou completamente <strong>${p.game}</strong>. Um feito para poucos!`,
                    icon: 'trophy',
                    type: 'plat'
                });
            });

            // 3. Milestones de Quantidade (Ex: 1000 conquistas)
            const milestones = [500, 1000, 5000, 10000];
            milestones.forEach(m => {
                if (achievements.length >= m) {
                    const ach = achievements[m - 1]; // Índice m-1
                    journeyEvents.push({
                        date: new Date(ach.unlocktime * 1000),
                        title: `Marca de ${m.toLocaleString()} Conquistas`,
                        desc: `Sua coleção está crescendo! O marco foi atingido com <strong>${ach.name}</strong>.`,
                        icon: 'medal',
                        type: 'milestone'
                    });
                }
            });

            // 4. Anos de Serviço (Anos de Steam - 5 em 5 anos)
            if (userProfile.timecreated) {
                const createdDate = new Date(userProfile.timecreated * 1000);
                const now = new Date();
                let years = 5;
                
                while (true) {
                    const milestoneDate = new Date(createdDate);
                    milestoneDate.setFullYear(createdDate.getFullYear() + years);
                    
                    if (milestoneDate > now) break;
                    
                    journeyEvents.push({
                        date: milestoneDate,
                        title: `${years} Anos de Serviço`,
                        desc: `Parabéns! Você completou ${years} anos como membro da comunidade Steam.`,
                        icon: 'shield-alt',
                        type: 'service'
                    });
                    
                    years += 5;
                }
            }

            // 5. Ordenar tudo por data
            journeyEvents.sort((a, b) => a.date - b.date);

            // 6. Renderizar
            const container = document.getElementById('journeyContainer');
            container.innerHTML = '';

            journeyEvents.forEach(evt => {
                const dateStr = evt.date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }).toUpperCase();
                let typeClass = '';
                if(evt.type === 'plat') typeClass = 'j-type-plat';
                else if(evt.type === 'start') typeClass = 'j-type-start';
                else if(evt.type === 'service') typeClass = 'j-type-service';
                
                const html = `
                <div class="journey-item">
                    <div class="journey-dot ${typeClass}"></div>
                    <div class="journey-content ${typeClass}">
                        <div class="j-date">${dateStr}</div>
                        <div class="j-title">${evt.title}</div>
                        <div class="j-desc">${evt.desc}</div>
                        <i class="fas fa-${evt.icon} j-icon" style="${evt.type === 'plat' ? 'color:#ffd700' : ''}"></i>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
            
            // Se vazio
            if(journeyEvents.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--text-dim)">Nenhum marco importante encontrado ainda. Continue jogando!</div>';
            }
        }

        function identifyGenre(game) {
            const name = game.name.toLowerCase();
            for (const [genre, data] of Object.entries(genres)) {
                if (data.keywords.some(k => name.includes(k))) {
                    data.count++;
                    data.hours += (game.playtime_forever / 60);
                    break; 
                }
            }
        }

        function analyzeTimeline(achievements) {
            const years = {};
            const months = {}; 

            achievements.forEach(ach => {
                const date = new Date(ach.unlocktime * 1000);
                const year = date.getFullYear();
                const monthKey = `${year}-${date.getMonth()}`;
                
                if (!years[year]) years[year] = { count: 0 };
                years[year].count++;
                
                if (!months[monthKey]) months[monthKey] = 0;
                months[monthKey]++;
            });

            const sortedYears = Object.keys(years).sort();
            const yearCounts = sortedYears.map(y => years[y].count);
            
            const startYear = sortedYears.length > 0 ? sortedYears[0] : new Date().getFullYear();
            
            let peakYear = startYear;
            let maxCount = 0;
            
            sortedYears.forEach(y => {
                if(years[y].count > maxCount) {
                    maxCount = years[y].count;
                    peakYear = y;
                }
            });

            document.getElementById('pYearStart').innerText = startYear;
            document.getElementById('pPeakYear').innerText = peakYear;
            document.getElementById('hMostPlat').innerText = peakYear; 

            let maxMonthVal = 0;
            let maxMonthKey = "----";
            Object.entries(months).forEach(([key, val]) => {
                if (val > maxMonthVal) {
                    maxMonthVal = val;
                    maxMonthKey = key;
                }
            });
            
            if(maxMonthKey !== "----") {
                const parts = maxMonthKey.split('-');
                const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                document.getElementById('hActiveMonth').innerText = `${monthNames[parts[1]]}/${parts[0]}`;
            }

            renderTimelineChart(sortedYears, yearCounts);
        }

        function finalizeAnalysis(totalMinutes) {
            const totalHours = Math.floor(totalMinutes / 60);
            document.getElementById('pTotalHours').innerText = totalHours.toLocaleString() + 'h';
            
            const avgPlaytime = userGames.length > 0 ? Math.floor(totalHours / userGames.length) : 0;
            document.getElementById('hAvgPlaytime').innerText = avgPlaytime + 'h';

            let favGenre = 'Variado';
            let maxGenreHours = 0;
            
            Object.entries(genres).forEach(([key, data]) => {
                if (data.hours > maxGenreHours) {
                    maxGenreHours = data.hours;
                    favGenre = key;
                }
            });
            document.getElementById('hFavGenre').innerText = favGenre;

            definePersona(totalHours, favGenre);
            renderGenreCharts();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('personaSection').style.display = 'flex';
        }

        function definePersona(hours, favGenre) {
            let archetype = "Aventureiro Casual";
            let desc = "Você joga por diversão, sem se prender a um único estilo, aproveitando o que o mundo dos games tem a oferecer.";
            const platinums = parseInt(localStorage.getItem('totalPlatinum') || 0);
            
            if (hours > 5000) {
                archetype = "Veterano de Guerra";
                desc = "Com milhares de horas de serviço, você já viu de tudo. Sua biblioteca é um museu e sua experiência é lendária.";
            } else if (favGenre.includes('RPG') && hours > 1000) {
                archetype = "Mestre da Lore";
                desc = "Você não apenas joga, você vive nos mundos. Cada NPC, cada sidequest e cada linha de diálogo importa para você.";
            } else if (favGenre.includes('FPS') && hours > 1000) {
                archetype = "Atleta Tático";
                desc = "Reflexos rápidos, precisão cirúrgica. Para você, o jogo só começa quando o ranking competitivo abre.";
            } else if (favGenre.includes('Strategy') && hours > 500) {
                archetype = "Grande Estrategista";
                desc = "Enquanto outros correm e atiram, você planeja. Impérios foram construídos e destruídos sob seu comando.";
            } else if (favGenre.includes('Indie')) {
                archetype = "Curador Artístico";
                desc = "Você valoriza a alma dos jogos. Gráficos ultra-realistas não te impressionam tanto quanto uma mecânica inovadora ou uma boa história.";
            } else if (platinums > 10) {
                archetype = "O Complecionista";
                desc = "Não basta zerar, tem que dominar. 100% é a única porcentagem aceitável no seu perfil.";
            }

            document.getElementById('pArchetype').innerText = archetype;
            document.getElementById('pDesc').innerText = desc;
        }

        function renderTimelineChart(labels, data) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 243, 255, 0.4)');
            gradient.addColorStop(1, 'rgba(0, 243, 255, 0.0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conquistas',
                        data: data,
                        borderColor: '#00f3ff',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#050b14',
                        pointBorderColor: '#00f3ff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderGenreCharts() {
            const labels = Object.keys(genres);
            const hoursData = labels.map(k => genres[k].hours);
            const countData = labels.map(k => genres[k].count);

            const ctxRadar = document.getElementById('genreRadar').getContext('2d');
            new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jogos na Biblioteca',
                        data: countData,
                        backgroundColor: 'rgba(188, 19, 254, 0.3)',
                        borderColor: '#bc13fe',
                        pointBackgroundColor: '#bc13fe',
                        pointBorderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            pointLabels: { color: '#e0e6ed', font: { size: 10, family: "'Orbitron', sans-serif" } },
                            ticks: { display: false, backdropColor: 'transparent' }
                        }
                    }
                }
            });

            const ctxBar = document.getElementById('genreBarChart').getContext('2d');
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Horas Jogadas',
                        data: hoursData,
                        backgroundColor: ['#00f3ff', '#bc13fe', '#00ff9d', '#ffbd2e', '#ff0055', '#ffffff', '#555555'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { callback: function(value) { return value + 'h'; } } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
    </script>
</body>
</html>